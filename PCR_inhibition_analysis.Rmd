---
title: "Inhibited PCR results analysis"
author: "G. Roux"
date: "7 janvier 2017"
output:
  html_document:
    df_print: paged
  word_document: default
highlight: pygments
---

```{r setup_tg, include=FALSE}
rm(list=ls())
library(tidyr)
library(mosaic)
library(tibble)
library(lubridate)
library(stringr)
library(eulerr)
library(plotrix)
library(rmarkdown)
library(knitr)
library(beepr)

set.seed(123456)

#Loading dataset of Toxoplasma PCR
inhtox<-read.csv(file="E:/inhib/data R/ToxoLC_R.csv",sep=";",header=T,dec=".")


#Cleaning and tidying the dataset of Toxoplasma PCR
#E11 result for 160705 corresponded to false calcul of Cp owing to background noise
#F2 result for 160711 corresponded to false calcul of Cp of the inhibition control (flat curve)
#A7 result for 160711 corresponded to false calcul of Cp owing to background noise
#C8 result for 160629 corresponded to false calcul of Cp owing to background noise

inhtox %>%
  mutate(a=ifelse(Experiment.Name %in% c("160926CONTROLKIT","160926 CONTROL KIT"),1,0),
         b=ifelse(Analysis.Name=="Abs Quant/2nd Derivative Max for New Subset 1 (1)" 
                  & Experiment.Name %in% c(160317,160627),1,0),
         c=ifelse(Analysis.Name=="Abs Quant/2nd Derivative Max for New Subset 1"
                  & Experiment.Name==160616,1,0),
         d=ifelse(Analysis.Name=="Abs Quant/2nd Derivative Max for New Subset 1"
                  & Experiment.Name==160610,1,0),
         e=ifelse(SampleName %in% c(0,"0 ALBU"),1,0),
         f=ifelse(str_detect(SampleName,"(EVA)")==T,1,0)) %>%
  filter(a==0,b==0,c==0,d==0,e==0,f==0) %>%
  transform(CrossingPoint=ifelse(Experiment.Name=="160705" &
                                   Position=="E11",55,CrossingPoint)) %>%
  transform(CrossingPoint=ifelse(Experiment.Name=="160711" &
                                   Position=="F2",55,CrossingPoint)) %>%
  transform(CrossingPoint=ifelse(Experiment.Name=="160711" &
                                   Position=="A7",55,CrossingPoint)) %>%  
  transform(CrossingPoint=ifelse(Experiment.Name=="160629" &
                                   Position=="C8",55,CrossingPoint)) %>%
  dplyr::select(1,2,4:9,12) %>%
  mutate(PlateName=paste(Experiment.Name,Analysis.Name,sep="_")) %>%
  transform(SampleName=SampleName %>%
              str_replace_all("(174 8/10)","2911748") %>%
              str_replace_all("(174[.]8)","2911748") %>%
              str_replace_all("(190 3bis)","2021903") %>%
              str_replace_all("(190 3bis TI)","2021903 TI") %>%
              str_replace_all("(190 3bis ALBU)","2021903 ALBU")) %>%
  mutate(SampleName_m=SampleName %>%
           str_replace_all("(ALBU)" ,"") %>%
           str_replace_all("(TI)" ,"") %>%
           str_replace_all("(1/10)" ,"") %>%
           str_replace_all("[.]" ,"K") %>%
           str_replace_all("(K1)","") %>%
           str_replace_all(" ","")) %>%
  mutate(Position_m=str_sub(Position,2,-1)) %>%
  transform(SampleName_m=ifelse(Position %in% c("E11","E12"),"plate_control",readr::parse_number(SampleName_m))) %>%
  mutate(Expe_Analysis_Name=paste(Experiment.Name,
                                  SampleName,Analysis.Name,sep="_"),
         Expe_Analysis_Name_m=paste(Experiment.Name,
                                    SampleName_m,Position_m,Analysis.Name,sep="_")) %>%
  filter(Expe_Analysis_Name!="160901_2 423 686_Abs Quant/2nd Derivative Max for New Subset 1") %>%
  mutate(g=ifelse(Experiment.Name=="160630" & SampleName_m=="1752955",1,0),
         h=ifelse(Experiment.Name=="160901" & Position %in% c("A1","B1","C1","F1","G1","H1"),1,0),
         i=ifelse(SampleName_m %in% c("1313499","1313508","1313514","1313520",
         "1313532","3083381","1653933"),1,0)) %>%
  filter(g==0 & h==0 & i==0) %>%
  select(1:11,13,14)->inhtox2
#The message "Warning: 206 parsing failures." has no impact on data cleaning because it only concerned rows of text substituted by "plate_control"
#The last filter function remove a triplicate result of poor interest making cleaning and tidying complicated

#joining A and B wells
inhtox2 %>%
  dplyr::filter(str_detect(Position,"A")) %>%
  rename(Position_A=Position,
         CrossingPoint_A=CrossingPoint,
         Concentration_A=Concentration,
         Standard_A=Standard,
         StatusCodes_A=StatusCodes,
         CpUncertain_A=CpUncertain) -> tA
inhtox2 %>%
  dplyr::filter(str_detect(Position,"B")) %>%
  rename(Position_B=Position,
         CrossingPoint_B=CrossingPoint,
         Concentration_B=Concentration,
         Standard_B=Standard,
         StatusCodes_B=StatusCodes,
         CpUncertain_B=CpUncertain) %>%
  select(3,5:10,12,13)-> tB
full_join(tA,tB,by=c("PlateName","Expe_Analysis_Name","Expe_Analysis_Name_m") )-> inhtox3
#Adding C wells to previous groups
inhtox2 %>%
  dplyr::filter(str_detect(Position,"C")) %>%
  rename(Position_C=Position,
         CrossingPoint_C=CrossingPoint,
         Concentration_C=Concentration,
         Standard_C=Standard,
         StatusCodes_C=StatusCodes,
         CpUncertain_C=CpUncertain) %>%
  select(3,5:10,12,13)-> tC
full_join(inhtox3,tC,by=c("PlateName","Expe_Analysis_Name","Expe_Analysis_Name_m")) -> inhtox3
#Adding F wells (inhibition control 1) to previous groups
inhtox2 %>%
  dplyr::filter(str_detect(Position,"F")) %>%
  rename(Position_F=Position,
         CrossingPoint_F=CrossingPoint,
         Concentration_F=Concentration,
         Standard_F=Standard,
         StatusCodes_F=StatusCodes,
         CpUncertain_F=CpUncertain) %>%
  select(3,5:10,12,13)-> tF
full_join(inhtox3,tF,by=c("PlateName","Expe_Analysis_Name_m")) -> inhtox3
#Adding G wells (inhibition control 2) to previous groups
inhtox2 %>%
  dplyr::filter(str_detect(Position,"G")) %>%
  rename(Position_G=Position,
         CrossingPoint_G=CrossingPoint,
         Concentration_G=Concentration,
         Standard_G=Standard,
         StatusCodes_G=StatusCodes,
         CpUncertain_G=CpUncertain) %>%
  select(3,5:10,12,13)-> tG
full_join(inhtox3,tG,by=c("PlateName","Expe_Analysis_Name_m")) -> inhtox3
#Adding H wells (albumin) to previous groups
inhtox2 %>%
  dplyr::filter(str_detect(Position,"H")) %>%
  rename(Position_H=Position,
         CrossingPoint_H=CrossingPoint,
         Concentration_H=Concentration,
         Standard_H=Standard,
         StatusCodes_H=StatusCodes,
         CpUncertain_H=CpUncertain) %>%
  select(3,5:10,12,13)-> tH
full_join(inhtox3,tH,by=c("PlateName","Expe_Analysis_Name_m")) -> inhtox3
#Add for each row corresponding to a sample
#the positive (PC) and negative plate controls (NC)
inhtox2 %>%
  dplyr::filter(str_detect(Position,"E12")) %>%
  rename(Position_PC=Position,
         CrossingPoint_PC=CrossingPoint,
         Concentration_PC=Concentration,
         Standard_PC=Standard,
         StatusCodes_PC=StatusCodes,
         CpUncertain_PC=CpUncertain,
         SampleName_PC=SampleName) %>%
  select(3,4:10,12,13)-> tPC
full_join(inhtox3,tPC,by="PlateName") -> inhtox3
inhtox2 %>%
  dplyr::filter(str_detect(Position,"E11")) %>%
  rename(Position_NC=Position,
         CrossingPoint_NC=CrossingPoint,
         Concentration_NC=Concentration,
         Standard_NC=Standard,
         StatusCodes_NC=StatusCodes,
         CpUncertain_NC=CpUncertain) %>%
  select(3,5:10,12,13)-> tNC
full_join(inhtox3,tNC,by="PlateName") %>%
  select(1,2,10,11,4,12,13,3,5:9,14:31,33:38,40:45,48,47,49:53,56:61) %>%
  rename(Expe_Analysis_Name=Expe_Analysis_Name.x, Expe_Analysis_Name_m=Expe_Analysis_Name_m.x) ->inhtox3

#Tidying to obtain one row of results per sample
inhtox3 %>% mutate(fusion=paste(Experiment.Name,SampleName_m,sep="_")) %>%
  filter(duplicated(fusion)) %>% select(-fusion)-> dsd
inhtox3 %>% arrange(Experiment.Name) %>% filter(duplicated(SampleName_m))-> ad
inhtox3 %>% arrange(Experiment.Name) %>% filter(!duplicated(SampleName_m))-> nd
dplyr::setdiff(ad,dsd)-> ddd
dplyr::union(nd,dsd) %>% full_join(ddd,by="SampleName_m")-> inhtox4


#Loading dataset of bioclinical informations for PCR T gondii results
dxtox<-read.csv(file="E:/inhib/data R/ToxoDxLab_R.csv",sep=";",header=T,dec=".")

#Cleaning, tidying the dataset of bioclinical informations for PCR T gondii results
#and creating a column "SampleName_m" for fusion with dataset of Toxoplasma PCR
dxtox %>% unite(Date_creation,Date_creation,Heure_creation,sep=" ") %>%
  transform(DOB=dmy(DOB),
            Date_creation=dmy_hms(Date_creation),
            Date_sampling=dmy_hm(Date_sampling)) %>%
  mutate(SampleName_m=str_sub(Num_travail,5,-1)) %>%
  transform(SampleName_m=readr::parse_number(SampleName_m)) %>%
  transform(SampleName_m=as.character(SampleName_m))-> dxtox

#Joining the datasets and removing sporadic misapparing
#If we perform full_join, PCR saved in DXLab but not performed owing to "non conformités" are included "toxo" dataset
dplyr::left_join(inhtox4,dxtox,by="SampleName_m") %>%
  mutate(fusion=paste(SampleName.x,Matrix,sep="_")) %>%
  filter(fusion!="349 3365LA_Placenta" & fusion!="3 493 365_Liquide amniotique") %>%
  filter(!is.na(Matrix) & !is.na(Info_patient)) %>%
  select(-fusion)-> toxo

#Changing na values of Cp by 55 for negative results and not missing results
k<-c("CrossingPoint_A.x","CrossingPoint_B.x",
     "CrossingPoint_C.x","CrossingPoint_F.x",
     "CrossingPoint_G.x","CrossingPoint_H.x",
     "CrossingPoint_PC.x","CrossingPoint_NC.x",
     "CrossingPoint_A.y","CrossingPoint_B.y",
     "CrossingPoint_C.y","CrossingPoint_F.y",
     "CrossingPoint_G.y","CrossingPoint_H.y",
     "CrossingPoint_PC.y","CrossingPoint_NC.y")

l<- c("Position_A.x",
      "Position_B.x",
      "Position_C.x",
      "Position_F.x",
      "Position_G.x",
      "Position_H.x",
      "Position_PC.x",
      "Position_NC.x",
      "Position_A.y",
      "Position_B.y",
      "Position_C.y",
      "Position_F.y",
      "Position_G.y",
      "Position_H.y",
      "Position_PC.y",
      "Position_NC.y")

toxo[k][is.na(toxo[k])& !is.na(toxo[l])] <- 55

#Loading full blood counts
fbctox<-read.csv(file="E:/inhib/data R/toxo_FBC_DxLab_R.csv",sep=";",header=T,dec=".")

#Creating a column for merging dataframes
fbctox %>%
  transform(DOB=dmy(DOB),
            Date_sampling=dmy_hm(Date_sampling)) %>%
  mutate(ID=paste(IEP,Date_sampling,sep="_")) %>%
  transform(ID=str_sub(ID,1,21),
            WBC=as.numeric(as.character(WBC))) %>%
  distinct(ID,.keep_all=T)-> fbctox2

#Selecting blood samples
toxo %>%
  mutate(ID=paste(IEP,Date_sampling,sep="_")) %>%
    transform(ID=str_sub(ID,1,21)) %>%
  filter(Matrix=="Sang veineux" & Info_patient=="N/A")-> bs

#Merging dataframes
left_join(bs,fbctox2,by="ID")%>%
  filter(!is.na(WBC)) %>%
  transform(WBC=as.numeric(WBC)) %>%
  mutate('Inhibition control results'=ifelse(CrossingPoint_F.x>38 &
                                               CrossingPoint_G.x>38,
                                             "inhibited","not inhibited"))-> toxo2

knitr::opts_chunk$set(echo = F)
```


#PCR *Toxoplasma gondii*


##Database cleaning and tidying

The aims of this part are

* to clean the database from inconsistent,inaccurate or useless data
* to tidy the database to permit analysis
* to join LightCycler and DxLab databases

\
  

###Cleaning

####Columns cleaning needs

In the column "Experiment.Name":

* a: Withdraw results rows of 160926CONTROLKIT (not samples, but kit checking)

* 160115bis: nothing to withdraw because two PCR runs the same day

* 160119bis: 160119 PCR run did not exist, thus no redundancy

* 160122bis: nothing to withdraw because two PCR runs the same day

* 160307 ter: nothing to withdraw because two PCR runs the same day and no  "bis" samples

* 160325B: 160325 PCR run did not exist, thus no redundancy

* 160428-b: 160428 PCR run did not exist, thus no redundancy

* 160729B: 160729 PCR run did not exist, thus no redundancy

* 160804b: 160804 PCR run did not exist, thus no redundancy

\
In the column "Analysis.Name":

* b: Redundancies named "...subset1 (1)"  of analysis names 160317 and 160627 were withdrawn because they were incomplete and inconsistent (PCR results analysis probably repeated for a demonstration to a student)

* c: Redundancies named "...subset1 (1)"  of analysis name 160616 were kept in place to "...subset1" because analysis of others contained mistakes

* d: Redundancies named "...subset2" of analysis name 160610 were kept in place to "...subset1" because they contained plate negative and positive controls

\
In the column "SampleName":

* e: Removing rows corresponding to results of empty wells

* f: Removing rows corresponding to an extra test

* After checking in the lab, the results for SampleName "174.8", "174 8/10 TI", and "174 8/10 ALBU" corresponded actually to "2911748", "2911748 TI" and "2911748 ALBU" respectively

* After checking in the lab, the results for SampleName "190 3bis", "190 3bis TI", and "190 3bis ALBU" corresponded actually to "2021903", "2021903 TI" and "2021903 ALBU" respectively

\
In the column "CrossingPoint", Some Cp were manually changed to the value 55 corresponding to a negative Cp

* E11 result for 160705 corresponded to false calcul of Cp owing to background noise

* F2 result for 160711 corresponded to false calcul of Cp of the inhibition control (flat curve)

* A7 result for 160711 corresponded to false calcul of Cp owing to background noise

* C8 result for 160629 corresponded to false calcul of Cp owing to background noise

\
In the column CrossingPoint_H, unusual Cp values (Cp < 20) were checked by visual evaluation of amplification curve and did not show any anomaly on LC-480 software for the samples below:

* Sample 1752955 from Experiment.Name 160627

* Sample 2560683 from Experiment.Name 160913

* Sample 621711 from Experiment.Name 160307

* Sample 830627 from Experiment.Name 160324

\
  There were positive control wells with a negative or NA CrossingPoint for Experiment.Name 160202,160721 and 160907. After checking, these were stochastic missings of positive control DNA extract and we could validate each run by comparison of mean of Cp values of inhibition controls (in F and G wells) of negative clinical samples to the previous other positive control Cp values after deducted 1.3. Consequently we could keep these 3 PCR runs for data analysis.

\
  Samples of the SampleName 1313499, 1313508, 1313514, 1313520, 1313532 and 3083381 had to be withdrawn because they corresponded to DNA extracts of amniotic fluids sent by other laboratories for expertise.

g: The control of the sample 1752955 with the SampleName "175 2955 bis" corresponded to an assay of extraction on plasma and not a control for potential inhibitors, and had to be removed.

h: Results of SampleName 2423686 from ExperimentName 160901 in the first column of the PCR plate had to be withdrawn because they corresponded to extra undiluted control for an inhibited sample

i: Results of the following SampleName had to be withdrawn because they did not actually correspond to clinical samples but to external quality assessment (1653933) or to DNA extracts of AF samples for external expertises (1313499, 1313508, 1313514, 1313520, 1313532, 3083381).

\
  

####Summary of data cleanings

Parameters from "a" to "f" represent data excluded from the database for reasons explained below.

```{r clean_methodo_tg}
#Summarising cleaning methodology
inhtox %>%
  mutate(SampleName_m=SampleName %>%
           str_replace_all("(ALBU)" ,"") %>%
           str_replace_all("(TI)" ,"") %>%
           str_replace_all("(1/10)" ,"") %>%
           str_replace_all("[.]" ,"K") %>%
           str_replace_all("(K1)","") %>%
           str_replace_all(" ","")) %>%
  mutate(a=ifelse(Experiment.Name %in% c("160926CONTROLKIT","160926 CONTROL KIT"),1,0),
         b=ifelse(Analysis.Name=="Abs Quant/2nd Derivative Max for New Subset 1 (1)" 
                  & Experiment.Name %in% c(160317,160627),1,0),
         c=ifelse(Analysis.Name=="Abs Quant/2nd Derivative Max for New Subset 1"
                  & Experiment.Name==160616,1,0),
         d=ifelse(Analysis.Name=="Abs Quant/2nd Derivative Max for New Subset 1"
                  & Experiment.Name==160610,1,0),
         e=ifelse(SampleName %in% c(0,"0 ALBU"),1,0),
         f=ifelse(str_detect(SampleName,"(EVA)")==T,1,0),
         g=ifelse(Experiment.Name=="160630" & SampleName_m=="1752955",1,0),
         h=ifelse(Experiment.Name=="160901" & Position %in% c("A1","B1","C1","F1","G1","H1"),1,0),
         i=ifelse(SampleName_m %in% c("1313499","1313508","1313514","1313520",
         "1313532","3083381","1653933"),1,0))%>%
  mutate(extra=ifelse(a+b+c+d+e+f>1,1,0)) %>%
  dplyr::summarise(`Total before cleaning`=n(),
                   `n(a)`=sum(a),
                   `n(b)`=sum(b),
                   `n(c)`=sum(c),
                   `n(d)`=sum(d),
                   `n(e)`=sum(e),
                   `n(f)`=sum(f),
                   `n(g)`=sum(g),
                   `n(h)`=sum(h),
                   `n(i)`=sum(i),
                   redundant=sum(extra)) %>% kable(digits=1)
         
cat("a: Withdraw results rows of '160926CONTROLKIT' (not samples, but kit checking)")
cat("b: Redundancies named '...subset1 (1)'  of analysis names 160317 and 160627 were withdrawn because they were uncomplete and inconsistent (PCR results analysis probably repeated for a demonstration to a student)")
cat("c: Redundancies named '...subset1 (1)'  of analysis name 160616 were kept in place to '...subset1' because analysis of others contained mistakes")
cat("d: Redundancies named '...subset2' of analysis name 160610 were kept in place to '...subset1' because they contained plate negative and positive controls") 
cat("e: Removing rows corresponding to results of empty wells")
cat("f: Removing rows corresponding to an extra test")
cat("g: Removing rows corresponding to an assay of extraction on plasma ")
cat("h: Removing rows corresponding to extra undiluted control for an inhibited sample")
cat("i: Removing rows corresponding to external quality controls or external expertises")
```

\
  

###Tidying and joining
  
```{r tidying_tg}
#Grouping per sample, triplicate PCR results, inhibition double control and albumin control.
#Grouping A and B wells
inhtox2 %>%
  dplyr::filter(str_detect(Position,"A")) %>%
  rename(Position_A=Position,
         CrossingPoint_A=CrossingPoint,
         Concentration_A=Concentration,
         Standard_A=Standard,
         StatusCodes_A=StatusCodes,
         CpUncertain_A=CpUncertain) -> tA
inhtox2 %>%
  dplyr::filter(str_detect(Position,"B")) %>%
  rename(Position_B=Position,
         CrossingPoint_B=CrossingPoint,
         Concentration_B=Concentration,
         Standard_B=Standard,
         StatusCodes_B=StatusCodes,
         CpUncertain_B=CpUncertain) %>%
  select(3,5:10,12,13)-> tB
full_join(tA,tB,by=c("PlateName","Expe_Analysis_Name","Expe_Analysis_Name_m") )-> inhtox3
cat("Control of well position inconsistencies between A and B")
inhtox3 %>%
  transform(Position_A=str_sub(Position_A,2,-1),
            Position_B=str_sub(Position_B,2,-1)) %>%
  transform(Position_A=as.numeric(Position_A),
            Position_B=as.numeric(Position_B)) %>%
  mutate(`Delta between A and B`=Position_A-Position_B) %>%
  group_by(`Delta between A and B`) %>%
  dplyr::summarise(numbers=n()) %>% kable()

#Adding C wells to previous groups
inhtox2 %>%
  dplyr::filter(str_detect(Position,"C")) %>%
  rename(Position_C=Position,
         CrossingPoint_C=CrossingPoint,
         Concentration_C=Concentration,
         Standard_C=Standard,
         StatusCodes_C=StatusCodes,
         CpUncertain_C=CpUncertain) %>%
  select(3,5:10,12,13)-> tC
full_join(inhtox3,tC,by=c("PlateName","Expe_Analysis_Name","Expe_Analysis_Name_m")) -> inhtox3
cat("Control of well position inconsistencies between A and C")
inhtox3 %>%
  transform(Position_A=str_sub(Position_A,2,-1),
            Position_C=str_sub(Position_C,2,-1)) %>%
  transform(Position_A=as.numeric(Position_A),
            Position_C=as.numeric(Position_C)) %>%
  mutate(`Delta between A and C`=Position_A-Position_C) %>% 
  group_by(`Delta between A and C`) %>%
  dplyr::summarise(numbers=n()) %>% kable()

#Adding F wells (inhibition control 1) to previous groups
inhtox2 %>%
  dplyr::filter(str_detect(Position,"F")) %>%
  rename(Position_F=Position,
         CrossingPoint_F=CrossingPoint,
         Concentration_F=Concentration,
         Standard_F=Standard,
         StatusCodes_F=StatusCodes,
         CpUncertain_F=CpUncertain) %>%
  select(3,5:10,12,13)-> tF
full_join(inhtox3,tF,by=c("PlateName","Expe_Analysis_Name_m")) -> inhtox3
cat("Control of well position inconsistencies between A and F")
inhtox3 %>%
  transform(Position_A=str_sub(Position_A,2,-1),
            Position_F=str_sub(Position_F,2,-1)) %>%
  transform(Position_A=as.numeric(Position_A),
            Position_F=as.numeric(Position_F)) %>%
  mutate(`Delta between A and F`=Position_A-Position_F) %>%
  group_by(`Delta between A and F`) %>%
  dplyr::summarise(numbers=n()) %>% kable()

#Adding G wells (inhibition control 2) to previous groups
inhtox2 %>%
  dplyr::filter(str_detect(Position,"G")) %>%
  rename(Position_G=Position,
         CrossingPoint_G=CrossingPoint,
         Concentration_G=Concentration,
         Standard_G=Standard,
         StatusCodes_G=StatusCodes,
         CpUncertain_G=CpUncertain) %>%
  select(3,5:10,12,13)-> tG
full_join(inhtox3,tG,by=c("PlateName","Expe_Analysis_Name_m")) -> inhtox3
cat("Control of well position inconsistencies between A and G")
inhtox3 %>%
  transform(Position_A=str_sub(Position_A,2,-1),
            Position_G=str_sub(Position_G,2,-1)) %>%
  transform(Position_A=as.numeric(Position_A),
            Position_G=as.numeric(Position_G)) %>%
  mutate(`Delta between A and G`=Position_A-Position_G) %>% 
  group_by(`Delta between A and G`) %>%
  dplyr::summarise(numbers=n()) %>% kable()

#Adding H wells (albumin) to previous groups
inhtox2 %>%
  dplyr::filter(str_detect(Position,"H")) %>%
  rename(Position_H=Position,
         CrossingPoint_H=CrossingPoint,
         Concentration_H=Concentration,
         Standard_H=Standard,
         StatusCodes_H=StatusCodes,
         CpUncertain_H=CpUncertain) %>%
  select(3,5:10,12,13)-> tH
full_join(inhtox3,tH,by=c("PlateName","Expe_Analysis_Name_m")) -> inhtox3
cat("Control of well position inconsistencies between A and H")
inhtox3 %>%
  transform(Position_A=str_sub(Position_A,2,-1),
            Position_H=str_sub(Position_H,2,-1)) %>%
  transform(Position_A=as.numeric(Position_A),
            Position_H=as.numeric(Position_H)) %>%
  mutate(`Delta between A and H`=Position_A-Position_H) %>% 
  group_by(`Delta between A and H`) %>%
  dplyr::summarise(numbers=n()) %>% kable()
cat("*Nul value of delta was expected (sample in the same column number of the PCR plate)")
cat(" ")

#Add for each row corresponding to a sample
#the positive (PC) and negative plate controls (NC)
inhtox2 %>%
  dplyr::filter(str_detect(Position,"E12")) %>%
  rename(Position_PC=Position,
         CrossingPoint_PC=CrossingPoint,
         Concentration_PC=Concentration,
         Standard_PC=Standard,
         StatusCodes_PC=StatusCodes,
         CpUncertain_PC=CpUncertain) %>%
  select(3,5:10,12,13)-> tPC
full_join(inhtox3,tPC,by="PlateName") -> inhtox3
inhtox2 %>%
  dplyr::filter(str_detect(Position,"E11")) %>%
  rename(Position_NC=Position,
         CrossingPoint_NC=CrossingPoint,
         Concentration_NC=Concentration,
         Standard_NC=Standard,
         StatusCodes_NC=StatusCodes,
         CpUncertain_NC=CpUncertain) %>%
  select(3,5:10,12,13)-> tNC
full_join(inhtox3,tNC,by="PlateName") %>%
  select(1,2,10,11,4,12,13,3,5:9,14:31,33:38,40:45,47:52,55:60)->inhtox3
cat("Number of rows after incrementation of plate positive and negative controls:")
nrow(inhtox3)

cat("Number of rows after fusion of Toxoplasma PCR and clinico-biological datasets")
nrow(toxo)


cat("Number of rows after fusion of Toxoplasma PCR results to leucocytes counts for blood samples")
nrow(toxo2)

```

\


## Descriptive analysis

###Summary of every analyzed samples

We analyzed here **`r nrow(toxo)` different clinical samples.**

\
  

####Table of matrix of the analyzed samples (DXLab raw data)

```{r matrix}
toxo %>%
  dplyr::group_by(Matrix,Info_patient) %>%
  count_() %>% kable()
```



####Table of number of analyzed samples per matrix class

```{r matrix2}
#The Sample Name 1813110 actually corresponded to aqueous humor and not csf
toxo %>%
  filter(!is.na(Matrix)) %>%
  mutate(gglion=ifelse(str_detect(Info_patient,"ganglionnaire")|
                         str_detect(Info_patient,"adénopathie"),1,0),
         retine=ifelse(str_detect(Info_patient,"rétinienne"),1,0),
         cereb=ifelse(str_detect(Info_patient,"cérébra"),1,0),
         hepat=ifelse(str_detect(Info_patient,"hépatique"),1,0),
         card=ifelse(str_detect(Info_patient,"péricardique"),1,0),
         pleural=ifelse(str_detect(Info_patient,"pleural"),1,0),
         mo=ifelse(str_detect(Info_patient,"Moelle osseuse"),1,0),
         la=ifelse(str_detect(Matrix,"Liquide amniotique"),1,0),
         lcr=ifelse(str_detect(Matrix,"LCR"),1,0),
         lba=ifelse(str_detect(Matrix,"bronchiolo-alvéolaire"),1,0),
         placenta=ifelse(str_detect(Matrix,"Placenta"),1,0),
         ascite=ifelse(str_detect(Info_patient,"ascite"),1,0),
         cordon=ifelse(str_detect(Matrix,"cordon"),1,0),
         sang=ifelse(str_detect(Matrix,"Sang veineux") &
                       str_detect(Info_patient,"N/A"),1,0),
         ha=ifelse(str_detect(Matrix,"Humeur aqueuse") |
         str_detect(Info_patient,"Humeur aqueuse") ,1,0)) %>%
  transform(sang=ifelse(str_detect(Matrix,"Sang veineux") &
                          str_detect(Info_patient,"Humeur aqueuse"),0.5,sang),
            ha=ifelse(str_detect(Info_patient,"Humeur aqueuse"),0.5,ha)) %>%
  dplyr::summarise(Samples="all",
            Total=n(),
            Blood=sum(sang),
            `Bone marrow`=sum(mo),
            CSF=sum(lcr),
             AF=sum(la),
            `Cord blood`=sum(cordon),
            Placenta=sum(placenta),
            BAL=sum(lba),
            `Lymph node`=sum(gglion),
            Retina=sum(retine),
            `Cerebral biopsy`=sum(cereb),
            `Hepatic biopsy`=sum(hepat),
            `Pericardic fluid`=sum(card),
            `Pleural fluid`=sum(pleural),
            `Ascites`=sum(ascite),
             `Aqueous humor`=sum(ha)) %>% kable()
             
toxo %>%
  filter(!is.na(Matrix)) %>%
  mutate(gglion=ifelse(str_detect(Info_patient,"ganglionnaire")|
                         str_detect(Info_patient,"adénopathie"),1,0),
         retine=ifelse(str_detect(Info_patient,"rétinienne"),1,0),
         cereb=ifelse(str_detect(Info_patient,"cérébra"),1,0),
         hepat=ifelse(str_detect(Info_patient,"hépatique"),1,0),
         card=ifelse(str_detect(Info_patient,"péricardique"),1,0),
         pleural=ifelse(str_detect(Info_patient,"pleural"),1,0),
         mo=ifelse(str_detect(Info_patient,"Moelle osseuse"),1,0),
         la=ifelse(str_detect(Matrix,"Liquide amniotique"),1,0),
         lcr=ifelse(str_detect(Matrix,"LCR"),1,0),
         lba=ifelse(str_detect(Matrix,"bronchiolo-alvéolaire"),1,0),
         placenta=ifelse(str_detect(Matrix,"Placenta"),1,0),
         ascite=ifelse(str_detect(Info_patient,"ascite"),1,0),
         cordon=ifelse(str_detect(Matrix,"cordon"),1,0),
         sang=ifelse(str_detect(Matrix,"Sang veineux") &
                       str_detect(Info_patient,"N/A"),1,0),
         ha=ifelse(str_detect(Matrix,"Humeur aqueuse") |
         str_detect(Info_patient,"Humeur aqueuse") ,1,0)) %>%
  transform(sang=ifelse(str_detect(Matrix,"Sang veineux") &
                          str_detect(Info_patient,"Humeur aqueuse"),0.5,sang),
            ha=ifelse(str_detect(Info_patient,"Humeur aqueuse"),0.5,ha)) %>%
  filter(!is.na(Analysis.Name.y) &
          Experiment.Name.x!=160721 &
          !SampleName_m %in% c(830627,2560683,2992839)) %>%
  dplyr::summarise(Samples="controlled 1/10 diluted",
            Total=n(),
            Blood=sum(sang),
            `Bone marrow`=sum(mo),
            CSF=sum(lcr),
             AF=sum(la),
            `Cord blood`=sum(cordon),
            Placenta=sum(placenta),
            BAL=sum(lba),
            `Lymph node`=sum(gglion),
            Retina=sum(retine),
            `Cerebral biopsy`=sum(cereb),
            `Hepatic biopsy`=sum(hepat),
            `Pericardic fluid`=sum(card),
            `Pleural fluid`=sum(pleural),
            `Ascites`=sum(ascite),
             `Aqueous humor`=sum(ha)) %>% kable()

```


#### Table of number of positive samples per matrix class

```{r pos_ratio_matrix}
toxo %>%
  filter(!is.na(Matrix)) %>%
  filter(str_detect(Info_patient,"ganglionnaire")|
           str_detect(Info_patient,"adénopathie")) %>%
  mutate(Pos_result= ifelse(str_detect(Conclusion,"Présence"),1,0),
         Neg_result= ifelse(str_detect(Conclusion,"Absence"),1,0)) %>%
  summarise(Matrix="lymph node",
            N_pos=sum(Pos_result),
            N=n(),
            `Percentage`=sum(Pos_result)/n()*100) -> t01

toxo %>%
  filter(!is.na(Matrix)) %>%
  filter(str_detect(Info_patient,"rétinienne")) %>%
  mutate(Pos_result= ifelse(str_detect(Conclusion,"Présence"),1,0),
         Neg_result= ifelse(str_detect(Conclusion,"Absence"),1,0)) %>%
  summarise(Matrix="retina",
            N_pos=sum(Pos_result),
            N=n(),
            `Percentage`=sum(Pos_result)/n()*100) -> t02
bind_rows(t01,t02) -> t01
toxo %>%
  filter(!is.na(Matrix)) %>%
  filter(str_detect(Info_patient,"cérébra")) %>%
  mutate(Pos_result= ifelse(str_detect(Conclusion,"Présence"),1,0),
         Neg_result= ifelse(str_detect(Conclusion,"Absence"),1,0)) %>%
  summarise(Matrix="cerebral biopsy",
            N_pos=sum(Pos_result),
            N=n(),
            `Percentage`=sum(Pos_result)/n()*100) -> t02
bind_rows(t01,t02) -> t01
toxo %>%
  filter(!is.na(Matrix)) %>%
  filter(str_detect(Info_patient,"hépatique")) %>%
  mutate(Pos_result= ifelse(str_detect(Conclusion,"Présence"),1,0),
         Neg_result= ifelse(str_detect(Conclusion,"Absence"),1,0)) %>%
  summarise(Matrix="liver biopsy",
            N_pos=sum(Pos_result),
            N=n(),
            `Percentage`=sum(Pos_result)/n()*100) -> t02
bind_rows(t01,t02) -> t01
toxo %>%
  filter(!is.na(Matrix)) %>%
  filter(str_detect(Info_patient,"péricardique")) %>%
  mutate(Pos_result= ifelse(str_detect(Conclusion,"Présence"),1,0),
         Neg_result= ifelse(str_detect(Conclusion,"Absence"),1,0)) %>%
  summarise(Matrix="heart biopsy",
            N_pos=sum(Pos_result),
            N=n(),
            `Percentage`=sum(Pos_result)/n()*100) -> t02
bind_rows(t01,t02) -> t01
toxo %>%
  filter(!is.na(Matrix)) %>%
  filter(str_detect(Info_patient,"pleural")) %>%
  mutate(Pos_result= ifelse(str_detect(Conclusion,"Présence"),1,0),
         Neg_result= ifelse(str_detect(Conclusion,"Absence"),1,0)) %>%
  summarise(Matrix="pleural fuid",
            N_pos=sum(Pos_result),
            N=n(),
            `Percentage`=sum(Pos_result)/n()*100) -> t02
bind_rows(t01,t02) -> t01
toxo %>%
  filter(!is.na(Matrix)) %>%
  filter(str_detect(Info_patient,"Moelle osseuse")) %>%
  mutate(Pos_result= ifelse(str_detect(Conclusion,"Présence"),1,0),
         Neg_result= ifelse(str_detect(Conclusion,"Absence"),1,0)) %>%
  summarise(Matrix="bone marrow",
            N_pos=sum(Pos_result),
            N=n(),
            `Percentage`=sum(Pos_result)/n()*100) -> t02
bind_rows(t01,t02) -> t01
toxo %>%
  filter(!is.na(Matrix)) %>%
  filter(str_detect(Matrix,"Liquide amniotique")) %>% 
  mutate(Pos_result= ifelse(str_detect(Conclusion,"Présence"),1,0),
         Neg_result= ifelse(str_detect(Conclusion,"Absence"),1,0)) %>%
  summarise(Matrix="AF",
            N_pos=sum(Pos_result),
            N=n(),
            `Percentage`=sum(Pos_result)/n()*100)-> t02
bind_rows(t01,t02) -> t01
toxo %>%
  filter(!is.na(Matrix)) %>%
  filter(str_detect(Matrix,"LCR")|
           str_detect(Info_patient,"LCR")) %>% 
  mutate(Pos_result= ifelse(str_detect(Conclusion,"Présence"),1,0),
         Neg_result= ifelse(str_detect(Conclusion,"Absence"),1,0)) %>%
  summarise(Matrix="CSF",
            N_pos=sum(Pos_result),
            N=n(),
            `Percentage`=sum(Pos_result)/n()*100) -> t02
bind_rows(t01,t02) -> t01
toxo %>%
  filter(!is.na(Matrix)) %>%
  filter(str_detect(Matrix,"bronchiolo-alvéolaire")) %>%
  mutate(Pos_result= ifelse(str_detect(Conclusion,"Présence"),1,0),
         Neg_result= ifelse(str_detect(Conclusion,"Absence"),1,0)) %>%
  summarise(Matrix="BAL",
            N_pos=sum(Pos_result),
            N=n(),
            `Percentage`=sum(Pos_result)/n()*100) -> t02
bind_rows(t01,t02) -> t01
toxo %>%
  filter(!is.na(Matrix)) %>%
  filter(str_detect(Matrix,"Placenta")) %>%
  mutate(Pos_result= ifelse(str_detect(Conclusion,"Présence"),1,0),
         Neg_result= ifelse(str_detect(Conclusion,"Absence"),1,0)) %>%
  summarise(Matrix="placenta",
            N_pos=sum(Pos_result),
            N=n(),
            `Percentage`=sum(Pos_result)/n()*100) -> t02
bind_rows(t01,t02) -> t01
toxo %>%
  filter(!is.na(Matrix)) %>%
  filter(str_detect(Info_patient,"ascite")) %>%
  mutate(Pos_result= ifelse(str_detect(Conclusion,"Présence"),1,0),
         Neg_result= ifelse(str_detect(Conclusion,"Absence"),1,0)) %>%
  summarise(Matrix="ascites",
            N_pos=sum(Pos_result),
            N=n(),
            `Percentage`=sum(Pos_result)/n()*100) -> t02
bind_rows(t01,t02) -> t01
toxo %>%
  filter(!is.na(Matrix)) %>%
  filter(str_detect(Matrix,"cordon")) %>%
  mutate(Pos_result= ifelse(str_detect(Conclusion,"Présence de toxoplasmes dans le placenta et le sang") ,1,0)) %>%
  summarise(Matrix="cord blood",
            N_pos=sum(Pos_result),
            N=n(),
            `Percentage`=sum(Pos_result)/n()*100) -> t02
bind_rows(t01,t02) -> t01
toxo %>%
  filter(!is.na(Matrix)) %>%
  filter(str_detect(Matrix,"Sang veineux")&
           Info_patient %in% c("N/A","Humeur aqueuse") &
           SampleName.x!= "153 0868 HA") %>%
  mutate(Pos_result= ifelse(str_detect(Conclusion,"Présence"),1,0),
         Neg_result= ifelse(str_detect(Conclusion,"Absence"),1,0)) %>%
  summarise(Matrix="blood",
            N_pos=sum(Pos_result),
            N=n(),
            `Percentage`=sum(Pos_result)/n()*100) -> t02
bind_rows(t01,t02) -> t01
toxo %>%
  filter(!is.na(Matrix)) %>%
  filter(str_detect(Matrix,"Humeur aqueuse") &
           Info_patient!="Liquide céphalo-rachidien (LCR)"|
           SampleName.x== "153 0868 HA") %>% 
  mutate(Pos_result= ifelse(str_detect(Conclusion,"Présence"),1,0),
         Neg_result= ifelse(str_detect(Conclusion,"Absence"),1,0)) %>%
  summarise(Matrix="Aqueous humor",
            N_pos=sum(Pos_result),
            N=n(),
            `Percentage`=sum(Pos_result)/n()*100) -> t02
bind_rows(t01,t02) -> t01
t01 %>%
  summarise(Matrix="Total",
            N_pos=sum(N_pos),
            N=sum(N),
            `Percentage`=sum(N_pos)/sum(N)*100) -> t02
bind_rows(t01,t02)%>% kable(digits=2)

```


#### Table of number of positive results in paucicellular and non paucicellular blood samples

```{r pos_ratio_blood_pauci}
#Selection of blood samples and classification as paucicellular or not
#Blood samples with associated full blood count
#Loading full blood counts
fbctox<-read.csv(file="E:/inhib/data R/toxo_FBC_DxLab_R.csv",sep=";",header=T,dec=".")

#Creating a column for merging dataframes
fbctox %>%
  transform(DOB=dmy(DOB),
            Date_sampling=dmy_hm(Date_sampling)) %>%
  mutate(ID=paste(IEP,Date_sampling,sep="_")) %>%
  transform(ID=str_sub(ID,1,21),
            WBC=as.numeric(as.character(WBC))) %>%
  distinct(ID,.keep_all=T)-> fbctox2

#Blood samples with full blood count automatically associated  and merging dataframes
toxo %>%
  mutate(ID=paste(IEP,Date_sampling,sep="_")) %>%
  transform(ID=str_sub(ID,1,21)) %>%
  filter(str_detect(Matrix,"Sang veineux")&
           Info_patient %in% c("N/A","Humeur aqueuse") &
           SampleName.x!= "153 0868 HA") %>%
  left_join(fbctox2,by="ID") %>%
  filter(!is.na(WBC)) %>%
  transform(WBC=as.numeric(WBC)) %>%
  mutate(pauci=ifelse(WBC<3,1,0)) %>%
  select(1:139,155) -> tg_fbc

#Blood samples without WBC
#Loading classification as paucicellular or not
cyt_man<-read.csv(file="E:/inhib/PCR toxo sans cytologies associees (1).csv",sep=";",header=T,dec=".")

#Selection, merging and classification as paucicellular
toxo %>%
  mutate(ID=paste(IEP,Date_sampling,sep="_")) %>%
  transform(ID=str_sub(ID,1,21)) %>%
  filter(str_detect(Matrix,"Sang veineux") &
           Info_patient %in% c("N/A","Humeur aqueuse") &
           SampleName.x!= "153 0868 HA") %>% 
  left_join(fbctox2,by="ID") %>% 
  filter(is.na(WBC) ) %>%
  left_join(cyt_man,by="Num_demande.x") %>%
  mutate(pauci=ifelse(cyto %in% c("pauci","aplasie"),1,0)) %>%
  select(1:139,166)-> tg_bld

#Merging into one dataframe
bind_rows(tg_fbc,tg_bld) -> toxo_p

#Creation of a summarising table
toxo_p %>%
   mutate(Pos_result= ifelse(str_detect(Conclusion,"Présence"),1,0),
         Neg_result= ifelse(str_detect(Conclusion,"Absence"),1,0)) %>% 
  distinct() %>%
  group_by(pauci) %>%
  summarise(Matrix="blood",
            N_pos=sum(Pos_result),
            N=n(),
            `Percentage pos`=sum(Pos_result)/n()*100) %>% kable(digits=2)

```


####Cp albumin value per matrix class
Prior to calculation of average statistical parameters of Cp albumin values per matrix,
we excluded samples with Cp(albumin) >= 45 in order to exclude potentially inhibition
nor failed extraction.

```{r matrix_cp_alb}
toxo %>%
  filter(!is.na(Matrix) & CrossingPoint_H.x <45) %>%
  filter(str_detect(Info_patient,"ganglionnaire")|
           str_detect(Info_patient,"adénopathie")) %>%
  summarise(Matrix="lymph node",
            N=n(),
            `Mean Cp alb`=mean(CrossingPoint_H.x),
            `SD Cp alb`=sd(CrossingPoint_H.x),
            `Median Cp alb`=median(CrossingPoint_H.x),
            `Min Cp alb`=min(CrossingPoint_H.x),
            `Max Cp alb`=max(CrossingPoint_H.x)) -> t01

toxo %>%
  filter(!is.na(Matrix) & CrossingPoint_H.x <45) %>%
  filter(str_detect(Info_patient,"rétinienne")) %>%
  summarise(Matrix="retina",
            N=n(),
            `Mean Cp alb`=mean(CrossingPoint_H.x),
            `SD Cp alb`=sd(CrossingPoint_H.x),
            `Median Cp alb`=median(CrossingPoint_H.x),
            `Min Cp alb`=min(CrossingPoint_H.x),
            `Max Cp alb`=max(CrossingPoint_H.x)) -> t02
bind_rows(t01,t02) -> t01
toxo %>%
  filter(!is.na(Matrix) & CrossingPoint_H.x <45) %>%
  filter(str_detect(Info_patient,"cérébra")) %>%
  summarise(Matrix="cerebral biospy",
            N=n(),
            `Mean Cp alb`=mean(CrossingPoint_H.x),
            `SD Cp alb`=sd(CrossingPoint_H.x),
            `Median Cp alb`=median(CrossingPoint_H.x),
            `Min Cp alb`=min(CrossingPoint_H.x),
            `Max Cp alb`=max(CrossingPoint_H.x)) -> t02
bind_rows(t01,t02) -> t01
toxo %>%
  filter(!is.na(Matrix) & CrossingPoint_H.x <45) %>%
  filter(str_detect(Info_patient,"hépatique")) %>%
  summarise(Matrix="liver biospy",
            N=n(),
            `Mean Cp alb`=mean(CrossingPoint_H.x),
            `SD Cp alb`=sd(CrossingPoint_H.x),
            `Median Cp alb`=median(CrossingPoint_H.x),
            `Min Cp alb`=min(CrossingPoint_H.x),
            `Max Cp alb`=max(CrossingPoint_H.x)) -> t02
bind_rows(t01,t02) -> t01
toxo %>%
  filter(!is.na(Matrix) & CrossingPoint_H.x <45) %>%
  filter(str_detect(Info_patient,"péricardique")) %>%
  summarise(Matrix="heart biospy",
            N=n(),
            `Mean Cp alb`=mean(CrossingPoint_H.x),
            `SD Cp alb`=sd(CrossingPoint_H.x),
            `Median Cp alb`=median(CrossingPoint_H.x),
            `Min Cp alb`=min(CrossingPoint_H.x),
            `Max Cp alb`=max(CrossingPoint_H.x)) -> t02
bind_rows(t01,t02) -> t01
toxo %>%
  filter(!is.na(Matrix) & CrossingPoint_H.x <45) %>%
  filter(str_detect(Info_patient,"pleural")) %>%
  summarise(Matrix="pleural fluid",
            N=n(),
            `Mean Cp alb`=mean(CrossingPoint_H.x),
            `SD Cp alb`=sd(CrossingPoint_H.x),
            `Median Cp alb`=median(CrossingPoint_H.x),
            `Min Cp alb`=min(CrossingPoint_H.x),
            `Max Cp alb`=max(CrossingPoint_H.x)) -> t02
bind_rows(t01,t02) -> t01
toxo %>%
  filter(!is.na(Matrix) & CrossingPoint_H.x <45) %>%
  filter(str_detect(Info_patient,"Moelle osseuse")) %>%
  summarise(Matrix="bone marrow",
            N=n(),
            `Mean Cp alb`=mean(CrossingPoint_H.x),
            `SD Cp alb`=sd(CrossingPoint_H.x),
            `Median Cp alb`=median(CrossingPoint_H.x),
            `Min Cp alb`=min(CrossingPoint_H.x),
            `Max Cp alb`=max(CrossingPoint_H.x)) -> t02
bind_rows(t01,t02) -> t01
toxo %>%
  filter(!is.na(Matrix) & CrossingPoint_H.x <45) %>%
  filter(str_detect(Matrix,"Liquide amniotique")) %>% 
  summarise(Matrix="AF",
            N=n(),
            `Mean Cp alb`=mean(CrossingPoint_H.x),
            `SD Cp alb`=sd(CrossingPoint_H.x),
            `Median Cp alb`=median(CrossingPoint_H.x),
            `Min Cp alb`=min(CrossingPoint_H.x),
            `Max Cp alb`=max(CrossingPoint_H.x)) -> t02
bind_rows(t01,t02) -> t01
toxo %>%
  filter(!is.na(Matrix) & CrossingPoint_H.x <45) %>%
  filter(str_detect(Matrix,"LCR")|
           str_detect(Info_patient,"LCR")) %>% 
  summarise(Matrix="CSF",
            N=n(),
            `Mean Cp alb`=mean(CrossingPoint_H.x),
            `SD Cp alb`=sd(CrossingPoint_H.x),
            `Median Cp alb`=median(CrossingPoint_H.x),
            `Min Cp alb`=min(CrossingPoint_H.x),
            `Max Cp alb`=max(CrossingPoint_H.x)) -> t02
bind_rows(t01,t02) -> t01
toxo %>%
  filter(!is.na(Matrix) & CrossingPoint_H.x <45) %>%
  filter(str_detect(Matrix,"bronchiolo-alvéolaire")) %>%
  summarise(Matrix="BAL",
            N=n(),
            `Mean Cp alb`=mean(CrossingPoint_H.x),
            `SD Cp alb`=sd(CrossingPoint_H.x),
            `Median Cp alb`=median(CrossingPoint_H.x),
            `Min Cp alb`=min(CrossingPoint_H.x),
            `Max Cp alb`=max(CrossingPoint_H.x)) -> t02
bind_rows(t01,t02) -> t01
toxo %>%
  filter(!is.na(Matrix) & CrossingPoint_H.x <45) %>%
  filter(str_detect(Matrix,"Placenta")) %>%
  summarise(Matrix="placenta",
            N=n(),
            `Mean Cp alb`=mean(CrossingPoint_H.x),
            `SD Cp alb`=sd(CrossingPoint_H.x),
            `Median Cp alb`=median(CrossingPoint_H.x),
            `Min Cp alb`=min(CrossingPoint_H.x),
            `Max Cp alb`=max(CrossingPoint_H.x)) -> t02
bind_rows(t01,t02) -> t01
toxo %>%
  filter(!is.na(Matrix) & CrossingPoint_H.x <45) %>%
  filter(str_detect(Info_patient,"ascite")) %>%
  summarise(Matrix="ascites",
            N=n(),
            `Mean Cp alb`=mean(CrossingPoint_H.x),
            `SD Cp alb`=sd(CrossingPoint_H.x),
            `Median Cp alb`=median(CrossingPoint_H.x),
            `Min Cp alb`=min(CrossingPoint_H.x),
            `Max Cp alb`=max(CrossingPoint_H.x)) -> t02
bind_rows(t01,t02) -> t01
toxo %>%
  filter(!is.na(Matrix) & CrossingPoint_H.x <45) %>%
  filter(str_detect(Matrix,"cordon")) %>%
  summarise(Matrix="cord blood",
            N=n(),
            `Mean Cp alb`=mean(CrossingPoint_H.x),
            `SD Cp alb`=sd(CrossingPoint_H.x),
            `Median Cp alb`=median(CrossingPoint_H.x),
            `Min Cp alb`=min(CrossingPoint_H.x),
            `Max Cp alb`=max(CrossingPoint_H.x)) -> t02
bind_rows(t01,t02) -> t01
toxo %>%
  filter(!is.na(Matrix) & CrossingPoint_H.x <45) %>%
  filter(str_detect(Matrix,"Sang veineux")&
           Info_patient %in% c("N/A","Humeur aqueuse") &
           SampleName.x!= "153 0868 HA") %>%
  summarise(Matrix="blood",
            N=n(),
            `Mean Cp alb`=mean(CrossingPoint_H.x),
            `SD Cp alb`=sd(CrossingPoint_H.x),
            `Median Cp alb`=median(CrossingPoint_H.x),
            `Min Cp alb`=min(CrossingPoint_H.x),
            `Max Cp alb`=max(CrossingPoint_H.x)) -> t02
bind_rows(t01,t02) -> t01
toxo %>%
  filter(!is.na(Matrix) & CrossingPoint_H.x <45) %>%
  filter(str_detect(Matrix,"Humeur aqueuse") &
           Info_patient!="Liquide céphalo-rachidien (LCR)"|
          SampleName.x== "153 0868 HA") %>% 
  summarise(Matrix="Aqueous humor",
            N=n(),
            `Mean Cp alb`=mean(CrossingPoint_H.x),
            `SD Cp alb`=sd(CrossingPoint_H.x),
            `Median Cp alb`=median(CrossingPoint_H.x),
            `Min Cp alb`=min(CrossingPoint_H.x),
            `Max Cp alb`=max(CrossingPoint_H.x)) -> t02
bind_rows(t01,t02) %>% kable(digits=2)

```


####Cp albumin value per matrix class and per cellularity
Sample with 1 value in "pauci" column were considered as paucicellular.
Miscellaneous samples corresponded to samples of low number to obtain a mean Cp albumin value.
They were lymphe nodes, retina, cerebral biopsies, liver biopsies, heart biopsies or pericardic fluid, pleural fluids,
ascites, bone marrow.

```{r matrix_pauci_Cp_alb}

#Selection of non blood samples and classification as paucicellular or not 
# Five BAL were known to be paucicellular because they were extracted by TNN
toxo %>%
  mutate (pauci=ifelse
          (Matrix %in% c("Liquide amniotique",
                         "Liquide céphalo-rachidien (LCR)",
                         "Humeur aqueuse")|
              Info_patient %in% c("Liquide d'ascite",
                                  "Liquide péricardique",
                                  "Liquide pleural")|
              Num_travail %in% c(99163222723,99162523175,
                                 99162503057,99161381971,99160961446)| 
              SampleName.x=="153 0868 HA",1,0),
          bld=ifelse(Matrix=="Sang veineux" & Info_patient=="N/A",1,0))%>% 
  filter(bld==0) %>% select(-bld) ->  tg_oth

#Selection of blood samples and classification as paucicellular or not
#Blood samples with associated full blood count
#Loading full blood counts
fbctox<-read.csv(file="E:/inhib/data R/toxo_FBC_DxLab_R.csv",sep=";",header=T,dec=".")

#Creating a column for merging dataframes
fbctox %>%
  transform(DOB=dmy(DOB),
            Date_sampling=dmy_hm(Date_sampling)) %>%
  mutate(ID=paste(IEP,Date_sampling,sep="_")) %>%
  transform(ID=str_sub(ID,1,21),
            WBC=as.numeric(as.character(WBC))) %>%
  distinct(ID,.keep_all=T)-> fbctox2

#Blood samples with full blood count automatically associated  and merging dataframes
toxo %>%
  mutate(ID=paste(IEP,Date_sampling,sep="_")) %>%
  transform(ID=str_sub(ID,1,21)) %>%
  filter(Matrix=="Sang veineux" & Info_patient=="N/A") %>%
  left_join(fbctox2,by="ID") %>%
  filter(!is.na(WBC)) %>%
  transform(WBC=as.numeric(WBC)) %>%
  mutate(pauci=ifelse(WBC<3,1,0)) %>%
  select(1:139,155) -> tg_fbc

#Blood samples without WBC
#Loading classification as paucicellular or not
cyt_man<-read.csv(file="E:/inhib/PCR toxo sans cytologies associees (1).csv",sep=";",header=T,dec=".")

#Selection, merging and classification as paucicellular
toxo %>%
  mutate(ID=paste(IEP,Date_sampling,sep="_")) %>%
  transform(ID=str_sub(ID,1,21)) %>%
  filter(Matrix=="Sang veineux" & 
        Info_patient=="N/A" &
        SampleName.x!="153 0868 HA") %>% 
  left_join(fbctox2,by="ID") %>% 
  filter(is.na(WBC) ) %>%
  left_join(cyt_man,by="Num_demande.x") %>%
  mutate(pauci=ifelse(cyto %in% c("pauci","aplasie"),1,0)) %>%
  select(1:139,166) %>%
  rename(Matrix=Matrix.x)-> tg_bld

#Merging into one dataframe
bind_rows(tg_oth,tg_fbc,tg_bld) -> toxo_p

#Creation of a summarising table
toxo_p %>%
  filter(!is.na(Matrix) & CrossingPoint_H.x<45) %>%
  filter(str_detect(Matrix,"Fragment")|
           str_detect(Info_patient,"ascite")) %>%
  summarise(Matrix="miscellaneous",
            N=n(),
            `Mean Cp alb`=mean(CrossingPoint_H.x),
            `SD Cp alb`=sd(CrossingPoint_H.x),
            `Median Cp alb`=median(CrossingPoint_H.x),
            `Min Cp alb`=min(CrossingPoint_H.x),
            `Max Cp alb`=max(CrossingPoint_H.x)) -> t01
toxo_p %>%
  filter(!is.na(Matrix) & CrossingPoint_H.x<45) %>%
  filter(str_detect(Info_patient,"ganglionnaire")|
           str_detect(Info_patient,"adénopathie")) %>%
  group_by(pauci) %>%
  summarise(Matrix="lymph node",
            N=n(),
            `Mean Cp alb`=mean(CrossingPoint_H.x),
            `SD Cp alb`=sd(CrossingPoint_H.x),
            `Median Cp alb`=median(CrossingPoint_H.x),
            `Min Cp alb`=min(CrossingPoint_H.x),
            `Max Cp alb`=max(CrossingPoint_H.x)) -> t02
bind_rows(t01,t02) -> t01
toxo_p %>%
  filter(!is.na(Matrix) & CrossingPoint_H.x<45) %>%
  filter(str_detect(Info_patient,"rétinienne")) %>%
  group_by(pauci) %>%
  summarise(Matrix="retina",
            N=n(),
            `Mean Cp alb`=mean(CrossingPoint_H.x),
            `SD Cp alb`=sd(CrossingPoint_H.x),
            `Median Cp alb`=median(CrossingPoint_H.x),
            `Min Cp alb`=min(CrossingPoint_H.x),
            `Max Cp alb`=max(CrossingPoint_H.x)) -> t02
bind_rows(t01,t02) -> t01
toxo_p %>%
  filter(!is.na(Matrix) & CrossingPoint_H.x<45) %>%
  filter(str_detect(Info_patient,"cérébra")) %>%
  group_by(pauci) %>%
  summarise(Matrix="cerebral biospy",
            N=n(),
            `Mean Cp alb`=mean(CrossingPoint_H.x),
            `SD Cp alb`=sd(CrossingPoint_H.x),
            `Median Cp alb`=median(CrossingPoint_H.x),
            `Min Cp alb`=min(CrossingPoint_H.x),
            `Max Cp alb`=max(CrossingPoint_H.x)) -> t02
bind_rows(t01,t02) -> t01
toxo_p %>%
  filter(!is.na(Matrix) & CrossingPoint_H.x<45) %>%
  filter(str_detect(Info_patient,"hépatique")) %>%
  group_by(pauci) %>%
  summarise(Matrix="liver biospy",
            N=n(),
            `Mean Cp alb`=mean(CrossingPoint_H.x),
            `SD Cp alb`=sd(CrossingPoint_H.x),
            `Median Cp alb`=median(CrossingPoint_H.x),
            `Min Cp alb`=min(CrossingPoint_H.x),
            `Max Cp alb`=max(CrossingPoint_H.x)) -> t02
bind_rows(t01,t02) -> t01
toxo_p %>%
  filter(!is.na(Matrix) & CrossingPoint_H.x<45) %>%
  filter(str_detect(Info_patient,"péricardique")) %>%
  group_by(pauci) %>%
  summarise(Matrix="heart biospy",
            N=n(),
            `Mean Cp alb`=mean(CrossingPoint_H.x),
            `SD Cp alb`=sd(CrossingPoint_H.x),
            `Median Cp alb`=median(CrossingPoint_H.x),
            `Min Cp alb`=min(CrossingPoint_H.x),
            `Max Cp alb`=max(CrossingPoint_H.x)) -> t02
bind_rows(t01,t02) -> t01
toxo_p %>%
  filter(!is.na(Matrix) & CrossingPoint_H.x<45) %>%
  filter(str_detect(Info_patient,"pleural")) %>%
  group_by(pauci) %>%
  summarise(Matrix="pleural fluid",
            N=n(),
            `Mean Cp alb`=mean(CrossingPoint_H.x),
            `SD Cp alb`=sd(CrossingPoint_H.x),
            `Median Cp alb`=median(CrossingPoint_H.x),
            `Min Cp alb`=min(CrossingPoint_H.x),
            `Max Cp alb`=max(CrossingPoint_H.x)) -> t02
bind_rows(t01,t02) -> t01
toxo_p %>%
  filter(!is.na(Matrix) & CrossingPoint_H.x<45) %>%
  filter(str_detect(Info_patient,"Moelle osseuse")) %>%
  group_by(pauci) %>%
  summarise(Matrix="bone marrow",
            N=n(),
            `Mean Cp alb`=mean(CrossingPoint_H.x),
            `SD Cp alb`=sd(CrossingPoint_H.x),
            `Median Cp alb`=median(CrossingPoint_H.x),
            `Min Cp alb`=min(CrossingPoint_H.x),
            `Max Cp alb`=max(CrossingPoint_H.x)) -> t02
bind_rows(t01,t02) -> t01
toxo_p %>%
  filter(!is.na(Matrix)) %>%
  filter(str_detect(Matrix,"Liquide amniotique")) %>%
  group_by(pauci) %>%
  summarise(Matrix="AF",
            N=n(),
            `Mean Cp alb`=mean(CrossingPoint_H.x),
            `SD Cp alb`=sd(CrossingPoint_H.x),
            `Median Cp alb`=median(CrossingPoint_H.x),
            `Min Cp alb`=min(CrossingPoint_H.x),
            `Max Cp alb`=max(CrossingPoint_H.x)) -> t02
bind_rows(t01,t02) -> t01
toxo_p %>%
  filter(!is.na(Matrix) & CrossingPoint_H.x<45) %>%
  filter(str_detect(Matrix,"LCR")|
           str_detect(Info_patient,"LCR")) %>%
  group_by(pauci) %>%
  summarise(Matrix="CSF",
            N=n(),
            `Mean Cp alb`=mean(CrossingPoint_H.x),
            `SD Cp alb`=sd(CrossingPoint_H.x),
            `Median Cp alb`=median(CrossingPoint_H.x),
            `Min Cp alb`=min(CrossingPoint_H.x),
            `Max Cp alb`=max(CrossingPoint_H.x)) -> t02
bind_rows(t01,t02) -> t01
toxo_p %>%
  filter(!is.na(Matrix) & CrossingPoint_H.x<45) %>%
  filter(str_detect(Matrix,"bronchiolo-alvéolaire")) %>%
  group_by(pauci) %>%
  summarise(Matrix="BAL",
            N=n(),
            `Mean Cp alb`=mean(CrossingPoint_H.x),
            `SD Cp alb`=sd(CrossingPoint_H.x),
            `Median Cp alb`=median(CrossingPoint_H.x),
            `Min Cp alb`=min(CrossingPoint_H.x),
            `Max Cp alb`=max(CrossingPoint_H.x)) -> t02
bind_rows(t01,t02) -> t01
toxo_p %>%
  filter(!is.na(Matrix) & CrossingPoint_H.x<45) %>%
  filter(str_detect(Matrix,"Placenta")) %>%
  group_by(pauci) %>%
  summarise(Matrix="placenta",
            N=n(),
            `Mean Cp alb`=mean(CrossingPoint_H.x),
            `SD Cp alb`=sd(CrossingPoint_H.x),
            `Median Cp alb`=median(CrossingPoint_H.x),
            `Min Cp alb`=min(CrossingPoint_H.x),
            `Max Cp alb`=max(CrossingPoint_H.x)) -> t02
bind_rows(t01,t02) -> t01
toxo_p %>%
  filter(!is.na(Matrix) & CrossingPoint_H.x<45) %>%
  filter(str_detect(Info_patient,"ascite")) %>%
  group_by(pauci) %>%
  summarise(Matrix="ascites",
            N=n(),
            `Mean Cp alb`=mean(CrossingPoint_H.x),
            `SD Cp alb`=sd(CrossingPoint_H.x),
            `Median Cp alb`=median(CrossingPoint_H.x),
            `Min Cp alb`=min(CrossingPoint_H.x),
            `Max Cp alb`=max(CrossingPoint_H.x)) -> t02
bind_rows(t01,t02) -> t01
toxo_p %>%
  filter(!is.na(Matrix) & CrossingPoint_H.x<45) %>%
  filter(str_detect(Matrix,"cordon")) %>%
  group_by(pauci) %>%
  summarise(Matrix="cord blood",
            N=n(),
            `Mean Cp alb`=mean(CrossingPoint_H.x),
            `SD Cp alb`=sd(CrossingPoint_H.x),
            `Median Cp alb`=median(CrossingPoint_H.x),
            `Min Cp alb`=min(CrossingPoint_H.x),
            `Max Cp alb`=max(CrossingPoint_H.x)) -> t02
bind_rows(t01,t02) -> t01
toxo_p %>%
  filter(!is.na(Matrix) & CrossingPoint_H.x<45) %>%
  filter(str_detect(Matrix,"Sang veineux")&
           Info_patient %in% c("N/A","Humeur aqueuse") &
           SampleName.x!= "153 0868 HA") %>%
  group_by(pauci) %>%
  summarise(Matrix="blood",
            N=n(),
            `Mean Cp alb`=mean(CrossingPoint_H.x),
            `SD Cp alb`=sd(CrossingPoint_H.x),
            `Median Cp alb`=median(CrossingPoint_H.x),
            `Min Cp alb`=min(CrossingPoint_H.x),
            `Max Cp alb`=max(CrossingPoint_H.x)) -> t02
bind_rows(t01,t02) -> t01
toxo_p %>%
  filter(!is.na(Matrix) & CrossingPoint_H.x<45) %>%
  filter(str_detect(Matrix,"Humeur aqueuse") &
           Info_patient!="Liquide céphalo-rachidien (LCR)"|
           SampleName.x== "153 0868 HA") %>%
  group_by(pauci) %>%
  summarise(Matrix="Aqueous humor",
            N=n(),
            `Mean Cp alb`=mean(CrossingPoint_H.x),
            `SD Cp alb`=sd(CrossingPoint_H.x),
            `Median Cp alb`=median(CrossingPoint_H.x),
            `Min Cp alb`=min(CrossingPoint_H.x),
            `Max Cp alb`=max(CrossingPoint_H.x)) -> t02
bind_rows(t01,t02) %>% kable (digits=2)
```

 

####Table summarising features of inhibition controls and albumin PCR results of samples

We distinguished here samples analyzed once and twice. Samples analyzed twice corresponded to samples controlled in a new PCR run, generally with 1/10 diluted DNA extract.

```{r twice_features}
#Summarising count of features of inhibition controls of samples analyzed twice with 1st alb PCR>=38
toxo %>%
  filter(!is.na(Experiment.Name.y)& Experiment.Name.x!="160721" & CrossingPoint_H.x>=38) %>% 
  select(SampleName.x,Expe_Analysis_Name.x,CrossingPoint_A.x,CrossingPoint_B.x,CrossingPoint_C.x,
         CrossingPoint_F.x,CrossingPoint_G.x,CrossingPoint_H.x) %>%
  mutate(`F<35 & G<35`=ifelse(CrossingPoint_F.x<35 & CrossingPoint_G.x< 35,1,0),
         `F<35 & 35=<G<38`= ifelse(CrossingPoint_F.x<35 & CrossingPoint_G.x< 38 &
                                    CrossingPoint_G.x>=35,1,0),
         `35=<F<38 & G<35`= ifelse(CrossingPoint_F.x< 38 &
                                    CrossingPoint_F.x>=35 &
                                    CrossingPoint_G.x<35,1,0),
         `35=<F<38 & 35=<G<38`= ifelse(CrossingPoint_F.x<38 & 
                                       CrossingPoint_F.x>=35 &
                                       CrossingPoint_G.x< 38 &
                                       CrossingPoint_G.x>=35,1,0),
         `F<35 & G>=38`=ifelse(CrossingPoint_F.x<35 & CrossingPoint_G.x>=38,1,0),
         `F>=38 & G<35`=ifelse(CrossingPoint_F.x>=38 & CrossingPoint_G.x< 35,1,0),
         `F>=38 & 35=<G<38`= ifelse(CrossingPoint_F.x>=38 & CrossingPoint_G.x< 38 &
                                    CrossingPoint_G.x>=35,1,0),
         `35=<F<38 & G>=38`= ifelse(CrossingPoint_F.x< 38 &
                                    CrossingPoint_F.x>=35 &
                                    CrossingPoint_G.x>=38,1,0),
         `F>=38 & G>=38`=ifelse(CrossingPoint_F.x>=38 & CrossingPoint_G.x>=38,1,0))%>%
  dplyr::summarise(Samples="analyzed twice with 1st alb PCR>=38",
                   total=n(),
                   `F<35 & G<35`=sum(`F<35 & G<35`),
                   `F<35 & 35=<G<38`=sum(`F<35 & 35=<G<38`),
                   `35=<F<38 & G<35`=sum(`35=<F<38 & G<35`),
                   `35=<F<38 & 35=<G<38`=sum(`35=<F<38 & 35=<G<38`),
                   `F<35 & G>=38`=sum(`F<35 & G>=38`),
                   `F>=38 & G<35`=sum(`F>=38 & G<35`),
                   `F>=38 & 35=<G<38`=sum(`F>=38 & 35=<G<38`),
                   `35=<F<38 & G>=38`=sum(`35=<F<38 & G>=38`),
                   `F>=38 & G>=38`=sum(`F>=38 & G>=38`)) -> pp1

#Summarising count of features of inhibition controls of samples analyzed twice with 1st alb PCR<38
toxo %>%
  filter(!is.na(Experiment.Name.y)& Experiment.Name.x!="160721" & CrossingPoint_H.x<38) %>% 
  select(SampleName.x,Expe_Analysis_Name.x,CrossingPoint_A.x,CrossingPoint_B.x,CrossingPoint_C.x,
         CrossingPoint_F.x,CrossingPoint_G.x,CrossingPoint_H.x) %>%
  mutate(`F<35 & G<35`=ifelse(CrossingPoint_F.x<35 & CrossingPoint_G.x< 35,1,0),
         `F<35 & 35=<G<38`= ifelse(CrossingPoint_F.x<35 & CrossingPoint_G.x< 38 &
                                    CrossingPoint_G.x>=35,1,0),
         `35=<F<38 & G<35`= ifelse(CrossingPoint_F.x< 38 &
                                    CrossingPoint_F.x>=35 &
                                    CrossingPoint_G.x<35,1,0),
         `35=<F<38 & 35=<G<38`= ifelse(CrossingPoint_F.x<38 & 
                                       CrossingPoint_F.x>=35 &
                                       CrossingPoint_G.x< 38 &
                                       CrossingPoint_G.x>=35,1,0),
         `F<35 & G>=38`=ifelse(CrossingPoint_F.x<35 & CrossingPoint_G.x>=38,1,0),
         `F>=38 & G<35`=ifelse(CrossingPoint_F.x>=38 & CrossingPoint_G.x< 35,1,0),
         `F>=38 & 35=<G<38`= ifelse(CrossingPoint_F.x>=38 & CrossingPoint_G.x< 38 &
                                    CrossingPoint_G.x>=35,1,0),
         `35=<F<38 & G>=38`= ifelse(CrossingPoint_F.x< 38 &
                                    CrossingPoint_F.x>=35 &
                                    CrossingPoint_G.x>=38,1,0),
         `F>=38 & G>=38`=ifelse(CrossingPoint_F.x>=38 & CrossingPoint_G.x>=38,1,0))%>%
  dplyr::summarise(Samples="analyzed twice with 1st alb PCR<38",
                   total=n(),
                   `F<35 & G<35`=sum(`F<35 & G<35`),
                   `F<35 & 35=<G<38`=sum(`F<35 & 35=<G<38`),
                   `35=<F<38 & G<35`=sum(`35=<F<38 & G<35`),
                   `35=<F<38 & 35=<G<38`=sum(`35=<F<38 & 35=<G<38`),
                   `F<35 & G>=38`=sum(`F<35 & G>=38`),
                   `F>=38 & G<35`=sum(`F>=38 & G<35`),
                   `F>=38 & 35=<G<38`=sum(`F>=38 & 35=<G<38`),
                   `35=<F<38 & G>=38`=sum(`35=<F<38 & G>=38`),
                   `F>=38 & G>=38`=sum(`F>=38 & G>=38`)) -> pp2


#Summarising count of features of inhibition controls of samples analyzed once with 1st alb PCR>=38
toxo %>%
  filter( Experiment.Name.x!="160721" & CrossingPoint_H.x>=38) %>%
  filter(is.na(Experiment.Name.y)) %>%
  select(SampleName.x,Expe_Analysis_Name.x,CrossingPoint_A.x,CrossingPoint_B.x,CrossingPoint_C.x,
         CrossingPoint_F.x,CrossingPoint_G.x,CrossingPoint_H.x) %>%
  mutate(`F<35 & G<35`=ifelse(CrossingPoint_F.x<35 & CrossingPoint_G.x< 35,1,0),
         `F<35 & 35=<G<38`= ifelse(CrossingPoint_F.x<35 & CrossingPoint_G.x< 38 &
                                    CrossingPoint_G.x>=35,1,0),
         `35=<F<38 & G<35`= ifelse(CrossingPoint_F.x< 38 &
                                    CrossingPoint_F.x>=35 &
                                    CrossingPoint_G.x<35,1,0),
         `35=<F<38 & 35=<G<38`= ifelse(CrossingPoint_F.x<38 & 
                                       CrossingPoint_F.x>=35 &
                                       CrossingPoint_G.x< 38 &
                                       CrossingPoint_G.x>=35,1,0),
         `F<35 & G>=38`=ifelse(CrossingPoint_F.x<35 & CrossingPoint_G.x>=38,1,0),
         `F>=38 & G<35`=ifelse(CrossingPoint_F.x>=38 & CrossingPoint_G.x< 35,1,0),
         `F>=38 & 35=<G<38`= ifelse(CrossingPoint_F.x>=38 & CrossingPoint_G.x< 38 &
                                    CrossingPoint_G.x>=35,1,0),
         `35=<F<38 & G>=38`= ifelse(CrossingPoint_F.x< 38 &
                                    CrossingPoint_F.x>=35 &
                                    CrossingPoint_G.x>=38,1,0),
         `F>=38 & G>=38`=ifelse(CrossingPoint_F.x>=38 & CrossingPoint_G.x>=38,1,0))%>%
  dplyr::summarise(Samples="analyzed once with 1st alb PCR>=38",
                   total=n(),
                   `F<35 & G<35`=sum(`F<35 & G<35`),
                   `F<35 & 35=<G<38`=sum(`F<35 & 35=<G<38`),
                   `35=<F<38 & G<35`=sum(`35=<F<38 & G<35`),
                   `35=<F<38 & 35=<G<38`=sum(`35=<F<38 & 35=<G<38`),
                   `F<35 & G>=38`=sum(`F<35 & G>=38`),
                   `F>=38 & G<35`=sum(`F>=38 & G<35`),
                   `F>=38 & 35=<G<38`=sum(`F>=38 & 35=<G<38`),
                   `35=<F<38 & G>=38`=sum(`35=<F<38 & G>=38`),
                   `F>=38 & G>=38`=sum(`F>=38 & G>=38`)) -> qq1

#Summarising count of features of inhibition controls of samples analyzed once with 1st alb PCR<38
toxo %>%
  filter(Experiment.Name.x!="160721" & CrossingPoint_H.x<38) %>%
  filter(is.na(Experiment.Name.y)) %>%
  select(SampleName.x,Expe_Analysis_Name.x,CrossingPoint_A.x,CrossingPoint_B.x,CrossingPoint_C.x,
         CrossingPoint_F.x,CrossingPoint_G.x,CrossingPoint_H.x) %>%
  mutate(`F<35 & G<35`=ifelse(CrossingPoint_F.x<35 & CrossingPoint_G.x< 35,1,0),
         `F<35 & 35=<G<38`= ifelse(CrossingPoint_F.x<35 & CrossingPoint_G.x< 38 &
                                    CrossingPoint_G.x>=35,1,0),
         `35=<F<38 & G<35`= ifelse(CrossingPoint_F.x< 38 &
                                    CrossingPoint_F.x>=35 &
                                    CrossingPoint_G.x<35,1,0),
         `35=<F<38 & 35=<G<38`= ifelse(CrossingPoint_F.x<38 & 
                                       CrossingPoint_F.x>=35 &
                                       CrossingPoint_G.x< 38 &
                                       CrossingPoint_G.x>=35,1,0),
         `F<35 & G>=38`=ifelse(CrossingPoint_F.x<35 & CrossingPoint_G.x>=38,1,0),
         `F>=38 & G<35`=ifelse(CrossingPoint_F.x>=38 & CrossingPoint_G.x< 35,1,0),
         `F>=38 & 35=<G<38`= ifelse(CrossingPoint_F.x>=38 & CrossingPoint_G.x< 38 &
                                    CrossingPoint_G.x>=35,1,0),
         `35=<F<38 & G>=38`= ifelse(CrossingPoint_F.x< 38 &
                                    CrossingPoint_F.x>=35 &
                                    CrossingPoint_G.x>=38,1,0),
         `F>=38 & G>=38`=ifelse(CrossingPoint_F.x>=38 & CrossingPoint_G.x>=38,1,0))%>%
  dplyr::summarise(Samples="analyzed once with 1st alb PCR<38",
                   total=n(),
                   `F<35 & G<35`=sum(`F<35 & G<35`),
                   `F<35 & 35=<G<38`=sum(`F<35 & 35=<G<38`),
                   `35=<F<38 & G<35`=sum(`35=<F<38 & G<35`),
                   `35=<F<38 & 35=<G<38`=sum(`35=<F<38 & 35=<G<38`),
                   `F<35 & G>=38`=sum(`F<35 & G>=38`),
                   `F>=38 & G<35`=sum(`F>=38 & G<35`),
                   `F>=38 & 35=<G<38`=sum(`F>=38 & 35=<G<38`),
                   `35=<F<38 & G>=38`=sum(`35=<F<38 & G>=38`),
                   `F>=38 & G>=38`=sum(`F>=38 & G>=38`)) -> qq2

#Grouping them into only one table
dplyr::union(pp1,pp2) %>%
  dplyr::union(qq1) %>%
  dplyr::union(qq2) %>% kable()
```

\
  

###Flow chart

A flow chart summarising data managing and motives of control for samples analyzed twice was built
using DiagrammeR library. The following code permits to build it in RStudio or from Rmarkdown knited to html but could not be executed when knited to Word.
```{r tg_flow_chart,eval=F,echo=F}
library(DiagrammeR)
#Calculation of number of samples excluded owing to no bio clinical data in DxLab
c2_1<-dplyr::left_join(inhtox4,dxtox,by="SampleName_m") %>%
  mutate(fusion=paste(SampleName.x,Matrix,sep="_")) %>%
  filter(fusion!="349 3365LA_Placenta" & fusion!="3 493 365_Liquide amniotique") %>%
  filter(!is.na(Matrix) & !is.na(Info_patient)) %>% nrow()
c2_2<-dplyr::left_join(inhtox4,dxtox,by="SampleName_m") %>%
  mutate(fusion=paste(SampleName.x,Matrix,sep="_")) %>%
  filter(fusion!="349 3365LA_Placenta" & fusion!="3 493 365_Liquide amniotique") %>%
  filter(is.na(Matrix) & is.na(Info_patient)) %>% nrow()
#Code for this box:paste0(c2_2,' samples excluded:\\n ',' one external quality assessment\\n ','one cancelled analysis')

#Calculation of number of samples analyzed twice
c5_1<-toxo %>% filter(!is.na(Experiment.Name.y) &
                        Experiment.Name.x!=160721) %>% nrow()
#Calculation of number of samples analyzed twice owing to negative value of positive plate control the 1st time                       
c5_2<-toxo %>% filter(Experiment.Name.x==160721) %>% nrow()


#Calculation of number of sample per subgroup of samples analyzed twice
#Samples with both IC>38 and albu<38
c6_1<-toxo %>% filter(!is.na(Experiment.Name.y) &
                        Experiment.Name.x!=160721 &
                        CrossingPoint_F.x>38 &
                        CrossingPoint_G.x>38 &
                        CrossingPoint_H.x<38) %>% nrow()
#Code for this box:paste0(c6_1,' samples analyzed twice\\n ','with both inhibition\\n ','controls >38\\n ','and albumin PCR <38')

#Samples with albu>=38 and at least one IC<38
c6_2<-toxo %>% filter(!is.na(Experiment.Name.y) &
                        Experiment.Name.x!=160721 &
                        CrossingPoint_H.x>=38) %>%
  filter(CrossingPoint_F.x<38 | CrossingPoint_G.x<38) %>% nrow()
#Code for this box:paste0(c6_2,' samples analyzed twice\\n ','with albumin PCR >38')

#Samples with both IC>38 and albu<=38
c6_3<-toxo %>% filter(!is.na(Experiment.Name.y) &
                        Experiment.Name.x!=160721 &
                        CrossingPoint_F.x>38 &
                        CrossingPoint_G.x>38 &
                        CrossingPoint_H.x>=38) %>% nrow()
#Code for this box:paste0(c6_3,' samples analyzed twice\\n ','with albumin PCR >38\\n ','and inhibition controls >38')

#Samples with 28<albu<38 and at least one IC<38
c6_4<-toxo %>% filter(!is.na(Experiment.Name.y) &
                        Experiment.Name.x!=160721 &
                        CrossingPoint_F.x<38 &
                        CrossingPoint_G.x<38 &
                        CrossingPoint_H.x>=28 &
                        CrossingPoint_H.x<38) %>% nrow()
#Code for this box:paste0(c6_4,' samples analyzed twice\\n ','with albumin PCR between 28 and 38\\n ','and inhibition controls >38')

#Sample analyzed twice due to previous inhibition for this patient
c6_5<-toxo %>% filter(SampleName_m==621711) %>% nrow()
#Code for this box:paste0(c6_5,' sample analyzed twice\\n ','owing to previous inhibition\\n ','for this patient')

#Samples controlled undiluted, so to exclude to analysis of diluted extracts
c6_6<-toxo %>% filter(SampleName_m %in% c(830627,2560683,2992839)) %>% nrow()
#Code for this box:paste0(c6_6,' samples\\n ','controlled undiluted')

#Sample without any argument found
c6_7<-toxo %>% filter(SampleName_m==1873394) %>% nrow()
#Code for this box:paste0(c6_7,' sample analyzed twice\\n ','with no reliable argument')

#Building the chart flow
grViz("
digraph a_nice_graph {
graph [layout = dot,rankdir = TB]
node [fontname = Arial,shape=squarel]
a [label = '@@1']
b [label = '@@2']
node [fontname = Arial,shape=square]
c [label = '@@3-1']
c2[label = '@@3-2']
node [fontname = Arial,shape=square]
d [label = '@@4-1']
e [label = '@@4-2']
e2 [label = '@@4-3']
e3 [label = '@@4-4']
e4 [label = '@@4-5']
node [fontname = Arial,shape=square]
f [label = '@@5-1']
g [label = '@@5-2']
node [fontname = Arial]
h [label = '@@6-1']
i [label = '@@6-2']
j [label = '@@6-3']
k [label = '@@6-4']
l [label = '@@6-5']
m [label = '@@6-6']
n [label = '@@6-7']
a-> b
b->{c,c2}
c->{d,e}
e->{e2,e3,e4}
d->{f,g}
f->{h,i,j,k,l,m,n}
}
[1]: paste0('Automated extraction from LC software:\\n',nrow(inhtox),' PCR results')
[2]: paste0('Preliminary data cleaning:\\n',nrow(inhtox2),' PCR results')
[3]: c(paste0('Tidying into dataframe\\n','with one row per sample:\\n',c2_1,' samples'),paste0(c2_2,' samples excluded:\\n ',' one external quality assessment\\n ','one cancelled analysis'))
[4]: c(paste0(toxo %>% filter(!is.na(Experiment.Name.y)) %>% nrow(),' samples\\n ','analyzed twice'),paste0(toxo %>% filter(is.na(Experiment.Name.y)) %>% nrow(),' samples\\n ','analyzed once'),paste0(toxo %>% filter(is.na(Experiment.Name.y) & CrossingPoint_H.x>=38) %>% nrow(),' positive sample\\n ','analyzed once with\\n ','albumin PCR >38'),paste0(toxo %>% filter(is.na(Experiment.Name.y) & CrossingPoint_H.x>=28 & CrossingPoint_H.x<38) %>% nrow(),' positive samples\\n ','analyzed once with\\n ','albumin PCR\\n ','between 28 and 38'),paste0(toxo %>% filter(is.na(Experiment.Name.y) & CrossingPoint_F.x>38 & CrossingPoint_G.x>38) %>% nrow(),' samples\\n ','analyzed once\\n ','with both inhibition\\n ','controls >38'))
[5]: c(paste0(c5_1,' samples analyzed twice\\n ','owing to inhibition and/or\\n ','extraction concerns'),paste0(c5_2,' samples analyzed twice\\n ','owing to negative value of\\n ','positive plate control'))
[6]: c(paste0(c6_1,' samples analyzed twice\\n ','with both inhibition\\n ','controls >38\\n ','and albumin PCR <38'),paste0(c6_2,' samples analyzed twice\\n ','with albumin PCR >38'),paste0(c6_3,' samples analyzed twice\\n ','with albumin PCR >38\\n ','and inhibition controls >38'),paste0(c6_4,' samples analyzed twice\\n ','with albumin PCR\\n ','between 28 and 38\\n ','and inhibition controls <38'),paste0(c6_5,' sample analyzed twice\\n ','owing to previous inhibition\\n ','for this patient'),paste0(c6_6,' samples\\n ','    controlled undiluted    '),paste0(c6_7,' sample analyzed twice\\n ','with no reliable argument'))
")
```

\
  

###Samples analyzed twice

**`r toxo %>% filter(Experiment.Name.x=="160721") %>% nrow()` Samples of the 07-21-2016 (Experiment.Name.x 160721) were excluded** of this summary because they were analyzed twice owing to a negative Cp of the plate positive control. 

The other samples analysed twice corresponded to **`r toxo%>%filter(!is.na(Experiment.Name.y)& Experiment.Name.x!="160721")%>%nrow()` different samples**, detailled below.

\
  

####Table of samples analyzed twice

The following code chunk permits to obtain the complete list;
```{r twice,eval=T,echo=T}
toxo %>%
  filter(!is.na(Experiment.Name.y)& Experiment.Name.x!="160721" & !SampleName_m %in% c("830627","2560683","2992839")) %>% 
  select(1,5,9,15,21,27,33,39) %>% kable(digits=1)
```

\
  

####Table summarising matrix of samples analyzed twice

```{r twice_matrix}
toxo %>%
  filter(!is.na(Experiment.Name.y)& Experiment.Name.x!="160721" & !SampleName_m %in% c("830627","2560683","2992839"))  %>%
  filter(!is.na(Matrix)) %>%
  mutate(gglion=ifelse(str_detect(Info_patient,"ganglionnaire")|
                         str_detect(Info_patient,"adénopathie"),1,0),
         retine=ifelse(str_detect(Info_patient,"rétinienne"),1,0),
         cereb=ifelse(str_detect(Info_patient,"cérébral"),1,0),
         hepat=ifelse(str_detect(Info_patient,"hépatique"),1,0),
         card=ifelse(str_detect(Info_patient,"péricardique"),1,0),
         pleural=ifelse(str_detect(Info_patient,"pleural"),1,0),
         mo=ifelse(str_detect(Info_patient,"moelle osseuse"),1,0),
         la=ifelse(str_detect(Matrix,"Liquide amniotique"),1,0),
         lcr=ifelse(str_detect(Matrix,"LCR"),1,0),
         lba=ifelse(str_detect(Matrix,"bronchiolo-alvéolaire"),1,0),
         placenta=ifelse(str_detect(Matrix,"Placenta"),1,0),
         ascite=ifelse(str_detect(Info_patient,"ascite"),1,0),
         cordon=ifelse(str_detect(Matrix,"cordon") &
                         str_detect(Info_patient,"N/A"),1,0),
         sang=ifelse(str_detect(Matrix,"Sang veineux") &
                       str_detect(Info_patient,"N/A"),1,0),
         ha=ifelse(str_detect(Matrix,"Humeur aqueuse"),1,0)) %>%
  transform(sang=ifelse(str_detect(Matrix,"Sang veineux") &
                          str_detect(Info_patient,"Humeur aqueuse"),sang+0.5,sang),
            ha=ifelse(str_detect(Info_patient,"Humeur aqueuse"),ha+0.5,ha)) %>%
  dplyr::summarise(Samples="total",
                   Blood=sum(sang),
                   `Bone marrow`=sum(mo),
                   CSF=sum(lcr),
                   AF=sum(la),
                   `Cord blood`=sum(cordon),
                   Placenta=sum(placenta),
                   BAL=sum(lba),
                   `Lymph node`=sum(gglion),
                   Retina=sum(retine),
                   `Cerebral biopsy`=sum(cereb),
                   `Hepatic biopsy`=sum(hepat),
                   `Pericardic fluid`=sum(card),
                   `Pleural fluid`=sum(pleural),
                   `Ascites`=sum(ascite),
                   `Aqueous humor`=sum(ha))->t01

toxo %>%
  filter(!is.na(Experiment.Name.y)& Experiment.Name.x!="160721" & !SampleName_m %in% c("830627","2560683","2992839")) %>%
  filter(!is.na(Matrix)) %>%
  mutate(gglion=ifelse(str_detect(Info_patient,"ganglionnaire")|
                         str_detect(Info_patient,"adénopathie"),1,0),
         retine=ifelse(str_detect(Info_patient,"rétinienne"),1,0),
         cereb=ifelse(str_detect(Info_patient,"cérébral"),1,0),
         hepat=ifelse(str_detect(Info_patient,"hépatique"),1,0),
         card=ifelse(str_detect(Info_patient,"péricardique"),1,0),
         pleural=ifelse(str_detect(Info_patient,"pleural"),1,0),
         mo=ifelse(str_detect(Info_patient,"moelle osseuse"),1,0),
         la=ifelse(str_detect(Matrix,"Liquide amniotique"),1,0),
         lcr=ifelse(str_detect(Matrix,"LCR"),1,0),
         lba=ifelse(str_detect(Matrix,"bronchiolo-alvéolaire"),1,0),
         placenta=ifelse(str_detect(Matrix,"Placenta"),1,0),
         ascite=ifelse(str_detect(Info_patient,"ascite"),1,0),
         cordon=ifelse(str_detect(Matrix,"cordon") &
                         str_detect(Info_patient,"N/A"),1,0),
         sang=ifelse(str_detect(Matrix,"Sang veineux") &
                       str_detect(Info_patient,"N/A"),1,0),
         ha=ifelse(str_detect(Matrix,"Humeur aqueuse"),1,0)) %>%
  transform(sang=ifelse(str_detect(Matrix,"Sang veineux") &
                          str_detect(Info_patient,"Humeur aqueuse"),sang+0.5,sang),
            ha=ifelse(str_detect(Info_patient,"Humeur aqueuse"),ha+0.5,ha)) %>%
  dplyr::summarise(Samples="analyzed twice",
                   Blood=sum(sang),
                   `Bone marrow`=sum(mo),
                   CSF=sum(lcr),
                   AF=sum(la),
                   `Cord blood`=sum(cordon),
                   Placenta=sum(placenta),
                   BAL=sum(lba),
                   `Lymph node`=sum(gglion),
                   Retina=sum(retine),
                   `Cerebral biopsy`=sum(cereb),
                   `Hepatic biopsy`=sum(hepat),
                   `Pericardic fluid`=sum(card),
                   `Pleural fluid`=sum(pleural),
                   `Ascites`=sum(ascite),
                   `Aqueous humor`=sum(ha)) -> t02
bind_rows(t02,t01) %>% kable()
```

\
  

####Summary of arguments justifying control for controlled samples

```{r sum_twice_args}
toxo %>%
  filter(Experiment.Name.x!="160721" & !is.na(PlateName.y)) %>%
  mutate(twoCp38=ifelse(CrossingPoint_F.x>=38 & CrossingPoint_G.x>=38 & CrossingPoint_H.x<38,1,0),
         albsup38=ifelse(CrossingPoint_H.x>=38 & (CrossingPoint_F.x<38 | CrossingPoint_G.x<38),1,0),
         Cpalbsup38=ifelse(CrossingPoint_F.x>=38 & CrossingPoint_G.x>=38 & CrossingPoint_H.x>=38,1,0),
         albsup28nonpauci=ifelse(SampleName_m %in% c("2021903","1731852","2423686"),1,0),
         albsup28pauci=ifelse(SampleName_m %in% c("2141608"),1,0),
         unjustified=ifelse(SampleName_m %in% c("1873394"),1,0),
         undiluted=ifelse(SampleName_m %in% c("830627","2560683","2992839"),1,0),
         Ant_inh=ifelse(SampleName_m %in% c("621711"),1,0)) %>%
  summarise(total=n(),
            `Two inhibitors controls >= 38`= sum(twoCp38),
            `albumin PCR > 38`= sum(albsup38),
            Both= sum(Cpalbsup38),
            `albumin PCR > 28 for paucicellular samples`= sum(albsup28pauci),
            `albumin PCR > 28 for non paucicellular samples`= sum(albsup28nonpauci),
            `Control of undiluted extract`= sum(undiluted),
            `Previous sample inhibited for this patient`=sum(Ant_inh),
            `Unjustified control`=sum(unjustified)) %>% kable()

```

\
  

####Summary of arguments justifying control per matrix class

We excluded from this summary **the `r toxo %>%filter(SampleName_m %in% c(830627,2560683,2992839)) %>% nrow()` samples** controlled undiluted.

```{r sum_twice_args_matrix}
toxo %>%
  filter(Experiment.Name.x!="160721" & !is.na(PlateName.y) &
        !SampleName_m %in% c(830627,2560683,2992839)) %>%
  mutate(gglion=ifelse(str_detect(Info_patient,"ganglionnaire")|
                         str_detect(Info_patient,"adénopathie"),"LN",""),
         retine=ifelse(str_detect(Info_patient,"rétinienne"),"retina",""),
         cereb=ifelse(str_detect(Info_patient,"cérébra"),"Cen",""),
         hepat=ifelse(str_detect(Info_patient,"hépatique"),"HeB",""),
         card=ifelse(str_detect(Info_patient,"péricardique"),"CaB",""),
         pleural=ifelse(str_detect(Info_patient,"pleural"),"pleural",""),
         mo=ifelse(str_detect(Info_patient,"Moelle osseuse"),"BM",""),
         la=ifelse(str_detect(Matrix,"Liquide amniotique"),"AF",""),
         lcr=ifelse(str_detect(Matrix,"LCR"),"lcr",""),
         lba=ifelse(str_detect(Matrix,"bronchiolo-alvéolaire"),"BAL",""),
         placenta=ifelse(str_detect(Matrix,"Placenta"),"placenta",""),
         ascite=ifelse(str_detect(Info_patient,"ascite"),"ascite",""),
         cordon=ifelse(str_detect(Matrix,"cordon"),"CB",""),
         sang=ifelse(str_detect(Matrix,"Sang veineux") &
                       str_detect(Info_patient,"N/A"),"blood",""),
         ha=ifelse(str_detect(Matrix,"Humeur aqueuse") |
                     str_detect(Info_patient,"Humeur aqueuse") ,"AH","")) %>%
  mutate(matrix_class=paste0(gglion,retine,cereb,hepat,card,
                              pleural,mo,la,lcr,lba,placenta,
                              ascite,cordon,sang,ha),
  twoCp38=ifelse(CrossingPoint_F.x>=38 & CrossingPoint_G.x>=38 & CrossingPoint_H.x<38,"alb<38; 2 IC>=38",""),
         albsup38=ifelse(CrossingPoint_H.x>=38 & 
                           (CrossingPoint_F.x<38 | CrossingPoint_G.x<38),"alb>38; IC<38",""),
         Cpalbsup38=ifelse(CrossingPoint_F.x>38 & CrossingPoint_G.x>38 &
                             CrossingPoint_H.x>=38,"alb>38; IC>=38",""),
         albsup28nonpauci=ifelse(SampleName_m %in% c("2021903","1731852","2423686"),
                                 "alb>28 cell rich",""),
         albsup28pauci=ifelse(SampleName_m %in% c("2141608"),"alb>28 cell poor",""),
         unjustified=ifelse(SampleName_m %in% c("1873394"),"unjustified",""),
         Ant_inh=ifelse(SampleName_m %in% c("621711"),"Ant inh","")) %>%
  mutate(motive=paste0(twoCp38,albsup38,Cpalbsup38,
                       albsup28nonpauci,albsup28pauci,unjustified,Ant_inh)) %>%
  select(SampleName_m,9,15,21,27,33,39,46,52,Matrix,Info_patient,matrix_class,motive) %>%
  group_by(matrix_class,motive) %>%
  summarise(N=n()) %>%
  spread(motive,N)-> tgmm
tgmm[is.na(tgmm)]<-0
kable(tgmm)
```

\
  

####Tables summarising inhibited samples

Inhibited samples were defined by two inhibition control Cp over 38.

```{r table_twice_tg}
toxo %>%
  filter(!is.na(Matrix)) %>%
  mutate(gglion=ifelse(str_detect(Info_patient,"ganglionnaire")|
                         str_detect(Info_patient,"adénopathie"),1,0),
         retine=ifelse(str_detect(Info_patient,"rétinienne"),1,0),
         cereb=ifelse(str_detect(Info_patient,"cérébra"),1,0),
         hepat=ifelse(str_detect(Info_patient,"hépatique"),1,0),
         card=ifelse(str_detect(Info_patient,"péricardique"),1,0),
         pleural=ifelse(str_detect(Info_patient,"pleural"),1,0),
         mo=ifelse(str_detect(Info_patient,"Moelle osseuse"),1,0),
         la=ifelse(str_detect(Matrix,"Liquide amniotique"),1,0),
         lcr=ifelse(str_detect(Matrix,"LCR"),1,0),
         lba=ifelse(str_detect(Matrix,"bronchiolo-alvéolaire"),1,0),
         placenta=ifelse(str_detect(Matrix,"Placenta"),1,0),
         ascite=ifelse(str_detect(Info_patient,"ascite"),1,0),
         cordon=ifelse(str_detect(Matrix,"cordon"),1,0),
         sang=ifelse(str_detect(Matrix,"Sang veineux") &
                       str_detect(Info_patient,"N/A"),1,0),
         ha=ifelse(str_detect(Matrix,"Humeur aqueuse") |
         str_detect(Info_patient,"Humeur aqueuse") ,1,0),
         inh=ifelse(CrossingPoint_F.x>=38 &
                    CrossingPoint_G.x>=38,"inhibited","not inh")) %>%
  transform(sang=ifelse(str_detect(Matrix,"Sang veineux") &
                          str_detect(Info_patient,"Humeur aqueuse"),0.5,sang),
            ha=ifelse(str_detect(Info_patient,"Humeur aqueuse"),0.5,ha)) %>%
  group_by(inh) %>%
  dplyr::summarise(Samples="all",
            Total=n(),
            Blood=sum(sang),
            `Bone marrow`=sum(mo),
            CSF=sum(lcr),
             AF=sum(la),
            `Cord blood`=sum(cordon),
            Placenta=sum(placenta),
            BAL=sum(lba),
            `Lymph node`=sum(gglion),
            Retina=sum(retine),
            `Cerebral biopsy`=sum(cereb),
            `Hepatic biopsy`=sum(hepat),
            `Pericardic fluid`=sum(card),
            `Pleural fluid`=sum(pleural),
            `Ascites`=sum(ascite),
             `Aqueous humor`=sum(ha)) %>% kable()
```

\
We also observed if dilution restore PCR efficiency by come back of at least one inhibition control under 38:

```{r table_inh-restaurate}
toxo %>%
  filter(CrossingPoint_F.x>38 & CrossingPoint_G.x>38) %>%
  mutate(`Effect of 1/10 dilution on efficiency`=ifelse(CrossingPoint_F.y>38 & CrossingPoint_G.y>=38,"inhibition persistence","efficiency restoration")) %>%
  group_by(`Effect of 1/10 dilution on efficiency`) %>%
  summarise(`N(samples)`=n()) %>%
  kable()
```

\
Only the following sample did not have efficiency restoration by 1/10th dilution for *Toxoplasma* PCR:

```{r table_inh_persist}
toxo %>%
  filter(CrossingPoint_F.x>38 & CrossingPoint_G.x>38 &
           CrossingPoint_F.y>38 & CrossingPoint_G.y>=38) %>%
  select(1,5,57,129) %>% 
  kable()
```

\
  

###Samples analyzed once

####Table of samples analyzed once with 2 Cp>38 for inhibition controls

```{r once_CI}
toxo %>%
  filter(is.na(SampleName.y) &
           CrossingPoint_F.x>38 &
           CrossingPoint_G.x>38) %>%
  select(1,5,39,42,57,129) %>% kable()
```

\
  

####Table of samples analyzed once with Cp>=38 for albumin PCR

```{r once_alb}
toxo %>%
  filter( Experiment.Name.x!="160721" & CrossingPoint_H.x>=38) %>%
  filter(is.na(Experiment.Name.y)) %>%
  select(1,5,39,42,57,129) %>% kable()
```

The sample 2151856 was analysed only once because it was a positive amniotic fluid and did not need to control PCR inhibition.  

\
  

####Summary of samples analyzed once with 37 < Cp < 38 for controls

```{r once_37}
toxo %>%
  filter(Experiment.Name.x!="160721") %>%
  mutate(twoCp37=ifelse(CrossingPoint_F.x>=37 & CrossingPoint_F.x<38 &
                          CrossingPoint_G.x>=37 & CrossingPoint_G.x<38 &
                          CrossingPoint_H.x<38,1,0),
         albsup37=ifelse(CrossingPoint_H.x>37 & CrossingPoint_H.x<=38 &
                           (CrossingPoint_F.x<38 | CrossingPoint_G.x<38),1,0),
         Cpalbsup37=ifelse(CrossingPoint_F.x>=37 & CrossingPoint_F.x<38 &
                             CrossingPoint_G.x>=37 & CrossingPoint_G.x<38 & 
                             CrossingPoint_H.x>37 & CrossingPoint_H.x<38,1,0)) %>%
  select(1,5,129,130,140:142) %>%
  summarise(total=n(),
            `Two inhibitors controls between 37 and 38`= sum(twoCp37),
            `albumin PCR between 37 and 38`= sum(albsup37),
            Both= sum(Cpalbsup37)) %>% kable()
```

\
  

####Summary of samples analyzed once with 36 < Cp < 37 for controls

```{r once_36}
toxo %>%
  filter(Experiment.Name.x!="160721") %>%
  mutate(twoCp36=ifelse(CrossingPoint_F.x>=36 & CrossingPoint_F.x<37 &
                          CrossingPoint_G.x>=36 & CrossingPoint_G.x<37 &
                          CrossingPoint_H.x<=37,1,0),
         albsup36=ifelse(CrossingPoint_H.x>36 & CrossingPoint_H.x<=37 &
                           (CrossingPoint_F.x<37 | CrossingPoint_G.x<37),1,0),
         Cpalbsup36=ifelse(CrossingPoint_F.x>=36 & CrossingPoint_F.x<37 &
                             CrossingPoint_G.x>=36 & CrossingPoint_G.x<37 & 
                             CrossingPoint_H.x>36 & CrossingPoint_H.x<=37,1,0)) %>%
  select(1,5,129,130,140:142) %>%
  summarise(total=n(),
            `Two inhibitors controls between 36 and 37`= sum(twoCp36),
            `albumin PCR between 36 and 37`= sum(albsup36),
            Both= sum(Cpalbsup36)) %>% kable()
```

\
  

###Comparative analysis of results of pure and diluted extracts

Since inhibition controls were analyzed twice per sample and per run, we calculated an average value based on the following criterias:

* Calculation of Cp mean for overall cases

* If one or two Cp were uncertain or negative (*i.e.* value of 45 or 55 respectively), average Cp was the lower Cp

\
  

####Results of albumin PCR and inhibition control in the case of 2 inhibition controls > 38 for undiluted extracts

```{r IC38_alb}
toxo %>%
  filter( CrossingPoint_F.x>38 &  CrossingPoint_G.x>38 &
          !SampleName_m %in% c(830627,2560683,2992839)) %>%
  mutate(ax=ifelse(CrossingPoint_F.x==45 & CrossingPoint_G.x==55,45,0),
         bx=ifelse(CrossingPoint_F.x==55 & CrossingPoint_G.x==45,45,0),
         cx=ifelse(CrossingPoint_F.x==45 & CrossingPoint_G.x==45,45,0),
         dx=ifelse(CrossingPoint_F.x==55 & CrossingPoint_G.x==55,55,0),
         ex=ifelse(CrossingPoint_F.x %in% c(45,55) & !CrossingPoint_G.x %in% c(45,55),
                   CrossingPoint_G.x,0),
         fx=ifelse(!CrossingPoint_F.x %in% c(45,55) & CrossingPoint_G.x %in% c(45,55),
                   CrossingPoint_F.x,0),
         gx=ifelse(!CrossingPoint_F.x %in% c(45,55) & !CrossingPoint_G.x %in% c(45,55),
                   (CrossingPoint_F.x+CrossingPoint_G.x)/2,0)) %>%
  mutate(IT=ax+bx+cx+dx+ex+fx+gx,
         a20=ifelse(CrossingPoint_H.x<20,1,0),
         a20_25=ifelse(CrossingPoint_H.x>=20 &
                         CrossingPoint_H.x<25,1,0),
         a25_30=ifelse(CrossingPoint_H.x>=25 &
                         CrossingPoint_H.x<30,1,0),
         a30_35=ifelse(CrossingPoint_H.x>=30 &
                         CrossingPoint_H.x<35,1,0),
         a35_40=ifelse(CrossingPoint_H.x>=35 &
                         CrossingPoint_H.x<40,1,0),
         a40=ifelse(CrossingPoint_H.x>=40,1,0)) %>%
  summarise(`both inhibition controls > 38`= n(),
            `albumin PCR < 20 `= sum(a20),
            `albumin PCR >= 20 and < 25 `= sum(a20_25),
            `albumin PCR >= 25 and < 30 `= sum(a25_30),
            `albumin PCR >= 30 and < 35 `= sum(a30_35),
            `albumin PCR >= 35 and < 40 `= sum(a35_40),
            `albumin PCR >= 40 `= sum(a40)) %>%
  kable(digits=1)
```

\
We next interested on matrix of inhibited samples of the tables just above with albumin PCR < 28:

```{r IC38_alb_matrix}
toxo %>%
  filter( CrossingPoint_F.x>38 &
          CrossingPoint_G.x>38 &
          CrossingPoint_H.x<28 &
          !SampleName_m %in% c(830627,2560683,2992839)) %>%
  group_by(Matrix) %>%
  summarise(`number inhibited`=n()) %>%
  kable()

print("  ")

toxo %>%
  filter( CrossingPoint_F.x>38 &
            CrossingPoint_G.x>38 &
            CrossingPoint_H.x<30 &
            Matrix!="Sang veineux" &
          !SampleName_m %in% c(830627,2560683,2992839)) %>%
  select(5,129,130) %>%
  kable()
```

\
  

####Results of albumin PCR and inhibition control in the case of albumin PCR > 38 for undiluted extracts

```{r alb38_IC}
toxo %>%
  filter(CrossingPoint_H.x>=38 &
          !SampleName_m %in% c(830627,2560683,2992839)) %>%
  mutate(ax=ifelse(CrossingPoint_F.x==45 & CrossingPoint_G.x==55,45,0),
         bx=ifelse(CrossingPoint_F.x==55 & CrossingPoint_G.x==45,45,0),
         cx=ifelse(CrossingPoint_F.x==45 & CrossingPoint_G.x==45,45,0),
         dx=ifelse(CrossingPoint_F.x==55 & CrossingPoint_G.x==55,55,0),
         ex=ifelse(CrossingPoint_F.x %in% c(45,55) & !CrossingPoint_G.x %in% c(45,55),
                   CrossingPoint_G.x,0),
         fx=ifelse(!CrossingPoint_F.x %in% c(45,55) & CrossingPoint_G.x %in% c(45,55),
                   CrossingPoint_F.x,0),
         gx=ifelse(!CrossingPoint_F.x %in% c(45,55) & !CrossingPoint_G.x %in% c(45,55),
                   (CrossingPoint_F.x+CrossingPoint_G.x)/2,0)) %>%
  mutate(`Average Cp of inhibition control`=ax+bx+cx+dx+ex+fx+gx) %>%
  select(5,129,39,147) %>%
  rename(`Cp of albumin PCR`=CrossingPoint_H.x) %>%
  arrange(Matrix) %>%
  kable(digits=1)
```
  
\


####Summary of delta Cp of PCR albumin

```{r alb_table_tg}
toxo %>%
  filter(!is.na(Experiment.Name.y)) %>%
  mutate( AC=ifelse(CrossingPoint_F.x>38 & CrossingPoint_G.x>38, "inhibited","not inh"),
          Cp_Albu=ifelse(CrossingPoint_H.x<38 & CrossingPoint_H.x>=28 , "28_38","other"),
          Cp_Albu_diluted=ifelse(CrossingPoint_H.y<38 & CrossingPoint_H.y>=28 , "28_38","other"),
          delta_albu=ifelse(CrossingPoint_H.y-CrossingPoint_H.x>3, ">3", "1_3")) %>%
  transform( Cp_Albu=ifelse(Cp_Albu=="other" & CrossingPoint_H.x>=38, ">=38",Cp_Albu),
             Cp_Albu_diluted=ifelse(Cp_Albu_diluted=="other" & CrossingPoint_H.y>=38,
                                 ">=38",Cp_Albu_diluted),
             delta_albu=ifelse(CrossingPoint_H.y-CrossingPoint_H.x<1, "<1",delta_albu)) %>%
  transform( Cp_Albu=ifelse(Cp_Albu=="other" & CrossingPoint_H.x<28, "<28",Cp_Albu),
             Cp_Albu_diluted=ifelse(Cp_Albu_diluted=="other" & CrossingPoint_H.y<28, "<28",Cp_Albu_diluted)) %>%
  group_by(AC,Cp_Albu, Cp_Albu_diluted, delta_albu) %>%
  summarise(Nuber=n()) %>% kable()
```

\


Ac (amplification control) was defined as inhibited if Cp>38 for both wells.
PCR of albumin of undiluted (Cp_Albu) and undiluted extracts (Cp_albu_diluted) were classified regarding Cp value.
Delta Cp of PCR albumin was determined by Cp(diluted)-Cp(undiluted), so:

* delta_albu>3 corresponded to absence of inhibition of PCR albumine

* delta_albu<1 corresponded to presence of inhibition of PCR albumine

* 1<=delta_albu<=3 corresponded to a gray zone 

  
\



##Statistical inductions

###Comparison of sensitivity and specificity to detect PCR inhibitors

The inhibition control was considered as the gold standard for inhibition.Inhibition control was considered as inhibited if both wells had Cp > 38 for one sample.albumin PCR was considered as potentially inhibited if Cp > 28. We classified each sample as inhibited or not inhibited and calculated sensitivity and specificity of inhibition detection for albumin PCR. 
The inhibition control was considered as the gold standard for inhibition.Inhibition control was considered as inhibited if both wells had Cp > 38 for one sample.We compared the sensitivity and specificity of albumin PCR to detect inhibitors to the frequency 0.95 because we defined a good inhibition screening method as a method with at least 95 % accurate detection of inhibitors. The following analysis were performed on **`r nrow(toxo)` different samples.**

\
First we defined the Cp cut-off value of albumin PCR by the Cp value with the highest Youden's index:

```{r youden_tg}
#Defining the function to calculate Youden index taking account nul sensitivity for some Cp
tgy<-function(Ct) {toxo %>%
    mutate(IC=ifelse(CrossingPoint_F.x>38 & CrossingPoint_G.x>38,"inh","ok"),
           albu28=ifelse(CrossingPoint_H.x>=Ct,"inh","ok"))%>%
    mutate(TP=ifelse(albu28=="inh" & IC=="inh",1,0),
         FP=ifelse(albu28=="inh" & IC=="ok",1,0),
         FN=ifelse(albu28=="ok" & IC=="inh",1,0),
         TN=ifelse(albu28=="ok" & IC=="ok",1,0)) %>%
  dplyr::summarise(TP=sum(TP),
                   FP=sum(FP),
                   FN=sum(FN),
                   TN=sum(TN)) %>% 
  summarise(threshold=Ct,
            Youden=TN/(TN+FP)+TP/(TP+FN)-1,
            Sen=TP/(TP+FN),
            Spe=TN/(TN+FP))-> pp
  pp$Youden
}
#Defining and priming the repeated Youden index calculation
k<-c()
Ct<-20
Cti<-20
int<-0.1
Ctfin<-45
repeat {
    append(k,tgy(Ct))->k
  Ct<-Ct+int
  if(Ct>Ctfin) break }
l<-seq(from=Cti,to=Ctfin-int,by=int)

#Summarising them in a graph
mytitle <- expression(paste(italic("Toxoplasma"), " PCR"))
ggplot()+
  geom_step(aes(x=l,y=k))+
  theme_classic(base_size=8)+
  xlab("albumin PCR Cp")+
  ylab("Youden's index")+
  coord_fixed(ratio=70)+
  ggtitle(mytitle)

#Giving the value of Cp with maximal Youden index
df<-data.frame(l,k)
df %>%
  summarise(`M`=max(k)) ->youmax
  
df %>%
  filter(k==youmax$M) %>%
rename(`Corresponding Cp`=l,`Maximal Youden index`=k) %>% kable()
```

\
In regard to low value of Youden index, we had a look of sensitivity and specificity in function of Cp cut-off value:

```{r sens_spe_tg_graph}
#Defining functions to calculate sensitivity and specificity
tgsen<-function(Ct) {toxo %>%
    mutate(IC=ifelse(CrossingPoint_F.x>38 & CrossingPoint_G.x>38,"inh","ok"),
           albu28=ifelse(CrossingPoint_H.x>=Ct,"inh","ok"))%>%
     mutate(TP=ifelse(albu28=="inh" & IC=="inh",1,0),
         FP=ifelse(albu28=="inh" & IC=="ok",1,0),
         FN=ifelse(albu28=="ok" & IC=="inh",1,0),
         TN=ifelse(albu28=="ok" & IC=="ok",1,0)) %>%
  dplyr::summarise(TP=sum(TP),
                   FP=sum(FP),
                   FN=sum(FN),
                   TN=sum(TN)) %>% 
  summarise(threshold=Ct,
            Youden=TN/(TN+FP)+TP/(TP+FN)-1,
            Sen=TP/(TP+FN),
            Spe=TN/(TN+FP))-> pp
  pp$Sen
}

tgspe<-function(Ct) {toxo %>%
    mutate(IC=ifelse(CrossingPoint_F.x>38 & CrossingPoint_G.x>38,"inh","ok"),
           albu28=ifelse(CrossingPoint_H.x>=Ct,"inh","ok"))%>%
    mutate(TP=ifelse(albu28=="inh" & IC=="inh",1,0),
           FP=ifelse(albu28=="inh" & IC=="ok",1,0),
           FN=ifelse(albu28=="ok" & IC=="inh",1,0),
           TN=ifelse(albu28=="ok" & IC=="ok",1,0)) %>%
    dplyr::summarise(TP=sum(TP),
                     FP=sum(FP),
                     FN=sum(FN),
                     TN=sum(TN)) %>% 
    summarise(threshold=Ct,
              Youden=TN/(TN+FP)+TP/(TP+FN)-1,
              Sen=TP/(TP+FN),
              Spe=TN/(TN+FP))-> pp
  pp$Spe
}

#Defining conditions for repeated sensitivity and specificity calculation
int<-0.5
Cti<-17
Ctfin<-45
Ct<-17
sensitivity<-c()

#Calulation of sensitivity and specificity for the corresponding Cp values interval
#and creation of a tibble
l<-seq(from=Cti,to=Ctfin,by=int)
repeat {
  append(sensitivity,tgsen(Ct))->sensitivity
  Ct<-Ct+int
  if(Ct>Ctfin) break }
tibble(l,sensitivity) %>%
  rename(value=sensitivity) %>%
  mutate(parameter="sensitivity") -> sen

Ct<-17
specificity<-c()
repeat {
  append(specificity,tgspe(Ct))->specificity
  Ct<-Ct+int
  if(Ct>Ctfin) break }
tibble(l,specificity) %>%
  rename(value=specificity) %>%
  mutate(parameter="specificity") -> spe

#Ploting the results
mytitle <- expression(paste(italic("Toxoplasma"), " PCR"))
bind_rows(sen,spe) %>%
  ggplot()+
  geom_step(aes(x=l,y=value,col=parameter))+
  theme_classic(base_size = 8)+
  xlab("albumin PCR Cp cut-off")+
  ylab("Sensitivity/Specificity")+
  coord_fixed(ratio=30)+
  ggtitle(mytitle)

```

\
We next calculated specificity and sensitivity to defined cut-off values and compared them to expected value of 95 %. We tested a cut-off of 36 corresponding to the highest Youden index and a cut-off of 22 corresponding to sensitivity and specificity around 40 % in our dataset.


```{r sens_spe_tg}
#Comparison of inhibited results for Toxoplasma PCR 
#Qualitative comparisons for Cp=36
toxo %>%
  mutate(IC=ifelse(CrossingPoint_F.x>38 & CrossingPoint_G.x>38,"inh","ok"),
         albu36=ifelse(CrossingPoint_H.x>=36,"inh","ok"))%>%
   mutate(TP=ifelse(albu36=="inh" & IC=="inh",1,0),
         FP=ifelse(albu36=="inh" & IC=="ok",1,0),
         FN=ifelse(albu36=="ok" & IC=="inh",1,0),
         TN=ifelse(albu36=="ok" & IC=="ok",1,0)) %>%
  dplyr::summarise(TP=sum(TP),
                   FP=sum(FP),
                   FN=sum(FN),
                   TN=sum(TN)) -> cval
  
#Summarising sensitivity and specificity values
Percentage<-c(cval$TP/(cval$TP+cval$FN)*100,cval$TN/(cval$TN+cval$FP)*100)
Parameter<-c("sensitivity (Cp 36)", "specificity (Cp 36)")
data_frame(Parameter, Percentage) %>% kable(digits=1)

print(" ")

#Comparison of sensitivity of albumin PCR to a theorical value: 0.95
psen36<-pval(stats::binom.test(x=cval$TP,n=cval$TP+cval$FN,
                             p=0.95,alternative="less"))

#Comparison of specificity of albumin PCR to a theorical value: 0.95
pspe36<-pval(stats::binom.test(x=cval$TN,n=cval$TN+cval$FP,
                             p=0.95,alternative="less"))

#Qualitative comparisons for Cp=22
toxo %>%
  mutate(IC=ifelse(CrossingPoint_F.x>38 & CrossingPoint_G.x>38,"inh","ok"),
         albu36=ifelse(CrossingPoint_H.x>=22,"inh","ok"))%>%
   mutate(TP=ifelse(albu36=="inh" & IC=="inh",1,0),
         FP=ifelse(albu36=="inh" & IC=="ok",1,0),
         FN=ifelse(albu36=="ok" & IC=="inh",1,0),
         TN=ifelse(albu36=="ok" & IC=="ok",1,0)) %>%
  dplyr::summarise(TP=sum(TP),
                   FP=sum(FP),
                   FN=sum(FN),
                   TN=sum(TN)) -> cval
  
#Summarising sensitivity and specificity values
Percentage<-c(cval$TP/(cval$TP+cval$FN)*100,cval$TN/(cval$TN+cval$FP)*100)
Parameter<-c("sensitivity (Cp 22)", "specificity (Cp 22)")
data_frame(Parameter, Percentage) %>% kable(digits=1)

print(" ")

#Comparison of sensitivity of albumin PCR to a theorical value: 0.95
psen22<-pval(stats::binom.test(x=cval$TP,n=cval$TP+cval$FN,
                             p=0.95,alternative="less"))

#Comparison of specificity of albumin PCR to a theorical value: 0.95
pspe22<-pval(stats::binom.test(x=cval$TN,n=cval$TN+cval$FP,
                             p=0.95,alternative="less"))



#Summary of results for Cp=22 and Cp=36
p_value<-p.adjust(c(psen36,pspe36,psen22,pspe22),method="holm")
Binomial_test<-c("sensitivity (Cp 36)", "specificity (Cp 36)",
"sensitivity (Cp 22)", "specificity (Cp 22)")
data_frame(Binomial_test,p_value) %>% kable(digits=50)
```

Alternative hypothesis: Sensitivity/specificity is lower than 0.95

\

 
###Graphical analysis to search an optimal Cp cut off value per matrix

Due to absence of inhibited samples(defined by two inhibition control Cp > 38),
we could not analyze AF, BAL, aqueous humor. We could not analyze the tissue matrix due
to their low number and heterogeneity.


#### Veinous blood

```{r tg-blood}

tgy<-function(Ct) {toxo %>%
    filter(Matrix=="Sang veineux" & 
             Info_patient=="N/A") %>% 
    mutate(IC=ifelse(CrossingPoint_F.x>38 & CrossingPoint_G.x>38,"inh","ok"),
           albu28=ifelse(CrossingPoint_H.x>=Ct,"inh","ok"))%>%
    mutate(TP=ifelse(albu28=="inh" & IC=="inh",1,0),
           FP=ifelse(albu28=="inh" & IC=="ok",1,0),
           FN=ifelse(albu28=="ok" & IC=="inh",1,0),
           TN=ifelse(albu28=="ok" & IC=="ok",1,0)) %>%
    dplyr::summarise(TP=sum(TP),
                     FP=sum(FP),
                     FN=sum(FN),
                     TN=sum(TN)) %>% 
    summarise(threshold=Ct,
              Youden=TN/(TN+FP)+TP/(TP+FN)-1,
              Sen=TP/(TP+FN),
              Spe=TN/(TN+FP))-> pp
  pp$Youden
}
#Defining and priming the repeated Youden index calculation
k<-c()
Ct<-20
Cti<-20
int<-0.1
Ctfin<-45
repeat {
    append(k,tgy(Ct))->k
  Ct<-Ct+int
  if(Ct>Ctfin) break }
l<-seq(from=Cti,to=Ctfin-int,by=int)

#Summarising them in a graph
mytitle <- expression(paste(italic("Toxoplasma"), " PCR for veinous blood"))
ggplot()+
  geom_step(aes(x=l,y=k))+
  theme_classic(base_size=10)+
  xlab("albumin PCR Cp")+
  ylab("Youden's index")+
  ggtitle(mytitle)

#Giving the value of Cp with maximal Youden index
df<-data.frame(l,k)
df %>%
  summarise(`M`=max(k)) ->youmax
  
df %>%
  filter(k==youmax$M) %>%
rename(`Corresponding Cp`=l,`Maximal Youden index`=k) %>% kable()

#Defining functions to calculate sensitivity and specificity
tgsen<-function(Ct) {toxo %>%
    filter(Matrix=="Sang veineux" & 
           Info_patient=="N/A") %>% 
    mutate(IC=ifelse(CrossingPoint_F.x>38 & CrossingPoint_G.x>38,"inh","ok"),
           albu28=ifelse(CrossingPoint_H.x>=Ct,"inh","ok"))%>%
    mutate(TP=ifelse(albu28=="inh" & IC=="inh",1,0),
         FP=ifelse(albu28=="inh" & IC=="ok",1,0),
         FN=ifelse(albu28=="ok" & IC=="inh",1,0),
         TN=ifelse(albu28=="ok" & IC=="ok",1,0)) %>%
  dplyr::summarise(TP=sum(TP),
                   FP=sum(FP),
                   FN=sum(FN),
                   TN=sum(TN)) %>% 
  summarise(threshold=Ct,
            Youden=TN/(TN+FP)+TP/(TP+FN)-1,
            Sen=TP/(TP+FN),
            Spe=TN/(TN+FP))-> pp
  pp$Sen
}

tgspe<-function(Ct) {toxo %>%
    filter(Matrix=="Sang veineux" & 
           Info_patient=="N/A") %>% 
    mutate(IC=ifelse(CrossingPoint_F.x>38 & CrossingPoint_G.x>38,"inh","ok"),
           albu28=ifelse(CrossingPoint_H.x>=Ct,"inh","ok"))%>%
    mutate(class=ifelse(albu28=="inh" & IC=="inh","TP","other")) %>%
    transform(class=ifelse(albu28=="inh" & IC=="ok","FP",class)) %>%
    transform(class=ifelse(albu28=="ok" & IC=="inh","FN",class)) %>%
    transform(class=ifelse(albu28=="ok" & IC=="ok","TN",class)) %>%
    group_by(class) %>%
    dplyr::summarise(n=n())%>% 
    spread(class,n) %>%
    summarise(threshold=Ct,
              Youden=TN/(TN+FP)+TP/(TP+FN)-1,
              Sen=TP/(TP+FN),
              Spe=TN/(TN+FP))-> pp
  pp$Spe
}

#Defining conditions for repeated sensitivity and specificity calculation
int<-0.5
Cti<-17
Ctfin<-45
Ct<-17
sensitivity<-c()

#Calulation of sensitivity and specificity for the corresponding Cp values interval
#and creation of a tibble
l<-seq(from=Cti,to=Ctfin,by=int)
repeat {
  append(sensitivity,tgsen(Ct))->sensitivity
  Ct<-Ct+int
  if(Ct>Ctfin) break }
tibble(l,sensitivity) %>%
  rename(value=sensitivity) %>%
  mutate(parameter="sensitivity") -> sen

Ct<-17
specificity<-c()
repeat {
  append(specificity,tgspe(Ct))->specificity
  Ct<-Ct+int
  if(Ct>Ctfin) break }
tibble(l,specificity) %>%
  rename(value=specificity) %>%
  mutate(parameter="specificity") -> spe

#Ploting the results
mytitle <- expression(paste(italic("Toxoplasma"), " PCR for veinous blood"))
bind_rows(sen,spe) %>%
  ggplot()+
  geom_step(aes(x=l,y=value,col=parameter))+
  theme_classic(base_size = 10)+
  xlab("albumin PCR Cp cut-off")+
  ylab("Sensitivity/Specificity")+
  ggtitle(mytitle)

```


#### Paucicellular veinous blood
```{r tg_pauci_blood_graph}
#Creating a column for merging dataframes
fbctox %>%
  transform(DOB=dmy(DOB),
            Date_sampling=dmy_hm(Date_sampling)) %>%
  mutate(ID=paste(IEP,Date_sampling,sep="_")) %>%
  transform(ID=str_sub(ID,1,21),
            WBC=as.numeric(as.character(WBC))) %>%
  distinct(ID,.keep_all=T)-> fbctox2

#Blood samples with full blood count automatically associated  and merging dataframes
toxo %>%
  mutate(ID=paste(IEP,Date_sampling,sep="_")) %>%
  transform(ID=str_sub(ID,1,21)) %>%
  filter(Matrix=="Sang veineux" & Info_patient=="N/A") %>%
  left_join(fbctox2,by="ID") %>%
  filter(!is.na(WBC)) %>%
  transform(WBC=as.numeric(WBC)) %>%
  mutate(pauci=ifelse(WBC<3,1,0)) %>%
  select(1:139,155) -> tg_fbc

#Blood samples without WBC
#Loading classification as paucicellular or not
cyt_man<-read.csv(file="E:/inhib/PCR toxo sans cytologies associees (1).csv",sep=";",header=T,dec=".")

#Selection, merging and classification as paucicellular
toxo %>%
  mutate(ID=paste(IEP,Date_sampling,sep="_")) %>%
  transform(ID=str_sub(ID,1,21)) %>%
  filter(Matrix=="Sang veineux" & 
           Info_patient=="N/A" &
           SampleName.x!="153 0868 HA") %>% 
  left_join(fbctox2,by="ID") %>% 
  filter(is.na(WBC) ) %>%
  left_join(cyt_man,by="Num_demande.x") %>%
  mutate(pauci=ifelse(cyto %in% c("pauci","aplasie"),1,0)) %>%
  select(1:139,166)-> tg_bld

#Merging into one dataframe
bind_rows(tg_fbc,tg_bld) -> toxo_p

tgy<-function(Ct) {toxo_p %>%
    filter(pauci==1) %>% 
    mutate(IC=ifelse(CrossingPoint_F.x>38 & CrossingPoint_G.x>38,"inh","ok"),
           albu28=ifelse(CrossingPoint_H.x>=Ct,"inh","ok"))%>%
    mutate(TP=ifelse(albu28=="inh" & IC=="inh",1,0),
           FP=ifelse(albu28=="inh" & IC=="ok",1,0),
           FN=ifelse(albu28=="ok" & IC=="inh",1,0),
           TN=ifelse(albu28=="ok" & IC=="ok",1,0)) %>%
    dplyr::summarise(TP=sum(TP),
                     FP=sum(FP),
                     FN=sum(FN),
                     TN=sum(TN)) %>% 
    summarise(threshold=Ct,
              Youden=TN/(TN+FP)+TP/(TP+FN)-1)-> pp
  pp$Youden
}
#Defining and priming the repeated Youden index calculation
k<-c()
Ct<-20
Cti<-20
int<-0.1
Ctfin<-45
repeat {
    append(k,tgy(Ct))->k
  Ct<-Ct+int
  if(Ct>Ctfin) break }
l<-seq(from=Cti,to=Ctfin-int,by=int)

#Summarising them in a graph
mytitle <- expression(paste(italic("Toxoplasma"), " PCR for paucicellular blood"))
ggplot()+
  geom_step(aes(x=l,y=k))+
  theme_classic(base_size=10)+
  xlab("albumin PCR Cp")+
  ylab("Youden's index")+
  ggtitle(mytitle)

#Giving the value of Cp with maximal Youden index
df<-data.frame(l,k)
df %>%
  summarise(`M`=max(k)) ->youmax
  
df %>%
  filter(k==youmax$M) %>%
rename(`Corresponding Cp`=l,`Maximal Youden index`=k) %>% kable()

#Defining functions to calculate sensitivity and specificity
tgsen<-function(Ct) {toxo_p %>%
    filter(pauci==1) %>% 
    mutate(IC=ifelse(CrossingPoint_F.x>38 & CrossingPoint_G.x>38,"inh","ok"),
           albu28=ifelse(CrossingPoint_H.x>=Ct,"inh","ok"))%>%
    mutate(TP=ifelse(albu28=="inh" & IC=="inh",1,0),
         FP=ifelse(albu28=="inh" & IC=="ok",1,0),
         FN=ifelse(albu28=="ok" & IC=="inh",1,0),
         TN=ifelse(albu28=="ok" & IC=="ok",1,0)) %>%
  dplyr::summarise(TP=sum(TP),
                   FP=sum(FP),
                   FN=sum(FN),
                   TN=sum(TN)) %>% 
  summarise(threshold=Ct,
            Sen=TP/(TP+FN))-> pp
  pp$Sen
}

tgspe<-function(Ct) {toxo_p %>%
    filter(pauci==1) %>% 
    mutate(IC=ifelse(CrossingPoint_F.x>38 & CrossingPoint_G.x>38,"inh","ok"),
           albu28=ifelse(CrossingPoint_H.x>=Ct,"inh","ok"))%>%
    mutate(TP=ifelse(albu28=="inh" & IC=="inh",1,0),
         FP=ifelse(albu28=="inh" & IC=="ok",1,0),
         FN=ifelse(albu28=="ok" & IC=="inh",1,0),
         TN=ifelse(albu28=="ok" & IC=="ok",1,0)) %>%
  dplyr::summarise(TP=sum(TP),
                   FP=sum(FP),
                   FN=sum(FN),
                   TN=sum(TN)) %>% 
  summarise(threshold=Ct,
            Spe=TN/(TN+FP))-> pp
  pp$Spe
}

#Defining conditions for repeated sensitivity and specificity calculation
int<-0.5
Cti<-17
Ctfin<-45
Ct<-17
sensitivity<-c()

#Calulation of sensitivity and specificity for the corresponding Cp values interval
#and creation of a tibble
l<-seq(from=Cti,to=Ctfin,by=int)
repeat {
  append(sensitivity,tgsen(Ct))->sensitivity
  Ct<-Ct+int
  if(Ct>Ctfin) break }
tibble(l,sensitivity) %>%
  rename(value=sensitivity) %>%
  mutate(parameter="sensitivity") -> sen

Ct<-17
specificity<-c()
repeat {
  append(specificity,tgspe(Ct))->specificity
  Ct<-Ct+int
  if(Ct>Ctfin) break }
tibble(l,specificity) %>%
  rename(value=specificity) %>%
  mutate(parameter="specificity") -> spe

#Ploting the results
mytitle <- expression(paste(italic("Toxoplasma"), " PCR for paucicellular blood"))
bind_rows(sen,spe) %>%
  ggplot()+
  geom_step(aes(x=l,y=value,col=parameter))+
  theme_classic(base_size = 10)+
  xlab("albumin PCR Cp cut-off")+
  ylab("Sensitivity/Specificity")+
  ggtitle(mytitle)

```


####Non paucicellular veinous blood
```{r tg_non_pauci_blood_graph}
#Creating a column for merging dataframes
fbctox %>%
  transform(DOB=dmy(DOB),
            Date_sampling=dmy_hm(Date_sampling)) %>%
  mutate(ID=paste(IEP,Date_sampling,sep="_")) %>%
  transform(ID=str_sub(ID,1,21),
            WBC=as.numeric(as.character(WBC))) %>%
  distinct(ID,.keep_all=T)-> fbctox2

#Blood samples with full blood count automatically associated  and merging dataframes
toxo %>%
  mutate(ID=paste(IEP,Date_sampling,sep="_")) %>%
  transform(ID=str_sub(ID,1,21)) %>%
  filter(Matrix=="Sang veineux" & Info_patient=="N/A") %>%
  left_join(fbctox2,by="ID") %>%
  filter(!is.na(WBC)) %>%
  transform(WBC=as.numeric(WBC)) %>%
  mutate(pauci=ifelse(WBC<3,1,0)) %>%
  select(1:139,155) -> tg_fbc

#Blood samples without WBC
#Loading classification as paucicellular or not
cyt_man<-read.csv(file="E:/inhib/PCR toxo sans cytologies associees (1).csv",sep=";",header=T,dec=".")

#Selection, merging and classification as paucicellular
toxo %>%
  mutate(ID=paste(IEP,Date_sampling,sep="_")) %>%
  transform(ID=str_sub(ID,1,21)) %>%
  filter(Matrix=="Sang veineux" & 
           Info_patient=="N/A" &
           SampleName.x!="153 0868 HA") %>% 
  left_join(fbctox2,by="ID") %>% 
  filter(is.na(WBC) ) %>%
  left_join(cyt_man,by="Num_demande.x") %>%
  mutate(pauci=ifelse(cyto %in% c("pauci","aplasie"),1,0)) %>%
  select(1:139,166)-> tg_bld

#Merging into one dataframe
bind_rows(tg_fbc,tg_bld) -> toxo_p

tgy<-function(Ct) {toxo_p %>%
    filter(pauci==0) %>% 
    mutate(IC=ifelse(CrossingPoint_F.x>38 & CrossingPoint_G.x>38,"inh","ok"),
           albu28=ifelse(CrossingPoint_H.x>=Ct,"inh","ok"))%>%
    mutate(TP=ifelse(albu28=="inh" & IC=="inh",1,0),
           FP=ifelse(albu28=="inh" & IC=="ok",1,0),
           FN=ifelse(albu28=="ok" & IC=="inh",1,0),
           TN=ifelse(albu28=="ok" & IC=="ok",1,0)) %>%
    dplyr::summarise(TP=sum(TP),
                     FP=sum(FP),
                     FN=sum(FN),
                     TN=sum(TN)) %>% 
    summarise(threshold=Ct,
              Youden=TN/(TN+FP)+TP/(TP+FN)-1)-> pp
  pp$Youden
}
#Defining and priming the repeated Youden index calculation
k<-c()
Ct<-20
Cti<-20
int<-0.1
Ctfin<-45
repeat {
    append(k,tgy(Ct))->k
  Ct<-Ct+int
  if(Ct>Ctfin) break }
l<-seq(from=Cti,to=Ctfin-int,by=int)

#Summarising them in a graph
mytitle <- expression(paste(italic("Toxoplasma"), " PCR for non paucicellular blood"))
ggplot()+
  geom_step(aes(x=l,y=k))+
  theme_classic(base_size=10)+
  xlab("albumin PCR Cp")+
  ggtitle(mytitle)

#Giving the value of Cp with maximal Youden index
df<-data.frame(l,k)
df %>%
  summarise(`M`=max(k)) ->youmax
  
df %>%
  filter(k==youmax$M) %>%
rename(`Corresponding Cp`=l,`Maximal Youden index`=k) %>% kable()

#Defining functions to calculate sensitivity and specificity
tgsen<-function(Ct) {toxo_p %>%
    filter(pauci==0) %>% 
    mutate(IC=ifelse(CrossingPoint_F.x>38 & CrossingPoint_G.x>38,"inh","ok"),
           albu28=ifelse(CrossingPoint_H.x>=Ct,"inh","ok"))%>%
    mutate(TP=ifelse(albu28=="inh" & IC=="inh",1,0),
         FP=ifelse(albu28=="inh" & IC=="ok",1,0),
         FN=ifelse(albu28=="ok" & IC=="inh",1,0),
         TN=ifelse(albu28=="ok" & IC=="ok",1,0)) %>%
  dplyr::summarise(TP=sum(TP),
                   FP=sum(FP),
                   FN=sum(FN),
                   TN=sum(TN)) %>% 
  summarise(threshold=Ct,
            Sen=TP/(TP+FN))-> pp
  pp$Sen
}

tgspe<-function(Ct) {toxo_p %>%
    filter(pauci==0) %>% 
    mutate(IC=ifelse(CrossingPoint_F.x>38 & CrossingPoint_G.x>38,"inh","ok"),
           albu28=ifelse(CrossingPoint_H.x>=Ct,"inh","ok"))%>%
    mutate(TP=ifelse(albu28=="inh" & IC=="inh",1,0),
         FP=ifelse(albu28=="inh" & IC=="ok",1,0),
         FN=ifelse(albu28=="ok" & IC=="inh",1,0),
         TN=ifelse(albu28=="ok" & IC=="ok",1,0)) %>%
  dplyr::summarise(TP=sum(TP),
                   FP=sum(FP),
                   FN=sum(FN),
                   TN=sum(TN)) %>% 
  summarise(threshold=Ct,
            Spe=TN/(TN+FP))-> pp
  pp$Spe
}

#Defining conditions for repeated sensitivity and specificity calculation
int<-0.5
Cti<-17
Ctfin<-45
Ct<-17
sensitivity<-c()

#Calulation of sensitivity and specificity for the corresponding Cp values interval
#and creation of a tibble
l<-seq(from=Cti,to=Ctfin,by=int)
repeat {
  append(sensitivity,tgsen(Ct))->sensitivity
  Ct<-Ct+int
  if(Ct>Ctfin) break }
tibble(l,sensitivity) %>%
  rename(value=sensitivity) %>%
  mutate(parameter="sensitivity") -> sen

Ct<-17
specificity<-c()
repeat {
  append(specificity,tgspe(Ct))->specificity
  Ct<-Ct+int
  if(Ct>Ctfin) break }
tibble(l,specificity) %>%
  rename(value=specificity) %>%
  mutate(parameter="specificity") -> spe

#Ploting the results
mytitle <- expression(paste(italic("Toxoplasma"), " PCR for non paucicellular blood"))
bind_rows(sen,spe) %>%
  ggplot()+
  geom_step(aes(x=l,y=value,col=parameter))+
  theme_classic(base_size = 10)+
  xlab("albumin PCR Cp cut-off")+
  ylab("Sensitivity/Specificity")+
  ggtitle(mytitle)

```


##### Placenta

```{r tg-placenta}

#Since no false negative results (FN) were observed we created a column with the 0 number
tgy<-function(Ct) {toxo %>%
    filter(Matrix=="Placenta") %>%
    mutate(IC=ifelse(CrossingPoint_F.x>38 & CrossingPoint_G.x>38,"inh","ok"),
           albu28=ifelse(CrossingPoint_H.x>=Ct,"inh","ok"))%>%
     mutate(TP=ifelse(albu28=="inh" & IC=="inh",1,0),
         FP=ifelse(albu28=="inh" & IC=="ok",1,0),
         FN=ifelse(albu28=="ok" & IC=="inh",1,0),
         TN=ifelse(albu28=="ok" & IC=="ok",1,0)) %>%
  dplyr::summarise(TP=sum(TP),
                   FP=sum(FP),
                   FN=sum(FN),
                   TN=sum(TN)) %>% 
  summarise(threshold=Ct,
            Youden=TN/(TN+FP)+TP/(TP+FN)-1,
            Sen=TP/(TP+FN),
            Spe=TN/(TN+FP))-> pp
  pp$Youden
}
#Defining and priming the repeated Youden index calculation
k<-c()
Ct<-20
Cti<-20
int<-0.1
Ctfin<-45
repeat {
    append(k,tgy(Ct))->k
  Ct<-Ct+int
  if(Ct>Ctfin) break }
l<-seq(from=Cti,to=Ctfin-int,by=int)

#Summarising them in a graph
mytitle <- expression(paste(italic("Toxoplasma"), " PCR for placenta"))
ggplot()+
  geom_step(aes(x=l,y=k))+
  theme_classic(base_size=10)+
  xlab("albumin PCR Cp")+
  ylab("Youden's index")+
  ggtitle(mytitle)


#Defining functions to calculate sensitivity and specificity
tgsen<-function(Ct) {toxo %>%
    filter(Matrix=="Placenta") %>%
    mutate(IC=ifelse(CrossingPoint_F.x>38 & CrossingPoint_G.x>38,"inh","ok"),
           albu28=ifelse(CrossingPoint_H.x>=Ct,"inh","ok"))%>%
     mutate(TP=ifelse(albu28=="inh" & IC=="inh",1,0),
         FP=ifelse(albu28=="inh" & IC=="ok",1,0),
         FN=ifelse(albu28=="ok" & IC=="inh",1,0),
         TN=ifelse(albu28=="ok" & IC=="ok",1,0)) %>%
  dplyr::summarise(TP=sum(TP),
                   FP=sum(FP),
                   FN=sum(FN),
                   TN=sum(TN)) %>% 
  summarise(threshold=Ct,
            Youden=TN/(TN+FP)+TP/(TP+FN)-1,
            Sen=TP/(TP+FN),
            Spe=TN/(TN+FP))-> pp
  pp$Sen
}

tgspe<-function(Ct) {toxo %>%
    filter(Matrix=="Placenta") %>%
    mutate(IC=ifelse(CrossingPoint_F.x>38 & CrossingPoint_G.x>38,"inh","ok"),
           albu28=ifelse(CrossingPoint_H.x>=Ct,"inh","ok"))%>%
    mutate(TP=ifelse(albu28=="inh" & IC=="inh",1,0),
         FP=ifelse(albu28=="inh" & IC=="ok",1,0),
         FN=ifelse(albu28=="ok" & IC=="inh",1,0),
         TN=ifelse(albu28=="ok" & IC=="ok",1,0)) %>%
  dplyr::summarise(TP=sum(TP),
                   FP=sum(FP),
                   FN=sum(FN),
                   TN=sum(TN)) %>% 
  summarise(threshold=Ct,
            Youden=TN/(TN+FP)+TP/(TP+FN)-1,
            Sen=TP/(TP+FN),
            Spe=TN/(TN+FP))-> pp
  pp$Spe
}

#Defining conditions for repeated sensitivity and specificity calculation
int<-0.5
Cti<-17
Ctfin<-45
Ct<-17
sensitivity<-c()

#Calulation of sensitivity and specificity for the corresponding Cp values interval
#and creation of a tibble
l<-seq(from=Cti,to=Ctfin,by=int)
repeat {
  append(sensitivity,tgsen(Ct))->sensitivity
  Ct<-Ct+int
  if(Ct>Ctfin) break }
tibble(l,sensitivity) %>%
  rename(value=sensitivity) %>%
  mutate(parameter="sensitivity") -> sen

Ct<-17
specificity<-c()
repeat {
  append(specificity,tgspe(Ct))->specificity
  Ct<-Ct+int
  if(Ct>Ctfin) break }
tibble(l,specificity) %>%
  rename(value=specificity) %>%
  mutate(parameter="specificity") -> spe

#Ploting the results
mytitle <- expression(paste(italic("Toxoplasma"), " PCR for placenta"))
bind_rows(sen,spe) %>%
  ggplot()+
  geom_step(aes(x=l,y=value,col=parameter))+
  theme_classic(base_size = 10)+
  xlab("albumin PCR Cp cut-off")+
  ylab("Sensitivity/Specificity")+
  ggtitle(mytitle)

```


#### Cord blood

```{r tg-cord}
tgy<-function(Ct) {toxo %>%
    filter(Matrix=="Sang de cordon") %>%
    mutate(IC=ifelse(CrossingPoint_F.x>38 & CrossingPoint_G.x>38,"inh","ok"),
           albu28=ifelse(CrossingPoint_H.x>=Ct,"inh","ok"))%>%
     mutate(TP=ifelse(albu28=="inh" & IC=="inh",1,0),
         FP=ifelse(albu28=="inh" & IC=="ok",1,0),
         FN=ifelse(albu28=="ok" & IC=="inh",1,0),
         TN=ifelse(albu28=="ok" & IC=="ok",1,0)) %>%
  dplyr::summarise(TP=sum(TP),
                   FP=sum(FP),
                   FN=sum(FN),
                   TN=sum(TN)) %>% 
  summarise(threshold=Ct,
            Youden=TN/(TN+FP)+TP/(TP+FN)-1,
            Sen=TP/(TP+FN),
            Spe=TN/(TN+FP))-> pp
  pp$Youden
}
#Defining and priming the repeated Youden index calculation
k<-c()
Ct<-20
Cti<-20
int<-0.1
Ctfin<-45
repeat {
    append(k,tgy(Ct))->k
  Ct<-Ct+int
  if(Ct>Ctfin) break }
l<-seq(from=Cti,to=Ctfin-int,by=int)

#Summarising them in a graph
mytitle <- expression(paste(italic("Toxoplasma"), " PCR for cord blood"))
ggplot()+
  geom_step(aes(x=l,y=k))+
  theme_classic(base_size=10)+
  xlab("albumin PCR Cp")+
  ylab("Youden's index")+
  ggtitle(mytitle)


#Defining functions to calculate sensitivity and specificity
tgsen<-function(Ct) {toxo %>%
    filter(Matrix=="Sang de cordon") %>%
    mutate(IC=ifelse(CrossingPoint_F.x>38 & CrossingPoint_G.x>38,"inh","ok"),
           albu28=ifelse(CrossingPoint_H.x>=Ct,"inh","ok"))%>%
     mutate(TP=ifelse(albu28=="inh" & IC=="inh",1,0),
         FP=ifelse(albu28=="inh" & IC=="ok",1,0),
         FN=ifelse(albu28=="ok" & IC=="inh",1,0),
         TN=ifelse(albu28=="ok" & IC=="ok",1,0)) %>%
  dplyr::summarise(TP=sum(TP),
                   FP=sum(FP),
                   FN=sum(FN),
                   TN=sum(TN)) %>% 
  summarise(threshold=Ct,
            Youden=TN/(TN+FP)+TP/(TP+FN)-1,
            Sen=TP/(TP+FN),
            Spe=TN/(TN+FP))-> pp
  pp$Sen
}

tgspe<-function(Ct) {toxo %>%
    filter(Matrix=="Placenta") %>%
    mutate(IC=ifelse(CrossingPoint_F.x>38 & CrossingPoint_G.x>38,"inh","ok"),
           albu28=ifelse(CrossingPoint_H.x>=Ct,"inh","ok"))%>%
     mutate(TP=ifelse(albu28=="inh" & IC=="inh",1,0),
         FP=ifelse(albu28=="inh" & IC=="ok",1,0),
         FN=ifelse(albu28=="ok" & IC=="inh",1,0),
         TN=ifelse(albu28=="ok" & IC=="ok",1,0)) %>%
  dplyr::summarise(TP=sum(TP),
                   FP=sum(FP),
                   FN=sum(FN),
                   TN=sum(TN)) %>% 
  summarise(threshold=Ct,
            Youden=TN/(TN+FP)+TP/(TP+FN)-1,
            Sen=TP/(TP+FN),
            Spe=TN/(TN+FP))-> pp
  pp$Spe
}

#Defining conditions for repeated sensitivity and specificity calculation
int<-0.5
Cti<-17
Ctfin<-45
Ct<-17
sensitivity<-c()

#Calulation of sensitivity and specificity for the corresponding Cp values interval
#and creation of a tibble
l<-seq(from=Cti,to=Ctfin,by=int)
repeat {
  append(sensitivity,tgsen(Ct))->sensitivity
  Ct<-Ct+int
  if(Ct>Ctfin) break }
tibble(l,sensitivity) %>%
  rename(value=sensitivity) %>%
  mutate(parameter="sensitivity") -> sen

Ct<-17
specificity<-c()
repeat {
  append(specificity,tgspe(Ct))->specificity
  Ct<-Ct+int
  if(Ct>Ctfin) break }
tibble(l,specificity) %>%
  rename(value=specificity) %>%
  mutate(parameter="specificity") -> spe

#Ploting the results
mytitle <- expression(paste(italic("Toxoplasma"), " PCR for cord blood"))
bind_rows(sen,spe) %>%
  ggplot()+
  geom_step(aes(x=l,y=value,col=parameter))+
  theme_classic(base_size = 10)+
  xlab("albumin PCR Cp cut-off")+
  ylab("Sensitivity/Specificity")+
  ggtitle(mytitle)

```


#### CSF

```{r tg-csf}
tgy<-function(Ct) {toxo %>%
    filter(Matrix=="Liquide céphalo-rachidien (LCR)" | 
           Info_patient=="Liquide céphalo-rachidien (LCR)") %>%
    mutate(IC=ifelse(CrossingPoint_F.x>38 & CrossingPoint_G.x>38,"inh","ok"),
           albu28=ifelse(CrossingPoint_H.x>=Ct,"inh","ok"))%>%
    mutate(TP=ifelse(albu28=="inh" & IC=="inh",1,0),
         FP=ifelse(albu28=="inh" & IC=="ok",1,0),
         FN=ifelse(albu28=="ok" & IC=="inh",1,0),
         TN=ifelse(albu28=="ok" & IC=="ok",1,0)) %>%
  dplyr::summarise(TP=sum(TP),
                   FP=sum(FP),
                   FN=sum(FN),
                   TN=sum(TN)) %>% 
  summarise(threshold=Ct,
            Youden=TN/(TN+FP)+TP/(TP+FN)-1,
            Sen=TP/(TP+FN),
            Spe=TN/(TN+FP))-> pp
  pp$Youden
}
#Defining and priming the repeated Youden index calculation
k<-c()
Ct<-20
Cti<-20
int<-0.1
Ctfin<-45
repeat {
    append(k,tgy(Ct))->k
  Ct<-Ct+int
  if(Ct>Ctfin) break }
l<-seq(from=Cti,to=Ctfin-int,by=int)

#Summarising them in a graph
mytitle <- expression(paste(italic("Toxoplasma"), " PCR for CSF"))
ggplot()+
  geom_step(aes(x=l,y=k))+
  theme_classic(base_size=10)+
  xlab("albumin PCR Cp")+
  ylab("Youden's index")+
  ggtitle(mytitle)

#Giving the value of Cp with maximal Youden index
df<-data.frame(l,k)
df %>%
  summarise(`M`=max(k)) ->youmax
  
df %>%
  filter(k==youmax$M) %>%
rename(`Corresponding Cp`=l,`Maximal Youden index`=k) %>% kable()

#Defining functions to calculate sensitivity and specificity
tgsen<-function(Ct) {toxo %>%
    filter(Matrix=="Liquide céphalo-rachidien (LCR)" | 
           Info_patient=="Liquide céphalo-rachidien (LCR)") %>%
    mutate(IC=ifelse(CrossingPoint_F.x>38 & CrossingPoint_G.x>38,"inh","ok"),
           albu28=ifelse(CrossingPoint_H.x>=Ct,"inh","ok"))%>%
     mutate(TP=ifelse(albu28=="inh" & IC=="inh",1,0),
         FP=ifelse(albu28=="inh" & IC=="ok",1,0),
         FN=ifelse(albu28=="ok" & IC=="inh",1,0),
         TN=ifelse(albu28=="ok" & IC=="ok",1,0)) %>%
  dplyr::summarise(TP=sum(TP),
                   FP=sum(FP),
                   FN=sum(FN),
                   TN=sum(TN)) %>% 
  summarise(threshold=Ct,
            Youden=TN/(TN+FP)+TP/(TP+FN)-1,
            Sen=TP/(TP+FN),
            Spe=TN/(TN+FP))-> pp
  pp$Sen
}

tgspe<-function(Ct) {toxo %>%
    filter(Matrix=="Liquide céphalo-rachidien (LCR)" | 
           Info_patient=="Liquide céphalo-rachidien (LCR)") %>%
    mutate(IC=ifelse(CrossingPoint_F.x>38 & CrossingPoint_G.x>38,"inh","ok"),
           albu28=ifelse(CrossingPoint_H.x>=Ct,"inh","ok"))%>%
     mutate(TP=ifelse(albu28=="inh" & IC=="inh",1,0),
         FP=ifelse(albu28=="inh" & IC=="ok",1,0),
         FN=ifelse(albu28=="ok" & IC=="inh",1,0),
         TN=ifelse(albu28=="ok" & IC=="ok",1,0)) %>%
  dplyr::summarise(TP=sum(TP),
                   FP=sum(FP),
                   FN=sum(FN),
                   TN=sum(TN)) %>% 
  summarise(threshold=Ct,
            Youden=TN/(TN+FP)+TP/(TP+FN)-1,
            Sen=TP/(TP+FN),
            Spe=TN/(TN+FP))-> pp
  pp$Spe
}

#Defining conditions for repeated sensitivity and specificity calculation
int<-0.5
Cti<-17
Ctfin<-45
Ct<-17
sensitivity<-c()

#Calulation of sensitivity and specificity for the corresponding Cp values interval
#and creation of a tibble
l<-seq(from=Cti,to=Ctfin,by=int)
repeat {
  append(sensitivity,tgsen(Ct))->sensitivity
  Ct<-Ct+int
  if(Ct>Ctfin) break }
tibble(l,sensitivity) %>%
  rename(value=sensitivity) %>%
  mutate(parameter="sensitivity") -> sen

Ct<-17
specificity<-c()
repeat {
  append(specificity,tgspe(Ct))->specificity
  Ct<-Ct+int
  if(Ct>Ctfin) break }
tibble(l,specificity) %>%
  rename(value=specificity) %>%
  mutate(parameter="specificity") -> spe

#Ploting the results
mytitle <- expression(paste(italic("Toxoplasma"), " PCR for CSF"))
bind_rows(sen,spe) %>%
  ggplot()+
  geom_step(aes(x=l,y=value,col=parameter))+
  theme_classic(base_size = 10)+
  xlab("albumin PCR Cp cut-off")+
  ylab("Sensitivity/Specificity")+
  ggtitle(mytitle)

```


###Comparison of efficiency of albumin PCR and inhibition control

We calculated undiluted extract PCR efficiency for albumin PCR and IC of controlled samples assuming
* efficiency of 1/10 diluted extract was equal to the average value of efficiency to the concerned PCR
* inter-run Cp variations du to several parameters could be neglected

We calculated it using the following formula for IC and albumin PCR respectively:

$$E_{undiluted}(IC) = exp\left(\frac{log(E^{Cp_{diluted}})}{Cp_{undiluted}}\right)$$

$$E_{undiluted} (albumin) = exp\left(\frac{log(0.1*E^{Cp_{diluted}})}{Cp_{undiluted}}\right)$$

\
We did not calculated efficiency for samples:

* not controlled by 1/10 dilution
* fickly positive
* with both negative Cp for IC in a run or with one negative for albumin

Calculation were performed on **`r toxo %>%
  filter(!is.na(SampleName.y) &
           CrossingPoint_H.x<54 &
           CrossingPoint_H.y <54) %>%
  filter(CrossingPoint_F.x<54 |
           CrossingPoint_G.x <54) %>%
  filter(CrossingPoint_F.y<54 |
           CrossingPoint_G.y <54) %>% nrow()` samples**.

```{r eff_tg}
#Definition of PCR efficiency of 1/10 diluted PCR runs
Ediltg<- 1.975
Edilalb<- 1.94

#Giving a title for the graph
mytitle <- expression(paste(italic("Toxoplasma"), " PCR"))

#Selection of data, efficiency calculation and scatter-plot
toxo %>%
  filter(!is.na(SampleName.y) &
           CrossingPoint_H.x<54 &
           CrossingPoint_H.y <54) %>%
  filter(CrossingPoint_F.x<54 |
           CrossingPoint_G.x <54) %>%
  filter(CrossingPoint_F.y<54 |
           CrossingPoint_G.y <54) %>%
  mutate(Cross.x=ifelse(CrossingPoint_F.x<CrossingPoint_G.x,
                        CrossingPoint_F.x,CrossingPoint_G.x),
         Cross.y=ifelse(CrossingPoint_F.y<CrossingPoint_G.y,
                        CrossingPoint_F.y,CrossingPoint_G.y)) %>%
  mutate(EpIC=exp(log(Ediltg^Cross.y)/Cross.x),
         Epalb=exp(log((Edilalb^CrossingPoint_H.y)/10)/CrossingPoint_H.x)) %>%
  ggplot()+
  geom_point(aes(x=EpIC,y=Epalb))+
  geom_segment(aes(y=1.5,yend=2.1,x=1.5,xend=2.1),linetype=2)+
  ggtitle(mytitle)+
  xlab("Amplification control PCR efficiency")+
  ylab("Albumin PCR efficiency")+
  coord_fixed(ratio=1,xlim=c(1.5,2.1),ylim=c(1.5,2.1))+
  theme_classic()
         

toxo %>%
  filter(!is.na(SampleName.y) &
           CrossingPoint_H.x<54 &
           CrossingPoint_H.y <54) %>%
  filter(CrossingPoint_F.x<54 |
           CrossingPoint_G.x <54) %>%
  filter(CrossingPoint_F.y<54 |
           CrossingPoint_G.y <54) %>%
  mutate(Cross.x=ifelse(CrossingPoint_F.x<CrossingPoint_G.x,
                        CrossingPoint_F.x,CrossingPoint_G.x),
         Cross.y=ifelse(CrossingPoint_F.y<CrossingPoint_G.y,
                        CrossingPoint_F.y,CrossingPoint_G.y),
         category=ifelse(CrossingPoint_F.x>38 & CrossingPoint_G.x>38 &
                           CrossingPoint_H.x>=38, "both inh","other")) %>%
  mutate(EpIC=exp(log(Ediltg^Cross.y)/Cross.x),
         Epalb=exp(log((Edilalb^CrossingPoint_H.y)/10)/CrossingPoint_H.x))%>%
  transform(category= ifelse(CrossingPoint_F.x>38 & CrossingPoint_G.x>38 &
              CrossingPoint_H.x<38,"AC inh",category)) %>%
  transform(category= ifelse(CrossingPoint_F.x<38 & CrossingPoint_G.x<38 &
                            CrossingPoint_H.x>38,"alb>38",category)) %>%
  transform(category= ifelse(CrossingPoint_F.x<38 & CrossingPoint_G.x<38 &
                            CrossingPoint_H.x<38 & CrossingPoint_H.x>=28,
                            "alb>38",category)) %>%
  ggplot()+
  geom_point(aes(x=EpIC,y=Epalb,col=category))+
  geom_segment(aes(y=1.5,yend=2.1,x=1.5,xend=2.1),linetype=2)+
  ggtitle(mytitle)+
  xlab("Amplification control PCR efficiency")+
  ylab("Albumin PCR efficiency")+
  coord_fixed(ratio=1,xlim=c(1.5,2.1),ylim=c(1.5,2.1))+
  theme_classic()

```

\
  

For samples in "other" category, their features were summarized below:

```{r tg_eff_other}
toxo %>%
  filter(!is.na(SampleName.y) &
           CrossingPoint_H.x<54 &
           CrossingPoint_H.y <54) %>%
  filter(CrossingPoint_F.x<54 |
           CrossingPoint_G.x <54) %>%
  filter(CrossingPoint_F.y<54 |
           CrossingPoint_G.y <54) %>%
  mutate(Cross.x=ifelse(CrossingPoint_F.x<CrossingPoint_G.x,
                        CrossingPoint_F.x,CrossingPoint_G.x),
         Cross.y=ifelse(CrossingPoint_F.y<CrossingPoint_G.y,
                        CrossingPoint_F.y,CrossingPoint_G.y),
         category=ifelse(CrossingPoint_F.x>38 & CrossingPoint_G.x>38 &
                           CrossingPoint_H.x>=38, "both inh","other")) %>%
  mutate(EpIC=exp(log(Ediltg^Cross.y)/Cross.x),
         Epalb=exp(log((Edilalb^CrossingPoint_H.y)/10)/CrossingPoint_H.x))%>%
  transform(category= ifelse(CrossingPoint_F.x>38 & CrossingPoint_G.x>38 &
                               CrossingPoint_H.x<38,"AC inh",category)) %>%
  transform(category= ifelse(CrossingPoint_F.x<38 & CrossingPoint_G.x<38 &
                               CrossingPoint_H.x>38,"alb>38",category)) %>%
  transform(category= ifelse(CrossingPoint_F.x<38 & CrossingPoint_G.x<38 &
                               CrossingPoint_H.x<38 & CrossingPoint_H.x>=28,
                             "alb>38",category)) %>%
  filter(category=="other") %>%
  select(5,27,33,39,82,88,94,129,130,138) %>%
  rename( Sample_name =SampleName.x,
          `Cp(AC1)`=CrossingPoint_F.x,
          `Cp(AC2)`=CrossingPoint_G.x,
         `Cp(Alb)`=CrossingPoint_H.x,
         `Cp(AC1)dil`=CrossingPoint_F.y,
         `Cp(AC2)dil`=CrossingPoint_G.y,
         `Cp(Alb)dil`=CrossingPoint_H.y) %>% kable(digits=1)
```
         
\


###Correlation Cp of albumin PCR and leucocytes count in blood samples

We correlated albumin PCR of undiluted extracts and leucocytes count because Cp of albumin PCR is not only dependant of PCR inhibitors but also of quantity of human DNA in the extract. Whole blood counts of patients sampled the same day than samples for *Toxoplasma* PCR were merged if possible. Patient with no whole blood count the same day were excluded of this analysis.
We analysed here **`r nrow(toxo2)` different blood samples**.

```{r corr_WBC_tg}
#Graph of Cp(albumin) in function of white blood cell count
  toxo2 %>%
  filter(CrossingPoint_H.x<55) %>%
  ggplot()+
  geom_jitter(aes(x=WBC,y=CrossingPoint_H.x,
                  colour=`Inhibition control results`),size=0.5)+
  geom_smooth(aes(x=WBC,y=CrossingPoint_H.x),method=lm)+
  scale_x_log10()+
  coord_fixed(ratio=0.07)+
  theme_classic(base_size =8)+
  xlab("Leucocyte count (.10^9/L)")+
  ylab("albumin PCR Cp")+
  ggsave("E:/inhib/corr_leuco.tiff",device="tiff",dpi=400)


toxo2 %>%
  filter(CrossingPoint_H.x<55)-> toxo3
cor.test(x=toxo3$WBC,y=toxo3$CrossingPoint_H.x,alternative="less",method="spearman")
```

\
  

*****************************************************************
\
  

#PCR *Pneumocystis jiroveci*

```{r setup_pj, include=FALSE}
#Loading datset of Pneumocystis PCR 
inhpj<-read.csv(file="E:/inhib/data R/PjLC_R.csv",sep=";",header=T,dec=".")

#Cleaning and tidying the dataset of Pneumocystis PCR
inhpj %>%
  mutate(a=ifelse(Experiment.Name %in% c("160208-1","160315-2") &
                    Analysis.Name=="Abs Quant/2nd Derivative Max for New Subset 1 (1)",
                  1,0),
         b=ifelse(SampleName %in% c("0","0 ALBU","0ALBU"),1,0),
         c=ifelse(SampleName %in% c("365 2099 E 484","365 2099 TI","365 2099 ALBU"),1,0),
         d=ifelse(Experiment.Name=="160808-2" & Position %in% c("H1","H2","H3","H4",
                                                                "H5","H6","H7"),1,0),
         e=ifelse(Experiment.Name=="160809-1" & Position %in% c("E11","E12"),1,0)) %>%
  filter(a==0,b==0,c==0,d==0,e==0) %>%
  mutate(SampleName_m=SampleName %>%
           str_replace_all("(ALBU)" ,"") %>%
           str_replace_all("(TI)" ,"") %>%
           str_replace_all("(1/10)" ,"") %>%
           str_replace_all("(/10)" ,"") %>%
           str_replace_all("(D10)" ,"") %>%
           str_replace_all("(D)","") %>%
           str_replace_all("(d/10)","") %>%
           str_replace_all(" ","")) %>%
  transform(SampleName_m=ifelse(Position %in% c("E11","E12"),"plate_control",readr::parse_number(SampleName_m)),
            Experiment.Name= Experiment.Name %>% str_replace_all("160809-1","160808-2"),
            Analysis.Name=ifelse(Experiment.Name %in% c("160809-1","160808-2"),"Abs Quant/2nd Derivative Max for New Subset 2",
                                 Experiment.Name)) %>%
  mutate(Expe_Analysis_Name=paste(SampleName,
                                  Experiment.Name,Analysis.Name,sep="_"),
         Expe_Analysis_Name_m=paste(SampleName_m,
                                    Experiment.Name,Analysis.Name,sep="_"),
         PlateName=paste(Experiment.Name,Analysis.Name,sep="_")) %>%
  select(Experiment.Name,Analysis.Name,SampleName,SampleName_m,Expe_Analysis_Name,
         Expe_Analysis_Name_m,PlateName,Position,CrossingPoint,StatusCodes)-> inhpj2
#The message "Warning: 246 parsing failures." has no impact on data cleaning because it only concerned rows of negative controls (named "T Négatif") substituted by "plate_control"



#Changing na values of Cp by 55 only for negative results
inhpj2["CrossingPoint"][is.na(inhpj2["CrossingPoint"])] <- 55

#Joining A and B wells
inhpj2 %>%
  dplyr::filter(str_detect(Position,"A")) %>%
  rename(Position_A=Position,
         CrossingPoint_A=CrossingPoint,
         StatusCodes_A=StatusCodes) -> tA
inhpj2 %>%
  dplyr::filter(str_detect(Position,"B")) %>%
  rename(Position_B=Position,
         CrossingPoint_B=CrossingPoint,
         StatusCodes_B=StatusCodes) -> tB
full_join(tA,tB,by=c("PlateName","Expe_Analysis_Name_m","Expe_Analysis_Name") )-> inhpj3

#Adding G wells (inhibition control) to previous groups
inhpj2 %>%
  dplyr::filter(str_detect(Position,"G")) %>%
  rename(Position_G=Position,
         CrossingPoint_G=CrossingPoint,
         StatusCodes_G=StatusCodes) -> tG
full_join(inhpj3,tG,by=c("PlateName","Expe_Analysis_Name_m")) -> inhpj3

#Adding H wells (albumin) to previous groups
inhpj2 %>%
  dplyr::filter(str_detect(Position,"H")) %>%
  rename(Position_H=Position,
         CrossingPoint_H=CrossingPoint,
         StatusCodes_H=StatusCodes) -> tH
full_join(inhpj3,tH,by=c("PlateName","Expe_Analysis_Name_m")) -> inhpj3

#Add for each row corresponding to a sample
#the positive (PC) and negative plate controls (NC)
inhpj2 %>%
  dplyr::filter(str_detect(Position,"E12")) %>%
  rename(Position_PC=Position,
         CrossingPoint_PC=CrossingPoint,
         StatusCodes_PC=StatusCodes,
         SampleName_PC=SampleName) -> tPC
full_join(inhpj3,tPC,by="PlateName") -> inhpj3

inhpj2 %>%
  dplyr::filter(str_detect(Position,"E11")) %>%
  rename(Position_NC=Position,
         CrossingPoint_NC=CrossingPoint,
         StatusCodes_NC=StatusCodes) -> tNC
full_join(inhpj3,tNC,by="PlateName") %>%
  select(26:29,7,47,48,8:10,15:17,23:25,31:33,36,40:42,49:51) %>%
  rename(Experiment.Name=Experiment.Name.y.y,
         Analysis.Name=Analysis.Name.y.y,
         SampleName=SampleName.y.y,
         SampleName_m=SampleName_m.y.y)-> inhpj3

#Tidying to obtain one row of results per sample
inhpj3 %>% mutate(fusion=paste(Experiment.Name,SampleName_m,sep="_")) %>%
  filter(duplicated(fusion)) %>% select(-fusion)-> dsd
inhpj3 %>% arrange(Experiment.Name) %>% filter(duplicated(SampleName_m))-> ad
inhpj3 %>% arrange(Experiment.Name) %>% filter(!duplicated(SampleName_m))-> nd
dplyr::setdiff(ad,dsd)-> ddd
dplyr::union(nd,dsd) %>% full_join(ddd,by="SampleName_m")-> inhpj4


#Loading dataset of bioclinical informations for PCR P jiroveci results
dxpj<-read.csv(file="E:/inhib/data R/PjDxLab_R.csv",sep=";",header=T,dec=".")

#Cleaning, tidying the dataset of bioclinical informations for PCR P jiroveci results
#and creating a column "SampleName_m" for fusion with dataset of PCR P jiroveci
dxpj %>% unite(Date_creation,Date_creation,Heure_creation,sep=" ") %>%
  transform(DOB=dmy(DOB),
            Date_creation=dmy_hms(Date_creation),
            Date_sampling=dmy_hm(Date_sampling)) %>%
  mutate(SampleName_m=str_sub(Num_travail,5,-1)) %>%
  transform(SampleName_m=readr::parse_number(SampleName_m)) %>%
  transform(SampleName_m=as.character(SampleName_m))-> dxpj

#Joining the datasets and removing sporadic misapparing
#If we perform full_join, PCR saved in DXLab, but not performed owing to "non conformités", informatical assays on DXLab are included "pj" dataset
dplyr::left_join(inhpj4,dxpj,by="SampleName_m") -> pj

knitr::opts_chunk$set(echo = F)
```

##Database cleaning and tidying

###Cleaning

####Columns cleaning needs

The Column "Experiment.Name" had two duplicate dates:

* 160809: with 160809-1 and 160809-2. 160809-1 corresponded to only albumin PCR of samples analyzed a day before (160808-2) which albumin PCR were all negative.  Results of albumin PCR of 160808-2 were replaced by those of 160809-1 and the other results of Experiment.Name 160809-1 were removed.

* 161118: with 161118-1 and 161118-2 corresponding to two complete PCR runs of different samples, so no redundancies

\
The column "Analysis Name" had other names than "Abs Quant/2nd Derivative Max for New Subset 1":

* Abs Quant/2nd Derivative Max for New Subset 1 (1):

    - duplicate rows for 160208-1 comparing to "...New Subset 1"
  
    - 160315-2: redundant analysis, only the Analysis Name "...Subset 1" was valuable
  
* Abs Quant/2nd Derivative Max for New Subset 2:

    - 160114-3: no redundancies
  
    - 160209-2: no redundancies
  
\
The column "SampleName" had rows with "0" or "0 ALBU", corresponding to empty wells,
which had to be removed.

The sample named "365 2099" had to be withdrawn because it corresponded to a sample of year 2015.

\
So, to summarize cleaning needs:

* a: duplicate rows for Experiment Names 160208-1 or 160315-2 and Analysis Name "...Subset 1 (1)" were withdrawn

* b: Removing rows of empty wells

* c: Removing rows of sample "365 2099"

* d: Removing rows of albumin PCR results for Experiment Name 160808-2

* e: Removing rows of plate controls of Experiment Name 160809-1 to permit insertion of results of 160809-1 in 160808-2

\
  

####Summary of data cleanings

Parameters  "a" and "b" represent data excluded from the database for reasons explained below.

```{r clean_methodo_pj}
inhpj %>%
  mutate(a=ifelse(Experiment.Name %in% c("160208-1","160315-2") &
                    Analysis.Name=="Abs Quant/2nd Derivative Max for New Subset 1 (1)",
                  1,0),
         b=ifelse(SampleName %in% c("0","0 ALBU","0ALBU"),1,0),
         c=ifelse(SampleName %in% c("365 2099 E 484","365 2099 TI","365 2099 ALBU"),1,0),
         d=ifelse(Experiment.Name=="160808-2" & Position %in% c("H1","H2","H3","H4",
                                                                "H5","H6","H7"),1,0),
         e=ifelse(Experiment.Name=="160809-1" & Position %in% c("E11","E12"),1,0)) %>%
  mutate(extra=ifelse(a+b+c+d+e>1,1,0)) %>%
  dplyr::summarise(`Total before cleaning`=n(),
                   `n(a)`=sum(a),
                   `n(b)`=sum(b),
                   `n(c)`=sum(c),
                   `n(d)`=sum(d),
                   `n(e)`=sum(e),
                   redundant=sum(extra)) %>% kable(digits=1)
cat("a: duplicate rows for Experiment Name 160208-1 and Analysis Name '...Subset 1 (1)' were withdrawn")
cat("b: Removing rows of empty wells")
cat("c: Removing rows of sample 365 2099 from end of year 2015")
cat("d: Removing rows of albumin PCR results for Experiment Name 160808-2")
cat("e: Removing rows of plate controls of Experiment Name 160809-1 to permit insertion of results of 160809-1 in 160808-2")

```

\
  

###Tidying

We had `r nrow(inhtox)` results corresponding to *Toxoplasma* PCR performed from 01-01-2016 to 12-31-2016. The following table checked discrepancies during tidying and mergings.
```{r tidying_pj}
#Grouping per sample, duplicate PCR results, inhibition control and albumin control,
#negative and positive plate control

#Grouping A and B wells
inhpj2 %>%
  dplyr::filter(str_detect(Position,"A")) %>%
  rename(Position_A=Position,
         CrossingPoint_A=CrossingPoint,
         StatusCodes_A=StatusCodes) -> tA
inhpj2 %>%
  dplyr::filter(str_detect(Position,"B")) %>%
  rename(Position_B=Position,
         CrossingPoint_B=CrossingPoint,
         StatusCodes_B=StatusCodes) -> tB
full_join(tA,tB,by=c("PlateName","Expe_Analysis_Name_m","Expe_Analysis_Name") )-> inhpj3
cat("Control of well position inconsistencies between A and B")
inhpj3 %>%
  transform(Position_A=str_sub(Position_A,2,-1),
            Position_B=str_sub(Position_B,2,-1)) %>%
  transform(Position_A=as.numeric(Position_A),
            Position_B=as.numeric(Position_B)) %>%
  mutate(`Delta between A and B`=Position_A-Position_B) %>%
  group_by(`Delta between A and B`) %>%
  dplyr::summarise(
    numbers=n()) %>% kable()

#Adding G wells (inhibition control) to previous groups
inhpj2 %>%
  dplyr::filter(str_detect(Position,"G")) %>%
  rename(Position_G=Position,
         CrossingPoint_G=CrossingPoint,
         StatusCodes_G=StatusCodes) -> tG
full_join(inhpj3,tG,by=c("PlateName","Expe_Analysis_Name_m")) -> inhpj3
cat("Control of well position inconsistencies between A and G")
inhpj3 %>%
  transform(Position_A=str_sub(Position_A,2,-1),
            Position_G=str_sub(Position_G,2,-1)) %>%
  transform(Position_A=as.numeric(Position_A),
            Position_G=as.numeric(Position_G)) %>%
  mutate(`Delta between A and G`=Position_A-Position_G) %>% 
  group_by(`Delta between A and G`) %>%
  dplyr::summarise(numbers=n()) %>% kable()

#Adding H wells (albumin) to previous groups
inhpj2 %>%
  dplyr::filter(str_detect(Position,"H")) %>%
  rename(Position_H=Position,
         CrossingPoint_H=CrossingPoint,
         StatusCodes_H=StatusCodes) -> tH
full_join(inhpj3,tH,by=c("PlateName","Expe_Analysis_Name_m")) -> inhpj3
cat("Control of well position inconsistencies between A and H")
inhpj3 %>%
  transform(Position_A=str_sub(Position_A,2,-1),
            Position_H=str_sub(Position_H,2,-1)) %>%
  transform(Position_A=as.numeric(Position_A),
            Position_H=as.numeric(Position_H)) %>%
  mutate(`Delta between A and H`=Position_A-Position_H) %>% 
  group_by(`Delta between A and H`) %>%
  dplyr::summarise(numbers=n()) %>% kable()
cat("*Nul value of delta was expected for sample in the same column number of the PCR plate except for 7 samples which albumin PCR alone was controlled on a new plate)")
cat(" ")
#Add for each row corresponding to a sample
#the positive (PC) and negative plate controls (NC)
inhpj2 %>%
  dplyr::filter(str_detect(Position,"E12")) %>%
  rename(Position_PC=Position,
         CrossingPoint_PC=CrossingPoint,
         StatusCodes_PC=StatusCodes) -> tPC
full_join(inhpj3,tPC,by="PlateName") -> inhpj3

inhpj2 %>%
  dplyr::filter(str_detect(Position,"E11")) %>%
  rename(Position_NC=Position,
         CrossingPoint_NC=CrossingPoint,
         StatusCodes_NC=StatusCodes) -> tNC

full_join(inhpj3,tNC,by="PlateName") %>%
  select(1:4,7,47,48,8:10,15:17,23:25,31:33,40:42,49:51) %>%
  rename(Experiment.Name=Experiment.Name.x,
         Analysis.Name=Analysis.Name.x,
         SampleName=SampleName.x,
         SampleName_m=SampleName_m.x)-> inhpj3
cat("Number of rows after incrementation of plate positive and negative controls:")
nrow(inhpj3)

cat("Number of rows after joining controls for a same sample on the same row")
nrow(inhpj4)

```

\
  

##Descriptive analysis

###Summary of every analyzed samples

####Table of matrix of the analyzed samples (DXLab raw data)

```{r pj_matrix}
pj %>%
  dplyr::group_by(Matrix,Info_patient) %>%
  count_() %>% kable()
```

\
  

####Table of number of analyzed samples per matrix class

Inhibited samples were defined by difference between inhibition control Cp and plate positive control Cp over 3.

```{r pj_matrix2}
pj%>%
  mutate(BAL=ifelse(Matrix=="Liquide de lavage bronchiolo-alvéolaire",1,0),
         BA=ifelse(Matrix=="Produit d'aspiration bronchique" & Info_patient!="Prélèvement nasal",1,0),
         nose=ifelse(Info_patient=="Prélèvement nasal",1,0),
         sputum=ifelse(Matrix=="Produit d'expectoration",1,0)) %>%
  dplyr::summarise(total=n(),
                   BAL=sum(BAL),
                   `Bronchial aspiration`=sum(BA),
                   `Nasal aspiration`=sum(nose),
                   Sputum=sum(sputum)) %>% kable()

pj%>%
  mutate(BAL=ifelse(Matrix=="Liquide de lavage bronchiolo-alvéolaire",1,0),
         BA=ifelse(Matrix=="Produit d'aspiration bronchique" & Info_patient!="Prélèvement nasal",1,0),
         nose=ifelse(Info_patient=="Prélèvement nasal",1,0),
         sputum=ifelse(Matrix=="Produit d'expectoration",1,0),
         inh=ifelse(CrossingPoint_G.x-CrossingPoint_PC.x>=3,"inhibited","not inh")) %>%
  group_by(inh) %>%
  dplyr::summarise(total=n(),
                   BAL=sum(BAL),
                   `Bronchial aspiration`=sum(BA),
                   `Nasal aspiration`=sum(nose),
                   Sputum=sum(sputum)) %>% kable()


```

\
  
####Table of number of positive samples per matrix class
The numbers of the following table were based on the interpretation communicated to physician
```{r pj_pos_matrix}

pj %>%
  filter(!is.na(Matrix)) %>%
  filter(str_detect(Matrix,"expectoration")) %>%
  mutate(Pos_result= ifelse(str_detect(Conclusion,"Présence")|
                              str_detect(Conclusion,"pneumopathie à P.jiroveci"),1,0),
         Neg_result= ifelse(str_detect(Conclusion,"Absence")|
                              str_detect(Conclusion,"négatif")|
                              str_detect(Conclusion,"acellulaire"),1,0)) %>%
  summarise(Matrix="sputum",
            N_pos=sum(Pos_result),
            N_neg=sum(Neg_result),
            N=n(),
            `Percentage`=sum(Pos_result)/n()*100) -> t01
pj %>%
  filter(!is.na(Matrix)) %>%
  filter(str_detect(Matrix,"bronchiolo")) %>%
  mutate(Pos_result= ifelse(str_detect(Conclusion,"Présence")|
                              str_detect(Conclusion,"pneumopathie à P.jiroveci"),1,0),
         Neg_result= ifelse(str_detect(Conclusion,"Absence")|
                              str_detect(Conclusion,"négatif")|
                              str_detect(Conclusion,"acellulaire"),1,0)) %>%
  summarise(Matrix="BAL",
            N_pos=sum(Pos_result),
            N_neg=sum(Neg_result),
            N=n(),
            `Percentage`=sum(Pos_result)/n()*100) -> t02
bind_rows(t01,t02) -> t01
pj %>%
  filter(!is.na(Matrix)) %>%
  filter(str_detect(Matrix,"aspiration") &
           Info_patient!="Prélèvement nasal") %>%
   mutate(Pos_result= ifelse(str_detect(Conclusion,"Présence")|
                              str_detect(Conclusion,"pneumopathie à P.jiroveci"),1,0),
  Neg_result= ifelse(str_detect(Conclusion,"Absence")|
                              str_detect(Conclusion,"négatif")|
                              str_detect(Conclusion,"acellulaire"),1,0)) %>%
  summarise(Matrix="bronchoaspiration",
            N_pos=sum(Pos_result),
            N_neg=sum(Neg_result),
            N=n(),
            `Percentage`=sum(Pos_result)/n()*100) -> t02
bind_rows(t01,t02) -> t01
pj %>%
  filter(!is.na(Matrix)) %>%
  filter(str_detect(Matrix,"aspiration") &
           Info_patient=="Prélèvement nasal") %>%
  mutate(Pos_result= ifelse(str_detect(Conclusion,"Présence")|
                              str_detect(Conclusion,"pneumopathie à P.jiroveci"),1,0),
         Neg_result= ifelse(str_detect(Conclusion,"Absence")|
                              str_detect(Conclusion,"négatif")|
                              str_detect(Conclusion,"acellulaire"),1,0)) %>%
  summarise(Matrix="nasal swab",
            N_pos=sum(Pos_result),
            N_neg=sum(Neg_result),
            N=n(),
            `Percentage`=sum(Pos_result)/n()*100) -> t02
bind_rows(t01,t02) %>% kable(digits=2)

```


####Cp albumin value per matrix class
We neglected cellularity criterias because only one paucicellular BAL (*i.e.* extracted using TNN method) was analyzed by *Pneumocystis* PCR.


```{r pj_Cp_alb_matrix}

pj %>%
  filter(!is.na(Matrix) & CrossingPoint_H.x<45) %>%
  filter(str_detect(Matrix,"alvéolaire")) %>% 
   summarise(Matrix="BAL",
            N=n(),
            `Mean Cp alb`=mean(CrossingPoint_H.x),
            `SD Cp alb`=sd(CrossingPoint_H.x),
            `Median Cp alb`=median(CrossingPoint_H.x),
            `Min Cp alb`=min(CrossingPoint_H.x),
            `Max Cp alb`=max(CrossingPoint_H.x)) -> t01

pj %>%
  filter(!is.na(Matrix) & CrossingPoint_H.x<45) %>%
  filter(str_detect(Matrix,"aspiration") &
           Info_patient!="Prélèvement nasal") %>% 
  summarise(Matrix="bronchoaspiration",
            N=n(),
            `Mean Cp alb`=mean(CrossingPoint_H.x),
            `SD Cp alb`=sd(CrossingPoint_H.x),
            `Median Cp alb`=median(CrossingPoint_H.x),
            `Min Cp alb`=min(CrossingPoint_H.x),
            `Max Cp alb`=max(CrossingPoint_H.x)) -> t02
bind_rows(t01,t02) -> t01
pj %>%
  filter(!is.na(Matrix) & CrossingPoint_H.x<45) %>%
  filter(str_detect(Matrix,"expectoration") ) %>%
summarise(Matrix="sputum",
          N=n(),
          `Mean Cp alb`=mean(CrossingPoint_H.x),
          `SD Cp alb`=sd(CrossingPoint_H.x),
          `Median Cp alb`=median(CrossingPoint_H.x),
          `Min Cp alb`=min(CrossingPoint_H.x),
          `Max Cp alb`=max(CrossingPoint_H.x)) -> t02
bind_rows(t01,t02) -> t01
pj %>%
  filter(!is.na(Matrix) & CrossingPoint_H.x<45) %>%
  filter(str_detect(Matrix,"aspiration") &
           Info_patient=="Prélèvement nasal") %>% 
  summarise(Matrix="nasal swab",
            N=n(),
            `Mean Cp alb`=mean(CrossingPoint_H.x),
            `SD Cp alb`=sd(CrossingPoint_H.x),
            `Median Cp alb`=median(CrossingPoint_H.x),
            `Min Cp alb`=min(CrossingPoint_H.x),
            `Max Cp alb`=max(CrossingPoint_H.x)) -> t02
bind_rows(t01,t02) %>% kable(digits=2)

````


####Table summarising features of inhibition controls and albumin PCR results of samples

We distinguished here samples analyzed once and twice. Samples analyzed twice corresponded to samples controlled in a new PCR run, generally with 1/10 diluted DNA extract.

```{r pj_twice_features}

#Summarising count of features of inhibition controls of samples analyzed once
pj %>%
  filter(is.na(Experiment.Name.y)) %>% 
  select(SampleName.x,Expe_Analysis_Name.x,CrossingPoint_A.x,
         CrossingPoint_B.x,CrossingPoint_G.x,CrossingPoint_H.x) %>%
  mutate(`G=<35 & H<38`=ifelse(CrossingPoint_G.x<=35 & CrossingPoint_H.x< 38,1,0),
         `G=<35 & H>=38`=ifelse(CrossingPoint_G.x<=35 & CrossingPoint_H.x>=38,1,0),
         `35<G<38 & H<38`=ifelse(CrossingPoint_G.x>35 &
                                     CrossingPoint_G.x<38 & CrossingPoint_H.x<38,1,0),
         `35<G<38 & H>=38`=ifelse(CrossingPoint_G.x>35 &
                                     CrossingPoint_G.x<38 & CrossingPoint_H.x>=38,1,0),
         `G>38 & H<38`=ifelse(CrossingPoint_G.x>38 & CrossingPoint_H.x<38,1,0),
         `G>38 & H>=38`=ifelse(CrossingPoint_G.x>38 & CrossingPoint_H.x>=38,1,0))%>%
  dplyr::summarise(Samples="analyzed once",
                   total=n(),
                   `G=<35 & H<38`=sum(`G=<35 & H<38`),
                   `G=<35 & H>=38`=sum(`G=<35 & H>=38`),
                   `35<G<38 & H<38`=sum(`35<G<38 & H<38`),
                   `35<G<38 & H>=38`=sum(`35<G<38 & H>=38`),
                   `G>38 & H<38`=sum(`G>38 & H<38`),
                   `G>38 & H>=38`=sum(`G>38 & H>=38`)) -> pp1

#Summarising count of features of inhibition controls of samples analyzed twice
pj %>%
  filter(!is.na(Experiment.Name.y)) %>% 
  select(SampleName.x,Expe_Analysis_Name.x,CrossingPoint_A.x,
         CrossingPoint_B.x,CrossingPoint_G.x,CrossingPoint_H.x) %>%
  mutate(`G=<35 & H<38`=ifelse(CrossingPoint_G.x<=35 & CrossingPoint_H.x< 38,1,0),
         `G=<35 & H>=38`=ifelse(CrossingPoint_G.x<=35 & CrossingPoint_H.x>=38,1,0),
         `35<G<38 & H<38`=ifelse(CrossingPoint_G.x>35 &
                                     CrossingPoint_G.x<38 & CrossingPoint_H.x<38,1,0),
         `35<G<38 & H>=38`=ifelse(CrossingPoint_G.x>35 &
                                     CrossingPoint_G.x<38 & CrossingPoint_H.x>=38,1,0),
         `G>38 & H<38`=ifelse(CrossingPoint_G.x>38 & CrossingPoint_H.x<38,1,0),
         `G>38 & H>=38`=ifelse(CrossingPoint_G.x>38 & CrossingPoint_H.x>=38,1,0))%>%
  dplyr::summarise(Samples="analyzed once",
                   total=n(),
                   `G=<35 & H<38`=sum(`G=<35 & H<38`),
                   `G=<35 & H>=38`=sum(`G=<35 & H>=38`),
                   `35<G<38 & H<38`=sum(`35<G<38 & H<38`),
                   `35<G<38 & H>=38`=sum(`35<G<38 & H>=38`),
                   `G>38 & H<38`=sum(`G>38 & H<38`),
                   `G>38 & H>=38`=sum(`G>38 & H>=38`)) -> pp2

#Grouping them into only one table
dplyr::union(pp1,pp2) %>% kable()
```

\
  

###Flow chart

A flow chart summarising data managing and motives of control for samples analyzed twice was built
using DiagrammeR library. The following code permits to build it in RStudio or from Rmarkdown knited to html but could not be executed when knited to Word.

```{r pj_flow_chart,eval=F, echo=F}
library(DiagrammeR)
#Calculation of number of all analyzed samples 
c3_1<-pj %>% filter(!is.na(Matrix)) %>% nrow()
#Code for this box: paste0('Tidying into dataframe\\n','with one row per sample:\\n',c3_1,'samples')

#Calculation of number of samples excluded owing to no bio clinical data in DxLab
c3_2<-pj %>% filter(is.na(Matrix)) %>%nrow()
#Code for this box: paste0(c3_2,'samples excluded\\n ','owing to absence of\\n ',' bioclinical informations')

#Calculation of number of samples analyzed twice
c4_1<-pj %>% filter(!is.na(Matrix) & !is.na(Experiment.Name.y)) %>%
  nrow()

#Calculation of number of samples analyzed once
c4_2<-pj %>% filter(!is.na(Matrix) & is.na(Experiment.Name.y)) %>%
  nrow()

#Calculation of number of fickly positive samples analyzed twice 
c5_1<- pj %>% filter(!is.na(Matrix) & !is.na(Experiment.Name.y)) %>%
  filter(CrossingPoint_A.x<54 | CrossingPoint_B.x<54) %>% nrow()
#Code for this box: paste0(c5_1,'fickly positive samples\\n ','analyzed twice')


#Calculation of number of negative samples analyzed twice
c5_2<- pj %>% filter(!is.na(Matrix) & !is.na(Experiment.Name.y)) %>%
  filter(CrossingPoint_G.x-CrossingPoint_PC.x >3 |
           CrossingPoint_H.x>=28) %>% nrow()
#Code for this box: paste0(c5_2,'negative samples\\n ','analyzed twice and\\n ','controlled 1/10 diluted')

#Calculation of number of all samples analyzed once with albu >28
c5_3<-pj %>% filter(!is.na(Matrix) & is.na(Experiment.Name.y) &
                      CrossingPoint_H.x>=28) %>% nrow()
#Code for this box: paste(c5_3,'samples with\\n ','albu >28 owing\\n ','to missing extract')

#Calculation of number of all samples analyzed once with IC-PPC >3
c5_4<-pj %>% filter(!is.na(Matrix) & is.na(Experiment.Name.y) &
                      CrossingPoint_G.x-CrossingPoint_PC.x >3) %>%
  nrow()
#Code for this box: paste(c5_4,'samples with\\n ','IC-PPC >3')

#Calculation of number of samples analyzed twice owing to fickly positive and controlled undiluted
c6_1<- pj %>% filter(!is.na(Matrix) & !is.na(Experiment.Name.y) &
                       CrossingPoint_G.x-CrossingPoint_PC.x<3 &
                       CrossingPoint_H.x<28) %>%
  filter(CrossingPoint_A.x<54 | CrossingPoint_B.x<54) %>% nrow()
#Code for this box: paste(c6_1,'samples with\\n ','IC-PPC <3\\n ','and albu <28\\n ','controlled undiluted')

#Calculation of number of samples analyzed twice owing to fickly positive and controlled diluted
c6_2<-pj %>% filter(!is.na(Matrix) & !is.na(Experiment.Name.y) &
                      CrossingPoint_G.x-CrossingPoint_PC.x>=3 &
                      CrossingPoint_H.x<28) %>%
  filter(CrossingPoint_A.x<54 | CrossingPoint_B.x<54) %>% nrow()
#Code for this box: paste(c6_2,'sample with\\n ','IC-PPC >3\\n ','and albu <28\\n ','controlled 1/10 diluted')

#Calculation of number of negative samples analyzed twice with IC-PPC >3 and albu<28
c6_3<-pj %>% filter(!is.na(Matrix) & !is.na(Experiment.Name.y) &
                      CrossingPoint_G.x-CrossingPoint_PC.x>=3 &
                      CrossingPoint_H.x<28) %>%
  filter(CrossingPoint_A.x>54 | CrossingPoint_B.x>54) %>% nrow()
#Code for this box: paste(c6_3,'samples with\\n ','IC-PPC >3\\n ','and albu <28\\n')

#Calculation of number of negative samples analyzed twice with IC-PPC <3 and albu>28
c6_4<-pj %>% filter(!is.na(Matrix) & !is.na(Experiment.Name.y) &
                      CrossingPoint_G.x-CrossingPoint_PC.x<3 &
                      CrossingPoint_H.x>=28) %>%
  filter(CrossingPoint_A.x>54 | CrossingPoint_B.x>54) %>% nrow()
#Code for this box: paste(c6_4,'samples with\\n ','IC-PPC <3\\n ','and albu >28\\n')

#Calculation of number of negative samples analyzed twice with IC-PPC <3 and albu>28
c6_5<-pj %>% filter(!is.na(Matrix) & !is.na(Experiment.Name.y) &
                      CrossingPoint_G.x-CrossingPoint_PC.x>=3 &
                      CrossingPoint_H.x>=28) %>%
  filter(CrossingPoint_A.x>54 | CrossingPoint_B.x>54) %>% nrow()
#Code for this box: paste(c6_5,'samples with\\n ','IC-PPC >3\\n ','and albu >28\\n')

#Building the chart flow
grViz("
      digraph a_nice_graph {
      graph [layout = dot,rankdir = TB]
      node [fontname = Arial,shape=squarel]
      a [label = '@@1']
      b [label = '@@2']
      node [fontname = Arial,shape=square]
      c [label = '@@3-1']
      c2[label = '@@3-2']
      node [fontname = Arial,shape=square]
      d [label = '@@4-1']
      e [label = '@@4-2']
      node [fontname = Arial,shape=square]
      f1 [label = '@@5-1']
      f2 [label = '@@5-2']
      g1 [label = '@@5-3']
      g2 [label = '@@5-4']
      node [fontname = Arial,shape=square]
      h1 [label = '@@6-1']
      h2 [label = '@@6-2']
      i1 [label = '@@6-3']
      i2 [label = '@@6-4']
      i3 [label = '@@6-5']
      a-> b
      b-> {c,c2}
      c-> {d,e}
      d-> {f1,f2}
      e-> {g1,g2}
      f1-> {h1,h2}
      f2->{i1,i2,i3}
      
      }
      [1]: paste0('Automated extraction from LC software:\\n',nrow(inhpj),' PCR results')
      [2]: paste0('Preliminary data cleaning:\\n',nrow(inhpj2),' PCR results')
      [3]: c(paste0('Tidying into dataframe\\n','with one row per sample:\\n',c3_1,' samples'),paste0(c3_2,' samples excluded\\n ',' owing to absence of\\n ',' bioclinical informations'))
      [4]: c(paste0(c4_1,' samples\\n ','analyzed twice'),paste0(c4_2,' samples\\n ','analyzed once'))
      [5]: c(paste0(c5_1,' fickly positive samples\\n ','analyzed twice'),paste0(c5_2,' negative samples\\n ','analyzed twice and\\n ','controlled 1/10 diluted'),paste(c5_3,' samples with\\n ','albu >28 owing\\n ','to missing extract'),paste(c5_4,' samples with\\n ','IC-PPC >3'))
      [6]: c(paste(c6_1,'samples with\\n ','IC-PPC <3\\n ','and albu <28\\n ','controlled undiluted'),paste(c6_2,'sample with\\n ','IC-PPC >3\\n ','and albu <28\\n ','controlled 1/10 diluted'),paste(c6_3,' samples with\\n ','IC-PPC >3\\n ','and albu <28\\n'),paste(c6_4,'samples with\\n ','IC-PPC <3\\n ','and albu >28\\n'),paste(c6_5,'samples with\\n ','IC-PPC >3\\n ','and albu >28\\n'))
      ")
```

\
  

###Samples analyzed twice

Samples analyzed twice corresponded to **`r pj%>%filter(!is.na(Experiment.Name.y))%>%nrow()` different samples**, detailled below.

\
  

####Table summarising matrix of samples analyzed twice

```{r pj_twice_matrix}
pj%>%
  filter(!is.na(Experiment.Name.y) & !is.na(Matrix)) %>%
mutate(BAL=ifelse(Matrix=="Liquide de lavage bronchiolo-alvéolaire",1,0),
       BA=ifelse(Matrix=="Produit d'aspiration bronchique" & Info_patient!="Prélèvement nasal",1,0),
       nose=ifelse(Info_patient=="Prélèvement nasal",1,0),
       sputum=ifelse(Matrix=="Produit d'expectoration",1,0)) %>%
  dplyr::summarise(` `="Analyzed twice",
                   total=n(),
                   BAL=sum(BAL),
                   `Bronchial aspiration`=sum(BA),
                   `Nasal aspiration`=sum(nose),
                   Sputum=sum(sputum)) -> t01

pj%>%
  filter(!is.na(Matrix)) %>%
  mutate(BAL=ifelse(Matrix=="Liquide de lavage bronchiolo-alvéolaire",1,0),
         BA=ifelse(Matrix=="Produit d'aspiration bronchique" & Info_patient!="Prélèvement nasal",1,0),
         nose=ifelse(Info_patient=="Prélèvement nasal",1,0),
         sputum=ifelse(Matrix=="Produit d'expectoration",1,0)) %>%
  dplyr::summarise(` `="All samples",
                   total=n(),
                   BAL=sum(BAL),
                   `Bronchial aspiration`=sum(BA),
                   `Nasal aspiration`=sum(nose),
                   Sputum=sum(sputum)) -> t02


bind_rows(t01,t02) %>% kable()
```

\
  

####Summary of arguments justifying control for samples analyzed twice

A non valid inhibition control (IC) was defined by a difference of Cp between the IC and the plate positive control (PC) above or equal to 3. This difference was named "IC-PC" below.Only one sample (Sample Name 1603078), detailled in the table below had no reliable argument justifying a control; that was the negative sample with IC-PC < 3 and albumin PCR < 28. Besides it was controlled undiluted, so we excluded it for next analysis.

```{r pj_sum_twice_args}
   pj %>%
    filter(!is.na(Experiment.Name.y)) %>%
    mutate(Ficklypos=ifelse(CrossingPoint_A.x<54 | CrossingPoint_B.x<54,1,0)) %>%
      mutate(TIPCsup_alone=ifelse(CrossingPoint_G.x-CrossingPoint_PC.x>=3 &
                                   CrossingPoint_H.x<28,1,0),
              TIPCsup3_alb28=ifelse(CrossingPoint_G.x-CrossingPoint_PC.x>=3 &
                                     CrossingPoint_H.x>=28 ,1,0),
            albusup28_alone=ifelse(CrossingPoint_G.x-CrossingPoint_PC.x<3 &
                                   CrossingPoint_H.x>=28,1,0),
            ficklypos_alone=ifelse(Ficklypos==1 & CrossingPoint_G.x-CrossingPoint_PC.x<3 &
                                    CrossingPoint_H.x<28 & SampleName_m!=1603078,1,0),
            None=ifelse(CrossingPoint_A.x==55 & CrossingPoint_B.x==55 &
                        CrossingPoint_G.x-CrossingPoint_PC.x<3 &
                                   CrossingPoint_H.x<28,1,0),
            flat_TIcurve=ifelse(SampleName_m==1603078,1,0)) %>%
    summarise(` `="All samples",
              total=n(),
              `IC-PC >= 3 & Alb < 28`= sum(TIPCsup_alone),
              `IC-PC >= 3 & Alb > 28`= sum(TIPCsup3_alb28),
              `IC-PC < 3 & Alb > 28`= sum(albusup28_alone),
              `Fickly positive`= sum(ficklypos_alone),
              `Flat IC curve`=sum(flat_TIcurve),
              `None`=sum(None)) %>% kable()

```

\
  

#### Summary of argument and matrix of samples analyzed twice

```{r pj_twice_args_matrix}
pj %>%
  filter(!is.na(Experiment.Name.y)) %>%
  mutate(m_class=ifelse(Matrix=="Liquide de lavage bronchiolo-alvéolaire","BAL","other")) %>%
  transform(m_class=ifelse(Matrix=="Produit d'aspiration bronchique" & 
                             Info_patient!="Prélèvement nasal","BA",m_class)) %>%
  transform(m_class=ifelse(Info_patient=="Prélèvement nasal","nose",m_class)) %>%
  transform(m_class=ifelse(Matrix=="Produit d'expectoration","sputum",m_class)) %>%
  mutate(Ficklypos=ifelse(CrossingPoint_A.x<54 | CrossingPoint_B.x<54,1,0)) %>%
  mutate(TIPCsup_alone=ifelse(CrossingPoint_G.x-CrossingPoint_PC.x>=3 &
                                CrossingPoint_H.x<28,1,0),
         TIPCsup3_alb28=ifelse(CrossingPoint_G.x-CrossingPoint_PC.x>=3 &
                                 CrossingPoint_H.x>=28 ,1,0),
         albusup28_alone=ifelse(CrossingPoint_G.x-CrossingPoint_PC.x<3 &
                                  CrossingPoint_H.x>=28,1,0),
         ficklypos_alone=ifelse(Ficklypos==1 &CrossingPoint_G.x-CrossingPoint_PC.x<3 &
                                  CrossingPoint_H.x<28 & SampleName_m!=1603078,1,0),
         None=ifelse(CrossingPoint_A.x==55 & CrossingPoint_B.x==55 &
                       CrossingPoint_G.x-CrossingPoint_PC.x<3 &
                       CrossingPoint_H.x<28,1,0),
         flat_TIcurve=ifelse(SampleName_m==1603078,1,0)) %>%
  group_by(m_class) %>%
  summarise(` `="All samples",
            total=n(),
            `IC-PC >= 3 & Alb < 28`= sum(TIPCsup_alone),
            `IC-PC >= 3 & Alb > 28`= sum(TIPCsup3_alb28),
            `IC-PC < 3 & Alb > 28`= sum(albusup28_alone),
            `Fickly positive`= sum(ficklypos_alone),
            `Flat IC curve`=sum(flat_TIcurve),
            `None`=sum(None)) %>% kable()
```

\
  

####Summary of inhibited samples analyzed twice

According to IC-PC > 3; **`r pj %>% filter(CrossingPoint_G.x-CrossingPoint_PC.x>=3) %>% nrow()` samples were inhibited**. After dilution, PCR efficiency was restored for all samples, as summarised below:

```{r pj_inh_restor}
pj %>%
  filter(CrossingPoint_G.x-CrossingPoint_PC.x>=3) %>%
  mutate(`Effect of 1/10 dilution on efficiency`=ifelse(CrossingPoint_G.y-CrossingPoint_PC.y>=3,"inhibition persistence: IC-PC >=3","efficiency restoration: IC-PC <3")) %>%
  group_by(`Effect of 1/10 dilution on efficiency`) %>%
  summarise(`N(samples)`=n()) %>%
  kable()
```

\
  

###Samples analyzed once

####Table of samples analyzed once with Cp(IT)-Cp(PC) >= 3

```{r pj_once_ICPC}
 pj %>%
    filter( CrossingPoint_G.x-CrossingPoint_PC.x>=3) %>%
    filter(is.na(Experiment.Name.y)) %>%
    select(1,3,15,22,69,70) %>% kable(digits=1)
```

\
  

####Table of samples analyzed once with Cp>38 for albumin PCR

```{r pj_once_alb}
pj %>%
  filter( CrossingPoint_H.x>=38) %>%
  filter(is.na(Experiment.Name.y)) %>%
  select(1,3,15,18,69,70) %>% kable(digits=1)
```

\
  

####Table of samples analyzed once with 38 >= Cp > 28 for albumin PCR

The following samples were analyzed only once because we did not find the DNA extract to control them.

```{r pj_once_28_38}
pj %>%
    filter( CrossingPoint_H.x>=28) %>%
    filter(is.na(Experiment.Name.y)) %>%
    mutate(paucicellular=ifelse(str_detect(Conclusion,"cellulaire") |
              str_detect(Conclusion_other,"cellulaire"),1,0)) %>%
    select(1,3,15,18,69,70,75) %>%
    arrange(paucicellular) %>%
    kable(digits=1)
```

\
  

### Summary of delta Cp of PCR albumin

```{r delta_alb_table_tg}
pj %>%
  filter(!is.na(Experiment.Name.y)) %>%
  mutate( AC=ifelse(CrossingPoint_G.x-CrossingPoint_PC.x>=3, "inhibited","not inh"),
          Albu=ifelse(CrossingPoint_H.x<38 & CrossingPoint_H.x>=28 , "28_38","other"),
          Albu_diluted=ifelse(CrossingPoint_H.y<38 & CrossingPoint_H.y>=28 , "28_38","other"),
          delta_albu=ifelse(CrossingPoint_H.y-CrossingPoint_H.x>3, ">3", "1_3")) %>%
  transform( Albu=ifelse(Albu=="other" & CrossingPoint_H.x>=38, ">=38",Albu),
             Albu_diluted=ifelse(Albu_diluted=="other" & CrossingPoint_H.y>=38,
                                 ">=38",Albu_diluted),
             delta_albu=ifelse(CrossingPoint_H.y-CrossingPoint_H.x<1, "1",delta_albu)) %>%
  transform( Albu=ifelse(Albu=="other" & CrossingPoint_H.x<28, "<28",Albu),
             Albu_diluted=ifelse(Albu_diluted=="other" & CrossingPoint_H.y<28, "<28",Albu_diluted)) %>%
  group_by(AC,Albu, Albu_diluted, delta_albu) %>%
  summarise(Number=n()) %>% kable()
```

\


Ac (amplification control) was defined as inhibited if Cp(AC)-Cp(positive plate control) >=3.
PCR of albumin of undiluted (Cp_Albu) and undiluted extracts (Cp_albu_diluted) were classified regarding Cp value.
Delta Cp of PCR albumin was determined by Cp(diluted)-Cp(undiluted), so:

* delta_albu>3 corresponded to absence of inhibition of PCR albumine

* delta_albu<1 corresponded to presence of inhibition of PCR albumine

* 1<=delta_albu<=3 corresponded to a gray zone 


\


##Statistical inductions

###Comparison of sensitivity and specificity to detect PCR inhibitors

The inhibition control was considered as the gold standard for inhibition assertion.Inhibition control was considered as inhibited if had Cp(IC)-Cp(PC) > 3 for one sample.
We compared the sensitivity and specificity of albumin PCR to detect inhibitors to the frequency 0.95 because we defined a good inhibition screening method as a method with at least 95 % accurate detection of inhibitors. The following analysis were performed on **`r nrow(pj)` different samples**.

First we defined the Cp cut-off value of albumin PCR by the Cp value with the highest Youden's index:

```{r youden_pj}
#Defining the function to calculate Youden index taking account nul sensitivity for some Cp
pjy<-function(Ct) {pj %>%
  mutate(IC=ifelse(CrossingPoint_G.x-CrossingPoint_PC.x>=3,"inh","ok"),
         albu28=ifelse(CrossingPoint_H.x>=Ct,"inh","ok")) %>%
 mutate(TP=ifelse(albu28=="inh" & IC=="inh",1,0),
         FP=ifelse(albu28=="inh" & IC=="ok",1,0),
         FN=ifelse(albu28=="ok" & IC=="inh",1,0),
         TN=ifelse(albu28=="ok" & IC=="ok",1,0)) %>%
  dplyr::summarise(TP=sum(TP),
                   FP=sum(FP),
                   FN=sum(FN),
                   TN=sum(TN)) %>% 
  summarise(threshold=Ct,
            Youden=TN/(TN+FP)+TP/(TP+FN)-1) -> cval
  cval$Youden}

#Defining and priming the repeated Youden index calculation
k<-c()
Ct<-20
Cti<-20
int<-0.1
Ctfin<-45
repeat {
  append(k,pjy(Ct))->k
  Ct<-Ct+int
  if(Ct>Ctfin) break }
l<-seq(from=Cti,to=Ctfin-int,by=int)

#Summarising them in a graph
mytitle <- expression(paste(italic("Pneumocystis"), " PCR"))
ggplot()+
  geom_step(aes(x=l,y=k))+
  theme_classic(base_size=8)+
  xlab("albumin PCR Cp")+
  ylab("Youden's index")+
  coord_fixed(ratio=100)+
  ggtitle(mytitle)

#Giving the value of Cp with maximal Youden index
df<-data.frame(l,k)
df %>%
  summarise(M=max(k)) -> youmax
df %>%
  filter(k==youmax$M) %>%
rename(`Corresponding Cp`=l,`Maximal Youden index`=k) %>% kable()

```

\
In regard to low value of Youden index, we had a look of sensitivity and specificity in function of Cp cut-off value to research another interesting cut-off value:


```{r sens_spe_pj_graph}
#Creation of functions for calculation of sensitivity and specificity
pjsen<-function(Ct) {pj %>%
  mutate(IC=ifelse(CrossingPoint_G.x-CrossingPoint_PC.x>=3,"inh","ok"),
         albu28=ifelse(CrossingPoint_H.x>=Ct,"inh","ok")) %>%
  mutate(class=ifelse(albu28=="inh" & IC=="inh","TP","other")) %>%
  transform(class=ifelse(albu28=="inh" & IC=="ok","FP",class)) %>%
  transform(class=ifelse(albu28=="ok" & IC=="inh","FN",class)) %>%
  transform(class=ifelse(albu28=="ok" & IC=="ok","TN",class)) %>%
  group_by(class) %>%
  dplyr::summarise(n=n()) %>%
  spread(class,n) -> cval
  if ("TP" %in% colnames(cval)) {cval$TP/(cval$FN+cval$TP)} else {0}}

pjspe<-function(Ct) {pj %>%
    mutate(IC=ifelse(CrossingPoint_G.x-CrossingPoint_PC.x>=3,"inh","ok"),
           albu28=ifelse(CrossingPoint_H.x>=Ct,"inh","ok")) %>%
    mutate(class=ifelse(albu28=="inh" & IC=="inh","TP","other")) %>%
    transform(class=ifelse(albu28=="inh" & IC=="ok","FP",class)) %>%
    transform(class=ifelse(albu28=="ok" & IC=="inh","FN",class)) %>%
    transform(class=ifelse(albu28=="ok" & IC=="ok","TN",class)) %>%
    group_by(class) %>%
    dplyr::summarise(n=n()) %>%
    spread(class,n) -> cval
  if ("TN" %in% colnames(cval)) {cval$TN/(cval$FP+cval$TN)} else {0}}

#Defining parameters for these functions and priming them
ksen<-c()
Ct<- 18
Cti<- 18
int<- 0.5
Ctfin<- 45

#Defining the corresponding Cp interval
l<-seq(from=Cti,to=Ctfin,by=int)

#Repeating sensitivity calculation for the defined Cp interval
repeat {
  append(ksen,pjsen(Ct))->ksen
  Ct<-Ct+int
  if(Ct>Ctfin) break }
#Inserting results in a tibble
tibble(l,ksen) %>%
  rename(value=ksen) %>%
  mutate(parameter="sensitivity") -> sen


#Repeating specificity calculation for the defined Cp interval
kspe<- c()
Ct<- 18
repeat {
  append(kspe,pjspe(Ct))->kspe
  Ct<-Ct+int
  if(Ct>Ctfin) break }

#Inserting results in a tibble
tibble(l,kspe) %>%
  rename(value=kspe) %>%
  mutate(parameter="specificity") -> spe

#Merging and ploting them
mytitle <- expression(paste(italic("Pneumocystis"), " PCR"))
bind_rows(sen,spe) %>%
  ggplot()+
  geom_step(aes(x=l,y=value,col=parameter))+
  theme_classic(base_size=8)+
  xlab("albumin PCR Cp cut-off")+
  ylab("Sensitivity/Specificity")+
  coord_fixed(ratio=30)+
  ggtitle(mytitle)

```

\
This second graph proposed the same cut-off value than  for the maximal Youden index.
We next calculated specificity and sensitivity to this defined cut-off value and compared them to the previously fixed 0.95 frequency.

```{r sens_spe_pj}
#Comparison of inhibited results for Pneumocystis PCR
#Qualitative comparisons
pj %>%
  mutate(IC=ifelse(CrossingPoint_G.x-CrossingPoint_PC.x>=3,"inh","ok"),
         albu22=ifelse(CrossingPoint_H.x>=22,"inh","ok"))%>%
 mutate(TP=ifelse(albu22=="inh" & IC=="inh",1,0),
         FP=ifelse(albu22=="inh" & IC=="ok",1,0),
         FN=ifelse(albu22=="ok" & IC=="inh",1,0),
         TN=ifelse(albu22=="ok" & IC=="ok",1,0)) %>%
  dplyr::summarise(TP=sum(TP),
                   FP=sum(FP),
                   FN=sum(FN),
                   TN=sum(TN)) -> cval
  
#Summarising sensitivity and specificity values
Percentage<-c(cval$TP/(cval$TP+cval$FN)*100,cval$TN/(cval$TN+cval$FP)*100)
Parameter<-c("sensitivity", "specificity")
data_frame(Parameter, Percentage) %>% kable(digits=1)

#Comparison of sensitivity of albumin PCR to a theorical value: 0.95
#Not necessary because no true positive
psen<-pval(stats::binom.test(x=0,n=0+cval$FN,
                             p=0.95,alternative="less"))

#Comparison of specificity of albumin PCR to a theorical value: 0.95
pspe<-pval(stats::binom.test(x=cval$TN,n=cval$TN+cval$FP,
                             p=0.95,alternative="less"))

#Summary of results
p_value<-c(psen,pspe)
Binomial_test<-c("sensitivity", "specificity")
data_frame(Binomial_test,p_value) %>% kable(digits=50)
```

Alternative hypothesis: Sensitivity/specificity of albumin  PCR to detect inhibitors is under 95 %.

\

 
### Graphical analysis to search an optimal Cp cut off value per matrix

#### Sputum
```{r pj_sputum}
pjy<-function(Ct) {pj %>%
    filter(Matrix=="Produit d'expectoration") %>%
    mutate(IC=ifelse(CrossingPoint_G.x-CrossingPoint_PC.x>=3,"inh","ok"),
           albu28=ifelse(CrossingPoint_H.x>=Ct,"inh","ok")) %>%
    mutate(TP=ifelse(albu28=="inh" & IC=="inh",1,0),
           FP=ifelse(albu28=="inh" & IC=="ok",1,0),
           FN=ifelse(albu28=="ok" & IC=="inh",1,0),
           TN=ifelse(albu28=="ok" & IC=="ok",1,0)) %>%
    dplyr::summarise(TP=sum(TP),
                     FP=sum(FP),
                     FN=sum(FN),
                     TN=sum(TN)) %>% 
    summarise(threshold=Ct,
              Youden=TN/(TN+FP)+TP/(TP+FN)-1) -> cval
  cval$Youden}

#Defining and priming the repeated Youden index calculation
k<-c()
Ct<-20
Cti<-20
int<-0.1
Ctfin<-45
repeat {
  append(k,pjy(Ct))->k
  Ct<-Ct+int
  if(Ct>Ctfin) break }
l<-seq(from=Cti,to=Ctfin-int,by=int)

#Summarising them in a graph
mytitle <- expression(paste(italic("Pneumocystis"), " PCR for sputum"))
ggplot()+
  geom_step(aes(x=l,y=k))+
  theme_classic(base_size=10)+
  xlab("albumin PCR Cp")+
  ylab("Youden's index")+
  ggtitle(mytitle)

pjsen<-function(Ct) {pj %>%
      filter(Matrix=="Produit d'expectoration") %>%
      mutate(IC=ifelse(CrossingPoint_G.x-CrossingPoint_PC.x>=3,"inh","ok"),
             albu28=ifelse(CrossingPoint_H.x>=Ct,"inh","ok")) %>%
      mutate(TP=ifelse(albu28=="inh" & IC=="inh",1,0),
             TN=ifelse(albu28=="ok" & IC=="ok",1,0),
             FP=ifelse(albu28=="inh" & IC=="ok",1,0),
             FN=ifelse(albu28=="ok" & IC=="inh",1,0)) %>%
      summarise(TP=sum(TP),
                TN=sum(TN),
                FP=sum(FP),
                FN=sum(FN))%>%
    summarise(sen=TP/(FN+TP))-> cval
  cval$sen}

pjspe<-function(Ct) {pj %>%
    filter(Matrix=="Produit d'expectoration") %>%
    mutate(IC=ifelse(CrossingPoint_G.x-CrossingPoint_PC.x>=3,"inh","ok"),
           albu28=ifelse(CrossingPoint_H.x>=Ct,"inh","ok")) %>%
    mutate(TP=ifelse(albu28=="inh" & IC=="inh",1,0),
           TN=ifelse(albu28=="ok" & IC=="ok",1,0),
           FP=ifelse(albu28=="inh" & IC=="ok",1,0),
           FN=ifelse(albu28=="ok" & IC=="inh",1,0)) %>% 
    summarise(TP=sum(TP),
              TN=sum(TN),
              FP=sum(FP),
              FN=sum(FN)) %>%
    summarise(spe=TN/(FP+TN))-> cval
  cval$spe}

#Defining parameters for these functions and priming them
ksen<-c()
Ct<- 18
Cti<- 18
int<- 0.5
Ctfin<- 45

#Defining the corresponding Cp interval
l<-seq(from=Cti,to=Ctfin,by=int)

#Repeating sensitivity calculation for the defined Cp interval
repeat {
  append(ksen,pjsen(Ct))->ksen
  Ct<-Ct+int
  if(Ct>Ctfin) break }
#Inserting results in a tibble
tibble(l,ksen) %>%
  rename(value=ksen) %>%
  mutate(parameter="sensitivity") -> sen


#Repeating specificity calculation for the defined Cp interval
kspe<- c()
Ct<- 18
repeat {
  append(kspe,pjspe(Ct))->kspe
  Ct<-Ct+int
  if(Ct>Ctfin) break }

#Inserting results in a tibble
tibble(l,kspe) %>%
  rename(value=kspe) %>%
  mutate(parameter="specificity") -> spe

#Merging and ploting them
mytitle <- expression(paste(italic("Pneumocystis"), " PCR for sputum"))
bind_rows(sen,spe) %>%
  ggplot()+
  geom_step(aes(x=l,y=value,col=parameter))+
  theme_classic(base_size=10)+
  xlab("albumin PCR Cp cut-off")+
  ylab("Sensitivity/Specificity")+
  ggtitle(mytitle)

```


#### BAL
```{r pj_bal}

pjy<-function(Ct) {pj %>%
    filter(Matrix=="Liquide de lavage bronchiolo-alvéolaire") %>%
    mutate(IC=ifelse(CrossingPoint_G.x-CrossingPoint_PC.x>=3,"inh","ok"),
           albu28=ifelse(CrossingPoint_H.x>=Ct,"inh","ok")) %>%
    mutate(TP=ifelse(albu28=="inh" & IC=="inh",1,0),
           FP=ifelse(albu28=="inh" & IC=="ok",1,0),
           FN=ifelse(albu28=="ok" & IC=="inh",1,0),
           TN=ifelse(albu28=="ok" & IC=="ok",1,0)) %>%
    dplyr::summarise(TP=sum(TP),
                     FP=sum(FP),
                     FN=sum(FN),
                     TN=sum(TN)) %>% 
    summarise(threshold=Ct,
              Youden=TN/(TN+FP)+TP/(TP+FN)-1) -> cval
  cval$Youden}

#Defining and priming the repeated Youden index calculation
k<-c()
Ct<-20
Cti<-20
int<-0.1
Ctfin<-45
repeat {
  append(k,pjy(Ct))->k
  Ct<-Ct+int
  if(Ct>Ctfin) break }
l<-seq(from=Cti,to=Ctfin-int,by=int)

#Summarising them in a graph
mytitle <- expression(paste(italic("Pneumocystis"), " PCR for BAL"))
ggplot()+
  geom_step(aes(x=l,y=k))+
  theme_classic(base_size=10)+
  xlab("albumin PCR Cp")+
  ylab("Youden's index")+
  ggtitle(mytitle)

pjsen<-function(Ct) {pj %>%
    filter(Matrix=="Liquide de lavage bronchiolo-alvéolaire") %>%
    mutate(IC=ifelse(CrossingPoint_G.x-CrossingPoint_PC.x>=3,"inh","ok"),
           albu28=ifelse(CrossingPoint_H.x>=Ct,"inh","ok")) %>%
    mutate(class=ifelse(albu28=="inh" & IC=="inh","TP","other")) %>%
    transform(class=ifelse(albu28=="inh" & IC=="ok","FP",class)) %>%
    transform(class=ifelse(albu28=="ok" & IC=="inh","FN",class)) %>%
    transform(class=ifelse(albu28=="ok" & IC=="ok","TN",class)) %>%
    group_by(class) %>%
    dplyr::summarise(n=n()) %>%
    spread(class,n) -> cval
  if ("TP" %in% colnames(cval)) {cval$TP/(cval$FN+cval$TP)} else {0}}

pjspe<-function(Ct) {pj %>%
    filter(Matrix=="Liquide de lavage bronchiolo-alvéolaire") %>%
    mutate(IC=ifelse(CrossingPoint_G.x-CrossingPoint_PC.x>=3,"inh","ok"),
           albu28=ifelse(CrossingPoint_H.x>=Ct,"inh","ok")) %>%
    mutate(class=ifelse(albu28=="inh" & IC=="inh","TP","other")) %>%
    transform(class=ifelse(albu28=="inh" & IC=="ok","FP",class)) %>%
    transform(class=ifelse(albu28=="ok" & IC=="inh","FN",class)) %>%
    transform(class=ifelse(albu28=="ok" & IC=="ok","TN",class)) %>%
    group_by(class) %>%
    dplyr::summarise(n=n()) %>%
    spread(class,n) -> cval
  if ("TN" %in% colnames(cval)) {cval$TN/(cval$FP+cval$TN)} else {0}}

#Defining parameters for these functions and priming them
ksen<-c()
Ct<- 18
Cti<- 18
int<- 0.5
Ctfin<- 45

#Defining the corresponding Cp interval
l<-seq(from=Cti,to=Ctfin,by=int)

#Repeating sensitivity calculation for the defined Cp interval
repeat {
  append(ksen,pjsen(Ct))->ksen
  Ct<-Ct+int
  if(Ct>Ctfin) break }
#Inserting results in a tibble
tibble(l,ksen) %>%
  rename(value=ksen) %>%
  mutate(parameter="sensitivity") -> sen


#Repeating specificity calculation for the defined Cp interval
kspe<- c()
Ct<- 18
repeat {
  append(kspe,pjspe(Ct))->kspe
  Ct<-Ct+int
  if(Ct>Ctfin) break }

#Inserting results in a tibble
tibble(l,kspe) %>%
  rename(value=kspe) %>%
  mutate(parameter="specificity") -> spe

#Merging and ploting them
mytitle <- expression(paste(italic("Pneumocystis"), " PCR for BAL"))
bind_rows(sen,spe) %>%
  ggplot()+
  geom_step(aes(x=l,y=value,col=parameter))+
  theme_classic(base_size=10)+
  xlab("albumin PCR Cp cut-off")+
  ylab("Sensitivity/Specificity")+
  ggtitle(mytitle)
  
```
  

#### Bronchoaspiration
```{r pj_brochoasp}
pjy<-function(Ct) {pj %>%
    filter(Matrix=="Produit d'aspiration bronchique" &
             Info_patient!="Prélèvement nasal") %>%
    mutate(IC=ifelse(CrossingPoint_G.x-CrossingPoint_PC.x>=3,"inh","ok"),
           albu28=ifelse(CrossingPoint_H.x>=Ct,"inh","ok")) %>%
    mutate(TP=ifelse(albu28=="inh" & IC=="inh",1,0),
           FP=ifelse(albu28=="inh" & IC=="ok",1,0),
           FN=ifelse(albu28=="ok" & IC=="inh",1,0),
           TN=ifelse(albu28=="ok" & IC=="ok",1,0)) %>% 
    dplyr::summarise(TP=sum(TP),
                     FP=sum(FP),
                     FN=sum(FN),
                     TN=sum(TN)) %>% 
    summarise(Youden=TN/(TN+FP)+TP/(TP+FN)-1) -> cval
  cval$Youden}

#Defining and priming the repeated Youden index calculation
k<-c()
Ct<-20
Cti<-20
int<-0.1
Ctfin<-45
repeat {
  append(k,pjy(Ct))->k
  Ct<-Ct+int
  if(Ct>Ctfin) break }
l<-seq(from=Cti,to=Ctfin-int,by=int)

#Summarising them in a graph
mytitle <- expression(paste(italic("Pneumocystis"), " PCR for bronchoaspiration"))
ggplot()+
  geom_step(aes(x=l,y=k))+
  theme_classic(base_size=10)+
  xlab("albumin PCR Cp")+
  ylab("Youden's index")+
  ggtitle(mytitle)

  pjsen<-function(Ct) {pj %>%
      filter(Matrix=="Produit d'aspiration bronchique" &
               Info_patient!="Prélèvement nasal") %>%
      mutate(IC=ifelse(CrossingPoint_G.x-CrossingPoint_PC.x>=3,"inh","ok"),
             albu28=ifelse(CrossingPoint_H.x>=Ct,"inh","ok")) %>%
      mutate(TP=ifelse(albu28=="inh" & IC=="inh",1,0),
             FP=ifelse(albu28=="inh" & IC=="ok",1,0),
             FN=ifelse(albu28=="ok" & IC=="inh",1,0),
             TN=ifelse(albu28=="ok" & IC=="ok",1,0)) %>% 
      dplyr::summarise(TP=sum(TP),
                       FP=sum(FP),
                       FN=sum(FN),
                       TN=sum(TN)) %>% 
      summarise(sen=TP/(TP+FN)) -> cval
    cval$sen
}

pjspe<-function(Ct) {pj %>%
    filter(Matrix=="Produit d'aspiration bronchique" &
             Info_patient!="Prélèvement nasal") %>%
    mutate(IC=ifelse(CrossingPoint_G.x-CrossingPoint_PC.x>=3,"inh","ok"),
           albu28=ifelse(CrossingPoint_H.x>=Ct,"inh","ok")) %>%
    mutate(TP=ifelse(albu28=="inh" & IC=="inh",1,0),
           FP=ifelse(albu28=="inh" & IC=="ok",1,0),
           FN=ifelse(albu28=="ok" & IC=="inh",1,0),
           TN=ifelse(albu28=="ok" & IC=="ok",1,0)) %>% 
    dplyr::summarise(TP=sum(TP),
                     FP=sum(FP),
                     FN=sum(FN),
                     TN=sum(TN)) %>% 
    summarise(spe=TN/(TN+FP)) -> cval
  cval$spe
  }

#Defining parameters for these functions and priming them
ksen<-c()
Ct<- 18
Cti<- 18
int<- 0.5
Ctfin<- 45

#Defining the corresponding Cp interval
l<-seq(from=Cti,to=Ctfin,by=int)

#Repeating sensitivity calculation for the defined Cp interval
repeat {
  append(ksen,pjsen(Ct))->ksen
  Ct<-Ct+int
  if(Ct>Ctfin) break }
#Inserting results in a tibble
tibble(l,ksen) %>%
  rename(value=ksen) %>%
  mutate(parameter="sensitivity") -> sen

#Repeating specificity calculation for the defined Cp interval
kspe<- c()
Ct<- 18
repeat {
  append(kspe,pjspe(Ct))->kspe
  Ct<-Ct+int
  if(Ct>Ctfin) break }

#Inserting results in a tibble
tibble(l,kspe) %>%
  rename(value=kspe) %>%
  mutate(parameter="specificity") -> spe

#Merging and ploting them
mytitle <- expression(paste(italic("Pneumocystis"), " PCR for bronchoaspiration"))
bind_rows(sen,spe) %>%
  ggplot()+
  geom_step(aes(x=l,y=value,col=parameter))+
  theme_classic(base_size=10)+
  xlab("albumin PCR Cp cut-off")+
  ylab("Sensitivity/Specificity")+
  ggtitle(mytitle)

```


###Comparison of efficiency of albumin PCR and inhibition control

We calculated undiluted extract PCR efficiency for albumin PCR and IC of controlled samples assuming
* efficiency of 1/10 diluted extract was equal to the average value of efficiency to the concerned PCR
* inter-run Cp variations du to several parameters could be neglected

We calculated it using the following formula for IC and albumin PCR respectively:

$$E_{undiluted}(IC) = exp\left(\frac{log(E^{Cp{diluted}})}{Cp_{undiluted}}\right)$$

$$E_{undiluted} (albumin) = exp\left(\frac{log(10*E^{Cp_{diluted}})}{Cp_{undiluted}}\right)$$

\
We did not calculated efficiency for samples:

* not controlled by 1/10 dilution
* fickly positive
* with negative Cp for IC  or albumin in a run

Calculation were performed on **`r pj %>%
  filter(!is.na(SampleName.y)&
           CrossingPoint_G.x<54 &
           CrossingPoint_G.y <54 &
           CrossingPoint_H.x<54 &
           CrossingPoint_H.y <54 &
           CrossingPoint_A.x>54 &
           CrossingPoint_B.x>54) %>% nrow()` samples**.

\
```{r eff_pj}
#Definition of PCR efficiency of 1/10 diluted PCR runs
Edilpj<- 1.93
Edilalb<- 1.94

#Giving a title for the graph
mytitle <- expression(paste(italic("Pneumocystis"), " PCR"))

#Selection of data, efficiency calculation and scatter-plot
pj %>%
  filter(!is.na(SampleName.y)&
           CrossingPoint_G.x<54 &
           CrossingPoint_G.y <54 &
           CrossingPoint_H.x<54 &
           CrossingPoint_H.y <54 &
           CrossingPoint_A.x>54 &
           CrossingPoint_B.x>54) %>%
  mutate(EpIC=exp(log(Edilpj^CrossingPoint_G.y)/CrossingPoint_G.x),
         Epalb=exp(log((Edilalb^CrossingPoint_H.y)/10)/CrossingPoint_H.x)) %>%
  ggplot()+
  geom_point(aes(x=EpIC,y=Epalb))+
  geom_segment(aes(y=1.7,yend=2.1,x=1.7,xend=2.1),linetype=2)+
  ggtitle(mytitle)+
  xlab("Amplification control PCR efficiency")+
  ylab("Albumin PCR efficiency")+
  coord_fixed(ratio=1,xlim=c(1.7,2.1),ylim=c(1.7,2.1))+
  theme_classic()

pj %>%
  filter(!is.na(SampleName.y)&
           CrossingPoint_G.x<54 &
           CrossingPoint_G.y <54 &
           CrossingPoint_H.x<54 &
           CrossingPoint_H.y <54 &
           CrossingPoint_A.x>54 &
           CrossingPoint_B.x>54) %>%
  mutate(EpIC=exp(log(Edilpj^CrossingPoint_G.y)/CrossingPoint_G.x),
         Epalb=exp(log((Edilalb^CrossingPoint_H.y)/10)/CrossingPoint_H.x),
         category=ifelse(CrossingPoint_G.x-CrossingPoint_PC.x>=3 &
                           CrossingPoint_H.x>=28, "both inh","other")) %>%
  transform(category=ifelse(CrossingPoint_G.x-CrossingPoint_PC.x>=3 &
                               CrossingPoint_H.x<28,"AC inh",category)) %>%
  transform(category=ifelse(CrossingPoint_G.x-CrossingPoint_PC.x<3 &
                              CrossingPoint_H.x>28,"alb>28",category)) %>%
  ggplot()+
  geom_point(aes(x=EpIC,y=Epalb,col=category))+
  geom_segment(aes(y=1.7,yend=2.1,x=1.7,xend=2.1),linetype=2)+
  ggtitle(mytitle)+
  xlab("Amplification control PCR efficiency")+
  ylab("Albumin PCR efficiency")+
  coord_fixed(ratio=1,xlim=c(1.7,2.1),ylim=c(1.7,2.1))+
  theme_classic()

```


\
  

*****************************************************************
\
  

#Global p values adjustement

To take into account test multiplication effect on p values, we performed Holm's corrections for the whole analysis of *Toxoplasma* PCR and *Pneumocystis* PCR:

```{r holm_global}
#Comparison of inhibited results for Toxoplasma PCR 
#Qualitative comparisons for Cp=36
toxo %>%
  mutate(IC=ifelse(CrossingPoint_F.x>38 & CrossingPoint_G.x>38,"inh","ok"),
         albu36=ifelse(CrossingPoint_H.x>=36,"inh","ok"))%>%
  mutate(class=ifelse(albu36=="inh" & IC=="inh","TP","other")) %>%
  transform(class=ifelse(albu36=="inh" & IC=="ok","FP",class)) %>%
  transform(class=ifelse(albu36=="ok" & IC=="inh","FN",class)) %>%
  transform(class=ifelse(albu36=="ok" & IC=="ok","TN",class)) %>%
  group_by(class) %>%
  dplyr::summarise(n=n())%>% 
  spread(class,n) -> cval

#Comparison of sensitivity of albumin PCR to a theorical value: 0.95
psentg36<-pval(stats::binom.test(x=cval$TP,n=cval$TP+cval$FN,
                               p=0.95,alternative="less"))

#Comparison of specificity of albumin PCR to a theorical value: 0.95
pspetg36<-pval(stats::binom.test(x=cval$TN,n=cval$TN+cval$FP,
                               p=0.95,alternative="less"))

#Qualitative comparisons for Cp=22
toxo %>%
  mutate(IC=ifelse(CrossingPoint_F.x>38 & CrossingPoint_G.x>38,"inh","ok"),
         albu36=ifelse(CrossingPoint_H.x>=22,"inh","ok"))%>%
  mutate(class=ifelse(albu36=="inh" & IC=="inh","TP","other")) %>%
  transform(class=ifelse(albu36=="inh" & IC=="ok","FP",class)) %>%
  transform(class=ifelse(albu36=="ok" & IC=="inh","FN",class)) %>%
  transform(class=ifelse(albu36=="ok" & IC=="ok","TN",class)) %>%
  group_by(class) %>%
  dplyr::summarise(n=n())%>% 
  spread(class,n) -> cval

#Comparison of sensitivity of albumin PCR to a theorical value: 0.95
psentg22<-pval(stats::binom.test(x=cval$TP,n=cval$TP+cval$FN,
                               p=0.95,alternative="less"))

#Comparison of specificity of albumin PCR to a theorical value: 0.95
pspetg22<-pval(stats::binom.test(x=cval$TN,n=cval$TN+cval$FP,
                               p=0.95,alternative="less"))

#Correlation leucocyte count albumin Cp
toxo2 %>%
  filter(CrossingPoint_H.x<55)-> toxo3
pspear<-pval(cor.test(x=toxo3$WBC,y=toxo3$CrossingPoint_H.x,alternative="less",method="spearman"))


#Comparison of inhibited results for Pneumocystis PCR
#Qualitative comparisons for Cp=22
pj %>%
  mutate(IC=ifelse(CrossingPoint_G.x-CrossingPoint_PC.x>=3,"inh","ok"),
         albu22=ifelse(CrossingPoint_H.x>=22,"inh","ok"))%>%
  mutate(class=ifelse(albu22=="inh" & IC=="inh","TP","other")) %>%
  transform(class=ifelse(albu22=="inh" & IC=="ok","FP",class)) %>%
  transform(class=ifelse(albu22=="ok" & IC=="inh","FN",class)) %>%
  transform(class=ifelse(albu22=="ok" & IC=="ok","TN",class)) %>%
  group_by(class) %>%
  dplyr::summarise(n=n())%>% 
  spread(class,n) -> cval

#Comparison of sensitivity of albumin PCR to a theorical value: 0.95
#Not necessary because no true positive
psenpj<-pval(stats::binom.test(x=0,n=0+cval$FN,
                             p=0.95,alternative="less"))

#Comparison of specificity of albumin PCR to a theorical value: 0.95
pspepj<-pval(stats::binom.test(x=cval$TN,n=cval$TN+cval$FP,
                             p=0.95,alternative="less"))

#Summary of results
p_value<-p.adjust(c(psentg36,pspetg36,psentg22,pspetg22,pspear,psenpj,pspepj),method="holm")
Tests<-c("Toxoplasma Cp 36 sensitivity", "Toxoplasma Cp 36 specificity",
         "Toxoplasma Cp 22 sensitivity", "Toxoplasma Cp 22 specificity",
         "leucocyte count albumin Cp correlation",
         "Pneumocystis Cp 22 sensitivity", "Pneumocystis Cp 22 specificity")
data_frame(Tests,p_value) %>% kable(digits=50)
```

\
  

#Global Euler diagram for fixed albumin CP threshold independent to matrix type

The aim of this Euler diagram is to represent the globality of samples and the proportions of truly or falsely inhibited in each PCR. We used eulerr and plotrix packages because more recent R packages did not permitted to construct proportionnate areas diagrams with more than 3 areas.

```{r euler_diagram}
#Calculation of number of samples in areas
#A= Toxoplasma PCR
#B= Pneumocystis PCR
#C= For Toxoplasma PCR, Cp(IC)>38 for both wells
#D= For Toxoplasma PCR, Cp(albumin)>38
#E= For Pneumocystis PCR,  Cp(IC)- CP(PC)>3
#No F to avoid confusion with false in R
#G= For Pneumocystis PCR, Cp(albumin)>28

A<-nrow(toxo)
B<-nrow(pj)
toxo %>%
  filter(CrossingPoint_F.x>38 &
           CrossingPoint_G.x>38) %>% 
  nrow() -> C
toxo %>%
  filter(CrossingPoint_H.x>=38) %>% 
  nrow() -> D

pj %>%
  filter(CrossingPoint_G.x-CrossingPoint_PC.x>=3) %>%
  nrow() -> E

pj %>%
  filter(CrossingPoint_H.x>=28) %>% 
  nrow() -> G


toxo %>%
  filter(Matrix=="Liquide de lavage bronchiolo-alvéolaire") %>%
  select(1,5,115,124,Num_travail) %>%
  mutate(ID=paste(IEP,"_",Date_sampling)) -> crossA
pj %>%
  filter(Matrix=="Liquide de lavage bronchiolo-alvéolaire") %>%
  select(1,3,55,64) %>%
  mutate(ID=paste(IEP,"_",Date_sampling)) -> crossB
inner_join(crossA,crossB,by="ID") %>% 
  select(Num_travail) %>%
  distinct() %>% nrow() -> AB

toxo %>%
  filter(CrossingPoint_F.x>38 &
           CrossingPoint_G.x>38 &
           CrossingPoint_H.x<38) %>% 
  nrow() -> AC

toxo %>%
  filter(CrossingPoint_F.x<38 |
           CrossingPoint_G.x<38) %>%
  filter(CrossingPoint_H.x>=38) %>% 
  nrow() -> AD

toxo %>%
  filter(CrossingPoint_F.x>38 &
           CrossingPoint_G.x>38 &
           CrossingPoint_H.x>=38) %>% 
  nrow() -> ACD

pj %>%
  filter(CrossingPoint_H.x<28 & 
           CrossingPoint_G.x-CrossingPoint_PC.x>=3) %>% 
  nrow() -> BE

pj %>%
  filter(CrossingPoint_H.x>=28 & 
           CrossingPoint_G.x-CrossingPoint_PC.x<3) %>% 
  nrow() -> BG

pj %>%
  filter(CrossingPoint_H.x>=28 & 
           CrossingPoint_G.x-CrossingPoint_PC.x>=3) %>% 
  nrow() -> BEG

fit <- euler(combinations=c("A" = A-AB-AC-AD-ACD, "B" = B-AB-BE-BG, "C" = 0,"D" = 0,"E" = 0,"G" = 0,
               "A&B" = AB, "A&C" = AC, "A&D" = AD,"A&C&D" = ACD,
               "B&E" = BE, "B&G" = BG))

cat("First version of Euler's diagram with areas and crossing areas proportional to number of samples")
plot(fit, labels = c("Toxoplasma PCR\n n=2225","Pneumocystis PCR\n n=964","2 IC > 38\n n=45","Alb>38\n n=12","IC-PC>3\n n=17","Alb>28\n n=30"), main = "Test")

cat("Empty version of Euler's diagram with areas and crossing areas proportional to number of samples")
plot(fit, labels = c(" "," "," "," "," "," "),fill = "white",fill_alpha = 0)

cat("Table of coordinates and radii of circles of Euler's diagram")
kable(coefficients(fit))

#Modified coordinate values of circles obtained by correction in Excel for a better display
absc<-c(0,40.66321076,0,0,40.66321076,40.66321076)
ord<-c(0,0,2.02079896,-2.02079896,6.5,-6.5)
rad<-c(26.612769,17.517155,3.784699,2.459245,2.326213,3.090194)
```

```{r euler_excel,eval=F}
#Drawing an empty Euler diagram in order to easily add labels and caption in powerpoint
cat("Empty version of Euler's diagram after alignment of circle by correction of coordinate in Excel")
plot(seq(-50,70,length=70),seq(-50,70,length=70),type="n",xlab="",ylab="",main="Test draw.circle")
draw.circle(absc[1],ord[1],rad[1],border="black",lty=1,lwd=1)
draw.circle(absc[2],ord[2],rad[2],border="black",lty=1,lwd=1)
draw.circle(absc[3],ord[3],rad[3],border="black",lty=1,lwd=1)
draw.circle(absc[4],ord[4],rad[4],border="black",lty=1,lwd=1)
draw.circle(absc[5],ord[5],rad[5],border="black",lty=1,lwd=1)
draw.circle(absc[6],ord[6],rad[6],border="black",lty=1,lwd=1)

#For more flexibility, we modified the empty Euler's diagram as a picture in PowerPoint. #Nevertheless, with this process, the areas and crossing areas were proportionnal to #numbers of analyzed samples.

```


# Global Venn diagram for albumin Cp threshold adapted to matrix type

We could not perform A Euler diagram for geometrical constraints, so we presented here the data necessary
to construct a Venn diagram instead.


## Values for *Toxoplasma* PCR only

```{r venn_tg_table}

#Selection of non blood samples and classification as paucicellular or not 
# Five BAL were known to be paucicellular because they were extracted by TNN
toxo %>%
  mutate (pauci=ifelse
          (Matrix %in% c("Liquide amniotique",
                         "Liquide céphalo-rachidien (LCR)",
                         "Humeur aqueuse")|
              Info_patient %in% c("Liquide d'ascite",
                                  "Liquide péricardique",
                                  "Liquide pleural")|
              Num_travail %in% c(99163222723,99162523175,
                                 99162503057,99161381971,99160961446)| 
              SampleName.x=="153 0868 HA",1,0),
          bld=ifelse(Matrix=="Sang veineux" & Info_patient=="N/A",1,0))%>% 
  filter(bld==0) %>% select(-bld) ->  tg_oth

#Selection of blood samples and classification as paucicellular or not
#Blood samples with associated full blood count
#Loading full blood counts
fbctox<-read.csv(file="E:/inhib/data R/toxo_FBC_DxLab_R.csv",sep=";",header=T,dec=".")

#Creating a column for merging dataframes
fbctox %>%
  transform(DOB=dmy(DOB),
            Date_sampling=dmy_hm(Date_sampling)) %>%
  mutate(ID=paste(IEP,Date_sampling,sep="_")) %>%
  transform(ID=str_sub(ID,1,21),
            WBC=as.numeric(as.character(WBC))) %>%
  distinct(ID,.keep_all=T)-> fbctox2

#Blood samples with full blood count automatically associated  and merging dataframes
toxo %>%
  mutate(ID=paste(IEP,Date_sampling,sep="_")) %>%
  transform(ID=str_sub(ID,1,21)) %>%
  filter(Matrix=="Sang veineux" & Info_patient=="N/A") %>%
  left_join(fbctox2,by="ID") %>%
  filter(!is.na(WBC)) %>%
  transform(WBC=as.numeric(WBC)) %>%
  mutate(pauci=ifelse(WBC<3,1,0)) %>%
  select(1:139,155) -> tg_fbc

#Blood samples without WBC
#Loading classification as paucicellular or not
cyt_man<-read.csv(file="E:/inhib/PCR toxo sans cytologies associees (1).csv",sep=";",header=T,dec=".")

#Selection, merging and classification as paucicellular
toxo %>%
  mutate(ID=paste(IEP,Date_sampling,sep="_")) %>%
  transform(ID=str_sub(ID,1,21)) %>%
  filter(Matrix=="Sang veineux" & 
           Info_patient=="N/A" &
           SampleName.x!="153 0868 HA") %>% 
  left_join(fbctox2,by="ID") %>% 
  filter(is.na(WBC) ) %>%
  left_join(cyt_man,by="Num_demande.x") %>%
  mutate(pauci=ifelse(cyto %in% c("pauci","aplasie"),1,0)) %>%
  select(1:139,166) %>%
    rename(Matrix=Matrix.x)-> tg_bld

#Merging into one dataframe
bind_rows(tg_oth,tg_fbc,tg_bld) -> toxo_p


# Calculation of inhibited samples in function of threshold depending of matrix
# for samples analyzed only in Toxoplasma PCR


#Definition of albumin Cp threhold per matrix type and cellularity for Toxoplasma PCR
th_misc <- 28.4
th_AF <- 29.3
th_CSF <- 34.9
th_BAL <- 29.9
th_plac <- 21.7
th_cord <- 23.8
th_AH <- 33.6
th_bld <- 23.1
th_pbld <- 27.6

#Only 4 BAL were not simultaneously analyzed in Pneumocystis PCR
toxo_p %>%
  mutate(orph_bal=ifelse(Num_travail %in% c(99162523175,
                                            99162503057,
                                            99161381971,99160961446),1,0),
         all_bal=ifelse(str_detect(Matrix,"alvéolaire"),1,0)) %>%
  filter(orph_bal+all_bal==2 | orph_bal+all_bal==0) %>%
  mutate(IC=ifelse(CrossingPoint_F.x >38 &
                    CrossingPoint_G.x >38, "inh","N" ),
         misc=ifelse(str_detect(Matrix,"Fragment")|
           str_detect(Info_patient,"ascite"),1,0),
         AF=ifelse(str_detect(Matrix,"Liquide amniotique"),1,0),
         CSF=ifelse(str_detect(Matrix,"LCR")|
                      str_detect(Info_patient,"LCR"),1,0),
         BAL=ifelse(str_detect(Matrix,"bronchiolo-alvéolaire"),1,0),
         plac=ifelse(str_detect(Matrix,"Placenta"),1,0),
         cord=ifelse(str_detect(Matrix,"cordon"),1,0),
         AH=ifelse(str_detect(Matrix,"Humeur aqueuse") &
                     Info_patient!="Liquide céphalo-rachidien (LCR)"|
                     SampleName.x== "153 0868 HA",1,0),
         bld=ifelse(str_detect(Matrix,"Sang veineux")&
                      Info_patient %in% c("N/A","Humeur aqueuse") &
                      SampleName.x!= "153 0868 HA" &
                      pauci==0,1,0),
         pbld=ifelse(str_detect(Matrix,"Sang veineux")&
                      Info_patient %in% c("N/A","Humeur aqueuse") &
                      SampleName.x!= "153 0868 HA" &
                      pauci==1,1,0)) %>% 
  mutate(imisc=ifelse(misc==1 & CrossingPoint_H.x >th_misc,1,0),
         iAF=ifelse(AF==1 & CrossingPoint_H.x >th_AF,1,0),
         iCSF=ifelse(CSF==1 & CrossingPoint_H.x >th_CSF,1,0),
         iBAL=ifelse(BAL==1 & CrossingPoint_H.x >th_BAL,1,0),
         iplac=ifelse(plac==1 & CrossingPoint_H.x >th_plac,1,0),
         icord=ifelse(cord==1 & CrossingPoint_H.x >th_cord,1,0),
         iAH=ifelse(AH==1 & CrossingPoint_H.x >th_AH,1,0),
         ibld=ifelse(bld==1 & CrossingPoint_H.x >th_bld,1,0),
         ipbld=ifelse(pbld==1 & CrossingPoint_H.x >th_pbld,1,0),
         nmisc=ifelse(misc==1 & CrossingPoint_H.x <=th_misc,1,0),
         nAF=ifelse(AF==1 & CrossingPoint_H.x <=th_AF,1,0),
         nCSF=ifelse(CSF==1 & CrossingPoint_H.x <=th_CSF,1,0),
         nBAL=ifelse(BAL==1 & CrossingPoint_H.x <=th_BAL,1,0),
         nplac=ifelse(plac==1 & CrossingPoint_H.x <=th_plac,1,0),
         ncord=ifelse(cord==1 & CrossingPoint_H.x <=th_cord,1,0),
         nAH=ifelse(AH==1 & CrossingPoint_H.x <=th_AH,1,0),
         nbld=ifelse(bld==1 & CrossingPoint_H.x <=th_bld,1,0),
         npbld=ifelse(pbld==1 & CrossingPoint_H.x <=th_pbld,1,0))-> int
int %>%
  group_by(IC) %>%
  summarise(Matrix_type= "miscellaneous",
              N_alb_inh=sum(imisc),
              N_alb_N=sum(nmisc),
            alb_Cp_Thr=th_misc) -> t01
int %>%
  group_by(IC) %>%
  summarise(Matrix_type= "AF",
            N_alb_inh=sum(iAF),
            N_alb_N=sum(nAF),
            alb_Cp_Thr=th_AF) -> t02
bind_rows(t01,t02) -> t01
int %>%
  group_by(IC) %>%
  summarise(Matrix_type= "CSF",
            N_alb_inh=sum(iCSF),
            N_alb_N=sum(nCSF),
            alb_Cp_Thr=th_CSF) -> t02
bind_rows(t01,t02) -> t01
int %>%
  group_by(IC) %>%
  summarise(Matrix_type= "BAL",
            N_alb_inh=sum(iBAL),
            N_alb_N=sum(nBAL),
            alb_Cp_Thr=th_BAL) -> t02
bind_rows(t01,t02) -> t01       
int %>%
  group_by(IC) %>%
  summarise(Matrix_type= "placenta",
            N_alb_inh=sum(iplac),
            N_alb_N=sum(nplac),
            alb_Cp_Thr=th_plac) -> t02
bind_rows(t01,t02) -> t01
int %>%
  group_by(IC) %>%
  summarise(Matrix_type= "cord blood",
            N_alb_inh=sum(icord),
            N_alb_N=sum(ncord),
            alb_Cp_Thr=th_cord) -> t02
bind_rows(t01,t02) -> t01
int %>%
  group_by(IC) %>%
  summarise(Matrix_type= "aqueous humor",
            N_alb_inh=sum(iAH),
            N_alb_N=sum(nAH),
            alb_Cp_Thr=th_AH) -> t02
bind_rows(t01,t02) -> t01
int %>%
  group_by(IC) %>%
  summarise(Matrix_type= "non paucicellular blood",
            N_alb_inh=sum(ibld),
            N_alb_N=sum(nbld),
            alb_Cp_Thr=th_bld) -> t02
bind_rows(t01,t02) -> t01
int %>%
  group_by(IC) %>%
  summarise(Matrix_type= "paucicellular blood",
            N_alb_inh=sum(ipbld),
            N_alb_N=sum(npbld),
            alb_Cp_Thr=th_pbld) -> t02
bind_rows(t01,t02) -> t01
int %>%
  filter(str_detect(Info_patient,"ganglionnaire")|
           str_detect(Info_patient,"adénopathie")) %>%
  mutate(alb_inh=ifelse(CrossingPoint_H.x>th_misc,1,0)) %>%
  group_by(IC) %>%
  summarise(Matrix_type= "lymph node",
            N_alb_inh=sum(alb_inh),
            N_alb_N=n()-sum(alb_inh),
            alb_Cp_Thr=th_misc) -> t02
bind_rows(t01,t02) -> t01
int %>%
  filter(str_detect(Info_patient,"rétinienne")) %>%
  mutate(alb_inh=ifelse(CrossingPoint_H.x>th_misc,1,0)) %>%
  group_by(IC) %>%
  summarise(Matrix_type= "retina",
            N_alb_inh=sum(alb_inh),
            N_alb_N=n()-sum(alb_inh),
            alb_Cp_Thr=th_misc) -> t02
bind_rows(t01,t02) -> t01
int %>%
  filter(str_detect(Info_patient,"cérébra")) %>%
  mutate(alb_inh=ifelse(CrossingPoint_H.x>th_misc,1,0)) %>%
  group_by(IC) %>%
  summarise(Matrix_type= "cerebral biopsy",
            N_alb_inh=sum(alb_inh),
            N_alb_N=n()-sum(alb_inh),
            alb_Cp_Thr=th_misc) -> t02
bind_rows(t01,t02) -> t01
int %>%
  filter(str_detect(Info_patient,"hépatique")) %>%
  mutate(alb_inh=ifelse(CrossingPoint_H.x>th_misc,1,0)) %>%
  group_by(IC) %>%
  summarise(Matrix_type= "liver biosy",
            N_alb_inh=sum(alb_inh),
            N_alb_N=n()-sum(alb_inh),
            alb_Cp_Thr=th_misc) -> t02
bind_rows(t01,t02) -> t01
int %>%
  filter(str_detect(Info_patient,"péricardique")) %>%
  mutate(alb_inh=ifelse(CrossingPoint_H.x>th_misc,1,0)) %>%
  group_by(IC) %>%
  summarise(Matrix_type= "heart biopsy",
            N_alb_inh=sum(alb_inh),
            N_alb_N=n()-sum(alb_inh),
            alb_Cp_Thr=th_misc) -> t02
bind_rows(t01,t02) -> t01
int %>%
  filter(str_detect(Info_patient,"pleural")) %>%
  mutate(alb_inh=ifelse(CrossingPoint_H.x>th_misc,1,0)) %>%
  group_by(IC) %>%
  summarise(Matrix_type= "pleural",
            N_alb_inh=sum(alb_inh),
            N_alb_N=n()-sum(alb_inh),
            alb_Cp_Thr=th_misc) -> t02
bind_rows(t01,t02) -> t01
int %>%
  filter(str_detect(Info_patient,"Moelle osseuse")) %>%
  mutate(alb_inh=ifelse(CrossingPoint_H.x>th_misc,1,0)) %>%
group_by(IC) %>%
  summarise(Matrix_type= "bone marrow",
            N_alb_inh=sum(alb_inh),
            N_alb_N=n()-sum(alb_inh),
            alb_Cp_Thr=th_misc) -> t02
bind_rows(t01,t02) -> t01
int %>%
  filter(str_detect(Info_patient,"ascite")) %>%
  mutate(alb_inh=ifelse(CrossingPoint_H.x>th_misc,1,0)) %>%
  group_by(IC) %>%
  summarise(Matrix_type= "ascite",
            N_alb_inh=sum(alb_inh),
            N_alb_N=n()-sum(alb_inh),
            alb_Cp_Thr=th_misc) -> t02
bind_rows(t01,t02) -> t01
t01 %>%
  group_by(IC) %>%
  summarise(Matrix_type="Total",
            N_alb_inh=sum(N_alb_inh),
            N_alb_N=sum(N_alb_N),
            alb_Cp_Thr=0) -> t02
bind_rows(t01,t02) %>% kable(digits=1)

```



## Values for *Pneumocystis* PCR
We merged the nasal swab to the BAL matrix class and used the corresponding threshold.
Thresholds were defined by mean albumin PCR Cp value per matrix excluding Cp > 45 plus 3.

```{r venn_pj_table}
#Definition of Cp albumin threshold per matrix class
th_BAL <- 24.7
th_bro <- 22.1
th_spu <- 23.9

#Selection of the list of shared BAL between Tg and Pj PCR in order to exclude them
toxo %>% filter(str_detect(Matrix,"bronchiolo-alvéolaire")) %>%
  mutate(shared=1) %>%
  select(Num_travail,shared) ->tbal


left_join(pj,tbal) %>% 
  filter(is.na(shared)) %>%
  mutate(IC=ifelse(CrossingPoint_G.x - CrossingPoint_PC.x >3,"inh","N"),
         BAL=ifelse(str_detect(Matrix,"bronchiolo-alvéolaire") |
                    str_detect(Info_patient,"nasal"),1,0),
         broncho=ifelse(str_detect(Matrix,"aspiration") & 
                          Info_patient!="Prélèvement nasal",1,0),
         sputum=ifelse(str_detect(Matrix,"expectoration"),1,0)) %>%
  mutate(iBAL=ifelse(BAL==1 & CrossingPoint_H.x >th_BAL,1,0),
         ibro=ifelse(broncho==1 & CrossingPoint_H.x >th_bro,1,0),
         ispu=ifelse(sputum==1 & CrossingPoint_H.x >th_spu,1,0),
         nBAL=ifelse(BAL==1 & CrossingPoint_H.x <=th_BAL,1,0),
         nbro=ifelse(broncho==1 & CrossingPoint_H.x <=th_bro,1,0),
         nspu=ifelse(sputum==1 & CrossingPoint_H.x <=th_spu,1,0)) ->int

int %>%
    group_by(IC) %>%
           summarise(Matrix_type= "BAL",
                     N_alb_inh=sum(iBAL),
                     N_alb_N=sum(nBAL),
                     alb_Cp_Thr=th_BAL) -> t01
int %>%
    group_by(IC) %>%
           summarise(Matrix_type= "bronchoaspiration",
                     N_alb_inh=sum(ibro),
                     N_alb_N=sum(nbro),
                     alb_Cp_Thr=th_bro) -> t02
         bind_rows(t01,t02) -> t01
int %>%
           group_by(IC) %>%
           summarise(Matrix_type= "sputum",
                     N_alb_inh=sum(ispu),
                     N_alb_N=sum(nspu),
                     alb_Cp_Thr=th_spu) -> t02
         bind_rows(t01,t02) -> t01
t01 %>%
           group_by(IC) %>%
           summarise(Matrix_type="Total",
                     N_alb_inh=sum(N_alb_inh),
                     N_alb_N=sum(N_alb_N),
                     alb_Cp_Thr=0) -> t02
         bind_rows(t01,t02) %>% kable(digits=1)

```



## Values for intersected samples

```{r venn_inter_table}
#Pneumocystis PCR concerning samples analyzed in both PCR
th_BAL <- 24.7
toxo %>% filter(str_detect(Matrix,"bronchiolo-alvéolaire")) %>%
  mutate(shared=1) %>%
  select(Num_travail,shared) ->tbal


left_join(pj,tbal) %>% 
  filter(!is.na(shared)) %>%
  mutate(IC=ifelse(CrossingPoint_G.x - CrossingPoint_PC.x >3,"inh","N"),
         BAL=ifelse(str_detect(Matrix,"bronchiolo-alvéolaire") |
                    str_detect(Info_patient,"nasal"),1,0)) %>%
  mutate(iBAL=ifelse(BAL==1 & CrossingPoint_H.x >th_BAL,1,0),
         nBAL=ifelse(BAL==1 & CrossingPoint_H.x <=th_BAL,1,0)) %>%
    group_by(IC) %>%
           summarise(Matrix_type= "BAL for Pj",
                     N_alb_inh=sum(iBAL),
                     N_alb_N=sum(nBAL),
                     alb_Cp_Thr=th_BAL) %>% kable(digits=2)


left_join(pj,tbal) %>%
  filter(!is.na(shared)) %>%
  mutate(IC=ifelse(CrossingPoint_G.x - CrossingPoint_PC.x >3,"inh","N"),
         BAL=ifelse(str_detect(Matrix,"bronchiolo-alvéolaire") |
                      str_detect(Info_patient,"nasal"),1,0)) %>%
  filter(BAL==1 & CrossingPoint_H.x >th_BAL) %>%
  select(Num_travail,Matrix,CrossingPoint_G.x
         ,CrossingPoint_PC.x,CrossingPoint_H.x) %>%
  rename(IC_Cp=CrossingPoint_G.x,PC_Cp=CrossingPoint_PC.x,
         alb_Cp=CrossingPoint_H.x) %>% kable(digits=2)

#Toxoplasma PCR concerning samples analyzed in both PCR
th_BAL <- 29.9

toxo %>%
  mutate(orph_bal=ifelse(Num_travail %in% c(99162523175,99162503057,
                                            99161381971,99160961446),1,0)) %>%
  filter(orph_bal==0 & str_detect(Matrix,"bronchiolo-alvéolaire")) %>%
  mutate(IC=ifelse(CrossingPoint_F.x >38 & CrossingPoint_G.x >38,"inh","N"),
         iBAL=ifelse(CrossingPoint_H.x >th_BAL,1,0),
         nBAL=ifelse(CrossingPoint_H.x <=th_BAL,1,0)) %>%
  group_by(IC) %>%
  summarise(Matrix_type= "BAL for Toxo",
            N_alb_inh=sum(iBAL),
            N_alb_N=sum(nBAL),
            alb_Cp_Thr=th_BAL) %>% kable(digits=2)

toxo %>%
  mutate(orph_bal=ifelse(Num_travail %in% c(99162523175,99162503057,
                                            99161381971,99160961446),1,0)) %>%
  filter(orph_bal==0 & str_detect(Matrix,"bronchiolo-alvéolaire")) %>%
  mutate(IC=ifelse(CrossingPoint_F.x >38 & CrossingPoint_G.x >38,"inh","N"),
         iBAL=ifelse(CrossingPoint_H.x >th_BAL,1,0),
         nBAL=ifelse(CrossingPoint_H.x <=th_BAL,1,0)) %>%
  filter(CrossingPoint_H.x >th_BAL) %>%
  select(Num_travail,Matrix,CrossingPoint_G.x,CrossingPoint_H.x) %>%
  rename(IC_Cp=CrossingPoint_G.x,
         alb_Cp=CrossingPoint_H.x) %>% kable(digits=2)

beep(4)

```




